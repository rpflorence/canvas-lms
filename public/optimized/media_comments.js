define(["INST","i18n","jquery","str/htmlEscape","jquery.ajaxJSON","jquery.instructure_jquery_patches","jquery.instructure_misc_helpers","jquery.instructure_misc_plugins","jqueryui/progressbar","jqueryui/tabs"],function(a,b,c,d){b=b.scoped("media_comments"),function(a,c){var e=null;try{e=swfobject.getFlashPlayerVersion().major+"."+swfobject.getFlashPlayerVersion().minor,e=" (you have "+e+" installed)"}catch(f){}var g="<div>"+d(b.t("messages.flash_required","This video requires Flash version 9 or higher (you have %{version} installed).",{version:e}))+"<br/><a target='_blank' href='http://get.adobe.com/flashplayer/'>"+d(b.t("links.upgrade_flash","Click here to upgrade"))+"</a></div>";a.fn.mediaComment=function(d,e,f,h,i,j){var k=e,l=f,m=h;if(!c.kalturaSettings){console.log("Kaltura has not been enabled for this account");return}if(d=="create"){l=e;var n=f,o=h,p=i,q=j;a("#media_recorder_container").removeAttr("id").addClass("old_recorder_container"),this.attr("id","media_recorder_container").removeClass("old_recorder_container"),this.unbind("media_comment_created");var r=this;this.bind("media_comment_created",function(a,b){n.call(this,b.id,b.mediaType)}),a.mediaComment.init(l,{modal:p,close:function(){o&&a.isFunction(o)&&o.call(r)},defaultTitle:q})}else if(d=="show_inline"){var s=a("<span/>");l!="video"&&l!="audio"&&(a(this).hasClass("audio_playback")?l="audio":l="video"),s.attr("id","media_comment_holder_"+Math.round(Math.random()*1e4));var t=a(this);a(this).parent(".instructure_file_link_holder").length>0&&(t=a(this).parent(".instructure_file_link_holder"));var u=function(a){t.append(s);var b=t.width(),c={},d={allowScriptAccess:"always",allowNetworking:"all",allowFullScreen:!0,bgcolor:"#000000",wmode:"opaque"},e="/media_objects/"+a+"/redirect",b=Math.min(t.closest("div,p,table").width()||550,550),f=b/550*448;l=="audio"&&(f=125,b=Math.min(b,350)),swfobject.embedSWF(e,s.attr("id"),b.toString(),f.toString(),"9.0.0",!1,c,d)};if(k=="maybe"){var v=m.replace(/\/download.*/,"");t.text("Loading..."),a.ajaxJSON(v,"GET",{},function(a){a.attachment&&a.attachment.media_entry_id&&a.attachment.media_entry_id!="maybe"?(t.text(""),u(a.attachment.media_entry_id)):t.text(b.t("messages.file_failed_to_load","This media file failed to load"))},function(){t.text(b.t("messages.file_failed_to_load","This media file failed to load"))})}else u(k)}else if(d=="show"){var w={},x={allowScriptAccess:"always",allowNetworking:"all",allowFullScreen:!0,bgcolor:"#000000",wmode:"opaque"},y="/media_objects/"+k+"/redirect",z=a("#media_comment_player_dialog");z.length||(z=a("<div id='media_comment_player_dialog'/>").appendTo("body")),z.dialog("close").dialog({autoOpen:!1,title:b.t("titles.play_comment","Play Media Comment"),width:575,height:493,modal:!0,draggable:!1}).dialog("open").empty().css({padding:0,overflow:"hidden"}).append(a('<div id="media_comment_play" />').html(g)),swfobject.embedSWF(y,"media_comment_play","100%","100%","9.0.0",!1,w,x)}return this};var h=[],i=!1,j=function(){i=!0;for(var a=0;a<30;a++){var b=h.shift();if(b){var c=b.elem,d=b.size;c.createMediaCommentThumbnail(b)}}h.length>0?setTimeout(j,500):i=!1};a.fn.mediaCommentThumbnail=function(b,c){return a(this).each(function(){h.push({size:b,elem:a(this),keepOriginalText:c})}),i||(i=!0,setTimeout(j,500)),this},a.fn.createMediaCommentThumbnail=function(d){if(!c.kalturaSettings){console.log("Kaltura has not been enabled for this account");return}var e=d.size||"normal",f=d.only_show_icon,g=d.keepOriginalText,h=a.fn.mediaCommentThumbnail.sizes[e]||a.fn.mediaCommentThumbnail.sizes.normal;return this.each(function(){var d=a.trim(a(this).find(".media_comment_id:first").text());!d&&a(this).attr("id")&&a(this).attr("id").match(/^media_comment_/)&&(d=a(this).attr("id").substring(14)),d=d||a.trim(a(this).parent().find(".media_comment_id:first").text());if(d){var i="http://"+c.kalturaSettings.resource_domain;location.protocol==="https:"&&(i="https://"+(c.kalturaSettings.secure_resource_domain||c.kalturaSettings.domain)),i=i+"/p/"+c.kalturaSettings.partner_id+"/thumbnail/entry_id/",i+=d,i=i+"/width/"+h.width+"/height/"+h.height+"/bgcolor/000000/type/2/vid_sec/5";var j=a("<img/>");j.addClass("media_comment_thumbnail"),j.addClass("media_comment_thumbnail-"+e),f?j.attr("src","/images/media_comment.png"):(j.attr("src","/images/blank.png"),a(this).addClass("no-hover").addClass("no-underline"),j.hover(function(){j.attr("src","/images/play_overlay.png")},function(){j.attr("src","/images/blank.png")})),j.css("backgroundImage","url("+i+")"),j.attr("title",b.t("titles.click_to_view","Click to View"));var k=a(this);if(!g)a(this).empty();else{var k=a(this).clone().empty().removeClass("instructure_file_link");a(this).parent(".instructure_file_link_holder").length>0?a(this).parent(".instructure_file_link_holder").append(k):a(this).after(k)}k.addClass("instructure_inline_media_comment"),k.append(j).css({backgroundImage:"",padding:0}),a(this).append("<span class='media_comment_id' style='display: none;'>"+d+"</span>")}}),this},a.fn.mediaCommentThumbnail.sizes={normal:{width:140,height:100},small:{width:70,height:50}},a.mediaComment=function(b,c,d){var e=a("<div/>");a("body").append(e.hide()),a.fn.mediaComment.apply(e,arguments)},a.mediaComment.partnerData=function(b){return b=b||{},b.context_code=a.mediaComment.contextCode(),b.root_account_id=parseInt(a("#domain_root_account_id").text(),10)||0,JSON.stringify(b)},a.mediaComment.contextCode=function(){var b="";try{b=a.trim(a("#current_context_code").text())||a.trim("user_"+a("#identity .user_id").text())}catch(c){}return b};var k={};a.mediaComment.entryAdded=function(b,c,d,e){if(!b||k[b])return;k[b]=!0;var f={mediaType:c,entryId:b,title:d,userTitle:e},g=a.mediaComment.contextCode();if(f.mediaType==1||f.mediaType==2||f.mediaType==5||!0){var h="video";f.mediaType==2?h="image":f.mediaType==5&&(h="audio"),g&&a.ajaxJSON("/media_objects","POST",{id:f.entryId,type:h,context_code:g,title:f.title,user_entered_title:f.userTitle},function(b){a(document).triggerHandler("media_object_created",b)},function(a){}),a("#media_recorder_container").triggerHandler("media_comment_created",{id:f.entryId,mediaType:h})}},a.mediaComment.audio_delegate={readyHandler:function(){a("#audio_upload")[0].setMediaType("audio")},selectHandler:function(){a.mediaComment.upload_delegate.selectHandler("audio")},singleUploadCompleteHandler:function(b){a.mediaComment.upload_delegate.singleUploadCompleteHandler("audio",b)},allUploadsCompleteHandler:function(){a.mediaComment.upload_delegate.allUploadsCompleteHandler("audio")},entriesAddedHandler:function(b){a.mediaComment.upload_delegate.entriesAddedHandler("audio",b)},progressHandler:function(b){a.mediaComment.upload_delegate.progressHandler("audio",b[0],b[1],b[2])},uploadErrorHandler:function(){a.mediaComment.upload_delegate.uploadErrorHandler("audio")}},a.mediaComment.video_delegate={readyHandler:function(){a("#video_upload")[0].setMediaType("video")},selectHandler:function(){a.mediaComment.upload_delegate.selectHandler("video")},singleUploadCompleteHandler:function(b){a.mediaComment.upload_delegate.singleUploadCompleteHandler("video",b)},allUploadsCompleteHandler:function(){a.mediaComment.upload_delegate.allUploadsCompleteHandler("video")},entriesAddedHandler:function(b){a.mediaComment.upload_delegate.entriesAddedHandler("video",b)},progressHandler:function(b){a.mediaComment.upload_delegate.progressHandler("video",b[0],b[1],b[2])},uploadErrorHandler:function(){a.mediaComment.upload_delegate.uploadErrorHandler("video")}},a.mediaComment.upload_delegate={currentType:"audio",submit:function(){var c=a.mediaComment.upload_delegate.currentType,d=a("#"+c+"_upload")[0].getFiles();d.length>1&&a("#"+c+"_upload")[0].removeFiles(0,d.length-2),d=a("#"+c+"_upload")[0].getFiles();if(d.length==0)return;a("#media_upload_progress").css("visibility","visible").progressbar({value:1}),a("#media_upload_submit").attr("disabled",!0).text(b.t("messages.submitting","Submitting Media File...")),a("#"+c+"_upload")[0].upload()},selectHandler:function(d){a.mediaComment.upload_delegate.currentType=d;var e=a("#"+d+"_upload")[0].getFiles();e.length>1&&a("#"+d+"_upload")[0].removeFiles(0,e.length-2);var f=a("#"+d+"_upload")[0].getFiles()[0];a("#media_upload_settings .icon").attr("src","/images/file-"+d+".png"),a("#media_upload_submit").show(),a("#media_upload_submit").attr("disabled",f?!1:!0),a("#media_upload_settings").css("visibility",f?"visible":"hidden"),a("#media_upload_title").val(f.title),a("#media_upload_display_title").text(f.title),a("#media_upload_file_size").text(a.fileSize(f.bytesTotal)),a("#media_upload_feedback_text").html(""),a("#media_upload_feedback").css("visibility","hidden");if(f.bytesTotal>c.kalturaSettings.max_file_size_bytes){a("#media_upload_feedback_text").html(b.t("errors.file_too_large","*This file is too large.* The maximum size is %{size}MB.",{size:c.kalturaSettings.max_file_size_bytes/1048576,wrapper:"<b>$1</b>"})),a("#media_upload_feedback").css("visibility","visible"),a("#media_upload_submit").hide();return}a("#media_upload_submit").click()},singleUploadCompleteHandler:function(b,c){a("#media_upload_progress").progressbar("option","value",100)},allUploadsCompleteHandler:function(b){a("#media_upload_progress").progressbar("option","value",100),a("#"+b+"_upload")[0].addEntries()},entriesAddedHandler:function(c,d){a("#media_upload_progress").progressbar("option","value",100);var e=d[0];a("#media_upload_submit").text(b.t("messages.submitted","Submitted Media File!")),setTimeout(function(){a("#media_comment_dialog").dialog("close")},1500),c=="audio"?e.entryType=5:c=="video"&&(e.entryType=1),a.mediaComment.entryAdded(e.entryId,e.entryType,e.title)},progressHandler:function(b,c,d,e){var f=100*c/d;a("#media_upload_progress").progressbar("option","value",f)},uploadErrorHandler:function(c){var d=a("#"+c+"_upload")[0].getError();a("#media_upload_errors").text(b.t("errors.upload_failed","Upload failed with error:")+" "+d),a("#media_upload_progress").hide()}};var l=!1,m=null;a.mediaComment.init=function(d,e){m=m||new Date,d=d||"any",e=e||{};var f=a.trim(a("#identity .user_name").text()||"");f&&(f=f+": "+(new Date).toString("ddd MMM d, yyyy"));var g=e.defaultTitle||f||b.t("titles.media_contribution","Media Contribution"),h=function(){a("#video_record_title,#audio_record_title").val(g),j.dialog("close").dialog({autoOpen:!1,title:b.t("titles.record_upload_media_comment","Record/Upload Media Comment"),width:560,height:460,modal:e.modal==0?!1:!0}).dialog("open"),j.dialog("option","close",function(){a("#audio_record").before("<div id='audio_record'/>").remove(),a("#video_record").before("<div id='video_record'/>").remove(),e&&e.close&&a.isFunction(e.close)&&e.close.call(j)}),a("#audio_record").before("<div id='audio_record'/>").remove(),a("#video_record").before("<div id='video_record'/>").remove();var f=j.data("ks");d=="video"?(a("#video_record_option").click(),a("#media_record_option_holder").hide(),a("#audio_upload_holder").hide(),a("#video_upload_holder").show()):d=="audio"?(a("#audio_record_option").click(),a("#media_record_option_holder").hide(),a("#audio_upload_holder").show(),a("#video_upload_holder").hide()):(a("#video_record_option").click(),a("#audio_upload_holder").show(),a("#video_upload_holder").show()),a(document).triggerHandler("reset_media_comment_forms");var h=a.trim(a("#identity .user_name").text())+" "+(new Date).toISOString();setTimeout(function(){var d={host:location.protocol+"//"+c.kalturaSettings.domain,rtmpHost:"rtmp://"+(c.kalturaSettings.rtmp_domain||c.kalturaSettings.domain),kshowId:"-1",pid:c.kalturaSettings.partner_id,subpid:c.kalturaSettings.subpartner_id,uid:j.data("uid")||"ANONYMOUS",ks:f,themeUrl:"/media_record/skin.swf",localeUrl:"/media_record/locale.xml",thumbOffset:"1",licenseType:"CC-0.1",showUi:"true",useCamera:"0",maxFileSize:c.kalturaSettings.max_file_size_bytes/1048576,maxUploads:1,partnerData:a.mediaComment.partnerData(),partner_data:a.mediaComment.partnerData(),entryName:h},e={align:"middle",quality:"high",bgcolor:"#ffffff",name:"KRecordAudio",allowScriptAccess:"sameDomain",type:"application/x-shockwave-flash",pluginspage:"http://www.adobe.com/go/getflashplayer",wmode:"opaque"};a("#audio_record").text(b.t("messages.flash_required_record_audio","Flash required for recording audio.")),swfobject.embedSWF("/media_record/KRecord.swf","audio_record","400","300","9.0.0",!1,d,e);var e=a.extend({},e,{name:"KRecordVideo"}),d=a.extend({},d,{useCamera:"1"});a("#video_record").html("Flash required for recording video."),swfobject.embedSWF("/media_record/KRecord.swf","video_record","400","300","9.0.0",!1,d,e)},c.browser.ie?500:10);var i={host:location.protocol+"//"+c.kalturaSettings.domain,partnerId:c.kalturaSettings.partner_id,subPId:c.kalturaSettings.subpartner_id,uid:j.data("uid")||"ANONYMOUS",entryId:"-1",ks:f,thumbOffset:"1",licenseType:"CC-0.1",maxFileSize:c.kalturaSettings.max_file_size_bytes/1048576,maxUploads:1,uiConfId:c.kalturaSettings.upload_ui_conf,jsDelegate:"$.mediaComment.audio_delegate"},k={align:"middle",quality:"high",bgcolor:"#ffffff",name:"KUpload",allowScriptAccess:"always",type:"application/x-shockwave-flash",pluginspage:"http://www.adobe.com/go/getflashplayer",wmode:"transparent"};a("#audio_upload").text(b.t("messages.flash_required_upload_audio","Flash required for uploading audio."));var m="180",n="50";swfobject.embedSWF("//"+c.kalturaSettings.domain+"/kupload/ui_conf_id/"+c.kalturaSettings.upload_ui_conf,"audio_upload",m,n,"9.0.0",!1,i,k),i=a.extend({},i,{jsDelegate:"$.mediaComment.video_delegate"}),a("#video_upload").text(b.t("messages.flash_required_upload_video","Flash required for uploading video."));var m="180",n="50";swfobject.embedSWF("//"+c.kalturaSettings.domain+"/kupload/ui_conf_id/"+c.kalturaSettings.upload_ui_conf,"video_upload",m,n,"9.0.0",!1,i,k);var o,p,q,r,s,t,u,v,w,x,y,z=!1;l=!0,setInterval(function(){l&&(o=a("#audio_record_holder"),p=a("#audio_record"),q=a("#audio_record_meter"),r=0,s=0,u=a("#video_record_holder"),v=a("#video_record"),w=a("#video_record_meter"),x=0,y=0,l=!1),r++,x++;var b=null,c=null;p&&p[0]&&p[0].getMicophoneActivityLevel&&p.parent().length?b=p[0].getMicophoneActivityLevel():p=a("#audio_record"),v&&v[0]&&v[0].getMicophoneActivityLevel&&v.parent().length?c=v[0].getMicophoneActivityLevel():v=a("#video_record");if(b!=null){b=Math.max(b,s),b>-1&&!o.hasClass("with_volume")&&(q.css("display","none"),a("#audio_record_holder").addClass("with_volume").animate({width:420},function(){q.css("display","")}));if(r>4){s=0,r=0;var d=(b-b%10)/10;q.attr("class","volume_meter band_"+d)}else s=b}if(c!=null){c=Math.max(c,y),c>-1&&!u.hasClass("with_volume")&&(w.css("display","none"),a("#video_record_holder").addClass("with_volume").animate({width:420},function(){w.css("display","")}));if(x>4){y=0,x=0;var d=(c-c%10)/10;w.attr("class","volume_meter band_"+d)}else y=c}},20)},i=new Date;i-m>3e5&&a("#media_comment_dialog").dialog("close").remove(),m=i;var j=a("#media_comment_dialog");if(j.length==0){var k=a("<div/>").attr("id","media_comment_dialog");k.text(b.t("messages.loading","Loading...")),k.dialog("close").dialog({autoOpen:!1,title:b.t("titles.record_upload_media_comment","Record/Upload Media Comment"),resizable:!1,width:470,height:300}).dialog("open"),a.ajaxJSON("/api/v1/services/kaltura_session","POST",{},function(a){k.data("ks",a.ks),k.data("uid",a.uid)},function(a){a.logged_in==0?k.data("ks-error",b.t("errors.must_be_logged_in","You must be logged in to record media.")):k.data("ks-error",b.t("errors.load_failed","Media Comment Application failed to load.  Please try again."))}),a.get("/partials/_media_comments.html",function(b){var c=function(){k.data("ks")?(k.html(b),k.find("#media_record_tabs").tabs({select:function(){a(document).triggerHandler("reset_media_comment_forms")}}),h()):k.data("ks-error")?k.html(k.data("ks-error")):setTimeout(c,500)};c(),j=a("#media_comment_dialog")}),j=k}else h()},a(document).ready(function(){a(document).bind("reset_media_comment_forms",function(){a("#audio_record_holder_message,#video_record_holder_message").removeClass("saving").find(".recorder_message").html("Saving Recording...<img src='/images/media-saving.gif'/>"),a("#audio_record_holder").stop(!0,!0).clearQueue().css("width","").removeClass("with_volume"),a("#video_record_holder").stop(!0,!0).clearQueue().css("width","").removeClass("with_volume"),a("#media_upload_submit").text(b.t("buttons.submit","Submit Media File")).attr("disabled",!0),a("#media_upload_settings").css("visibility","hidden"),a("#media_upload_progress").css("visibility","hidden").progressbar().progressbar("option","value",1),a("#media_upload_title").val("");var c=a("#audio_upload")[0]&&a("#audio_upload")[0].getFiles&&a("#audio_upload")[0].getFiles();c&&a("#audio_upload")[0].removeFiles&&c.length>0&&a("#audio_upload")[0].removeFiles(0,c.length-1),c=a("#video_upload")[0]&&a("#video_upload")[0].getFiles&&a("#video_upload")[0].getFiles(),c&&a("#video_upload")[0].removeFiles&&c.length>0&&a("#video_upload")[0].removeFiles(0,c.length-1)}),a("#media_upload_submit").live("click",function(b){a.mediaComment.upload_delegate.submit()}),a("#video_record_option,#audio_record_option").live("click",function(b){b.preventDefault(),a("#video_record_option,#audio_record_option").removeClass("selected_option"),a(this).addClass("selected_option"),a("#audio_record_holder").stop(!0,!0).clearQueue().css("width","").removeClass("with_volume"),a("#video_record_holder").stop(!0,!0).clearQueue().css("width","").removeClass("with_volume"),a(this).attr("id")=="audio_record_option"?(a("#video_record_holder_holder").hide(),a("#audio_record_holder_holder").show()):(a("#video_record_holder_holder").show(),a("#audio_record_holder_holder").hide())})}),a(document).bind("media_recording_error",function(){a("#audio_record_holder_message,#video_record_holder_message").find(".recorder_message").html(d(b.t("errors.save_failed","Saving appears to have failed.  Please close this popup to try again."))+"<div style='font-size: 0.8em; margin-top: 20px;'>"+d(b.t("errors.persistent_problem","If this problem keeps happening, you may want to try recording your media locally and then uploading the saved file instead."))+"</div>")})}(c,a),window.mediaCommentCallback=function(a){var b=c.trim(c("#current_context_code").text())||c.trim("user_"+c("#identity .user_id").text());for(var d in a){var e=a[d];if(e.mediaType==1||e.mediaType==2||e.mediaType==5||!0){var f="video";e.mediaType==2?f="image":e.mediaType==5&&(f="audio"),b&&c.ajaxJSON("/media_objects","POST",{id:e.entryId,type:f,context_code:b,title:e.name},function(a){c(document).triggerHandler("media_object_created",a)},function(a){}),c("#media_recorder_container").triggerHandler("media_comment_created",{id:e.entryId,mediaType:f})}}c("#media_comment_create_dialog").empty().dialog("close")},window.beforeAddEntry=function(){var a=Math.random();c.mediaComment.lastAddAttemptId=a,setTimeout(function(){c.mediaComment.lastAddAttemptId==a&&c(document).triggerHandler("media_recording_error")},3e4),c("#audio_record_holder_message,#video_record_holder_message").addClass("saving")},window.addEntryFail=function(){c(document).triggerHandler("media_recording_error")},window.addEntryFailed=function(){c(document).triggerHandler("media_recording_error")},window.addEntryComplete=function(a){c.mediaComment.lastAddAttemptId=null,c("#audio_record_holder_message,#video_record_holder_message").removeClass("saving");try{var d=null;c.isArray(a)||(a=[a]);for(var e=0;e<a.length;e++){var f=a[e];c("#media_record_tabs").tabs("option","selected")==0?d=c("#video_record_title,#audio_record_title").filter(":visible:first").val():c("#media_record_tabs").tabs("option","selected")!=1,f.entryType==1&&c("#audio_record_option").hasClass("selected_option")&&(f.entryType=5),c.mediaComment.entryAdded(f.entryId,f.entryType,f.entryName,d),c("#media_comment_dialog").dialog("close")}}catch(g){console.log(g),alert(b.t("errors.save_failed_try_again","Entry failed to save.  Please try again."))}}})