require(["i18n","jquery","str/htmlEscape","jquery.ajaxJSON","jquery.instructure_forms","jquery.instructure_jquery_patches","jquery.instructure_misc_plugins"],function(a,b,c){a=a.scoped("feedback"),b(document).ready(function(){function i(){j(function(){f.dialog("close").dialog({autoOpen:!1,resizable:!1}).dialog("open")})}function j(a){var c=!1;if(!h){var d=b("#identity_feedback"),e="user";d.hasClass("admin")?e="admin":d.hasClass("teacher")?e="teacher":d.hasClass("student")&&(e="student",c=!0),f.children("ul").addClass(e)}c?b.ajaxJSON("/courses","GET",{},function(b){g=b,a()}):a(),h=!0}var d=!1,e=b("#feedback_dialog"),f=b("#help_dialog"),g=[],h=!1,k=function(h){f.dialog("close");if(k.already_initialized){e.triggerHandler("feedback_click");return}k.already_initialized=!0;var i=function(a){a&&(e.find("#feedback_form_user_email").val(b("#feedback_user_email").text()).parent().showIf(!b("#identity .user_id").text()),e.find(".feedback-course-select").html(function(){return b.map(g,function(a){return'<option value="'+a.id+'">'+c(a.name)+"</option>"}).join("")}).showIf(g.length>0),e.find(".feedback-type-holder, .feedback-type-teacher").showIf(g.length>0),e.find(".feedback-type").change()),k.default_view=="message_teacher"?e.find("#feedback-type-teacher").attr("checked",!0):e.find("#feedback-type-instructure").attr("checked",!0),e.find(".feedback-type-holder").showIf(k.default_view=="message_teacher"),e.find(".feedback_message").showIf(k.default_view=="problem"),e.find(".feedback-course-select option[value="+b.trim(b("#identity .course_id").text())+"]").attr("selected",!0),e.find("#feedback_form_page_url").val(location.href),e.find("textarea, #feedback_form_subject").val(""),e.find("#feedback_form_subject").focus().select()},j={autoOpen:!1,title:a.t("titles.feedback","Canvas Feedback"),width:500,modal:!0,resizable:!1,overlay:{backgroundColor:"#000",opacity:.5},height:"auto",open:function(){d=!0,i()},close:function(){b("#submit_feedback_form .sending_text").text(a.t("buttons.send_feedback","Send Feedback")),b(this).find(".send_button").attr("disabled",!1)}};e.html("<h3>Loading Feedback Form...</h3>"),e.dialog("close").dialog(j).dialog("open"),b.get("/partials/_feedback.html",function(c){e.html(c),i(!0),b("#feedback_dialog .feedback-option").click(function(){b("#feedback_dialog .feedback-option-selected").removeClass("feedback-option-selected"),b(this).addClass("feedback-option-selected")}),b("#submit_feedback_form").formSubmit({formErrors:!1,object_name:"error",processData:function(a){var c=b(this).find(".feedback-option-selected");c.hasClass("idea")?a["error[backtrace]"]="Posted as an _IDEA_":c.hasClass("compliment")?a["error[backtrace]"]="Posted as a _COMPLIMENT_":a["error[backtrace]"]="Posted as a _PROBLEM_"},beforeSubmit:function(a){if(!a.comments)return!1;b(this).find(".sending_text").text("Sending...").end().find(".send_button").attr("disabled",!0)},success:function(a){b(this).find(".sending_text").text("Thank You!"),d=!1,setTimeout(function(){d||b("#feedback_dialog").dialog("close")},2500)},error:function(c){b(this).find(".sending_text").text(a.t("errors.send_failed","Send Failed, please try again")),b(this).find(".send_button").attr("disabled",!1)}}),e.bind("feedback_click",function(){e.dialog("close").dialog(j).dialog("open")})})};b("#feedback-dialog-select").live("change",function(){e.find(".feedback-course-select_holder").showIf(b(this).val()=="teacher")}),b(".feedback_link").click(function(a){a.preventDefault(),b("#feedback_link").click(),b("#feedback_dialog .feedback-option.idea").click()}),b("#feedback_link").click(function(a){a.preventDefault(),i()}),b("#help_dialog .message_teacher_link").click(function(a){a.preventDefault(),k.default_view="message_teacher",k(!0)}),b("#help_dialog .file_ticket_link").click(function(a){a.preventDefault(),k.default_view="problem",k(!0)})})})