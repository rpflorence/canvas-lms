require(["jquery","jquery.instructure_jquery_patches"],function(a){tinymce.create("tinymce.plugins.InstructureEquella",{init:function(b,c){b.addCommand("instructureEquella",function(){var c=a("#equella_dialog"),d=a("#equella_endpoint_url").attr("href"),e=a.trim(a("#equella_action").text()||"")||"selectOrAdd",f=a("#equella_callback_url").attr("href"),g=a("#equella_cancel_url").attr("href");if(!d||!f||!g){alert("Equella is not properly configured for this account, please notify your system administrator.");return}var h=Math.max(Math.min(a(window).height()-100,550),100);c.length||(c=a('<div id="equella_dialog" style="padding: 0; overflow-y: hidden;"/>').hide().html("<div class='teaser' style='width: 800px; margin-bottom: 10px; display: none;'></div><iframe style='background: url(/images/ajax-loader-medium-444.gif) no-repeat left top; width: 800px; height: "+h+"px; border: 0;' src='about:blank' borderstyle='0'/>").appendTo("body").dialog({autoOpen:!1,width:"auto",resizable:!0,resizeStart:function(){a(this).find("iframe").each(function(){a('<div class="fix_for_resizing_over_iframe" style="background: #fff;"></div>').css({width:this.offsetWidth+"px",height:this.offsetHeight+"px",position:"absolute",opacity:"0.001",zIndex:1e7}).css(a(this).offset()).appendTo("body")})},resizeStop:function(){a(".fix_for_resizing_over_iframe").remove()},resize:function(){a(this).find("iframe").add(".fix_for_resizing_over_iframe").height(a(this).height()).width(a(this).width())},close:function(){c.find("iframe").attr("src","about:blank")},title:"Embed content from Equella"}).bind("equella_ready",function(d,e){var f=c.data("editor")||b,g=b.selection.getContent();if(g)b.execCommand("mceInsertLink",!1,{title:e.name,href:e.url,"class":"equella_content_link"});else{var h=a("<div><a/></div>");h.find("a").attr("title",e.name).attr("href",e.url).attr("class","equella_content_link").text(e.name),b.execCommand("mceInsertContent",!1,h.html())}a("#equella_dialog").dialog("close")}));var i=a("#equella_teaser").html();c.find(".teaser").hide(),i&&c.find(".teaser").html(i).show();var j=d;j=j+"?method=lms&returnprefix=eq_&action="+e,j=j+"&returnurl="+encodeURIComponent(f),j=j+"&cancelurl="+encodeURIComponent(g),c.data("editor",b),c.dialog("close").dialog("open"),c.find("iframe").attr("src",j)}),b.addButton("instructure_equella",{title:"Insert Equella Links",cmd:"instructureEquella",image:c+"/button.gif"})},getInfo:function(){return{longname:"InstructureEquella",author:"Brian Whitmer",authorurl:"http://www.instructure.com",infourl:"http://www.instructure.com",version:tinymce.majorVersion+"."+tinymce.minorVersion}}}),tinymce.PluginManager.add("instructure_equella",tinymce.plugins.InstructureEquella)})