require(["jquery","vendor/scribd.view","jquery.instructure_jquery_patches","jquery.instructure_misc_helpers","jquery.instructure_misc_plugins","tinymce.editor_box"],function(a,b){var c=null;tinymce.create("tinymce.plugins.InstructureLinks",{init:function(b,c){function g(c){g.counter=g.counter||0,c==1&&g.counter!=0?g.counter=(g.counter+1)%5:a(b.getBody()).find("a").each(function(){var b=a(this);b.attr("href")&&!b.hasClass("inline_disabled")&&b.attr("href").match(INST.youTubeRegEx)&&b.addClass("youtube_link_to_box")}),a(b.getBody()).find("iframe").each(function(){var c=a(this),d=a("<img/>");d.addClass("iframe_placeholder"),d.attr("rel",c.attr("src")),d.attr("style",c.attr("style")),d.css("display","block"),d.attr("_iframe_style",c.attr("style"));var e=c.attr("width")||c.css("width");e=="auto"&&(e=null);if(!e||e=="100%"||e=="auto"){var f=a(b.contentAreaContainer).width();d.attr("width",f-15),d.css("width",f-15),d.addClass("fullWidth")}else d.attr("width",e),d.css("width",e);d.css("margin",5);var g=[],h=c.attr("src"),i="";for(var j=0;j<h.length;j++)i+=h[j],h[j].match(/[^a-zA-Z0-9\.]/)&&i.length>30&&(g.push(i),i="");g.push(i),c.attr("src"),d.attr("alt","This frame will embed the url:\r\n"+g.join("\r\n")),d.attr("title","This frame will embed the url:\r\n"+g.join("\r\n"));var k=c.attr("height")||c.css("height");k=="auto"&&(k=null),k?(d.attr("height",k),d.css("height",k)):(d.attr("height",300),d.css("height",300)),d.attr("src","/images/blank.png"),d.css("background","transparent url(/images/iframe.png) no-repeat top left"),d.css("border","1px solid #aaa");if(c.parents("p,div").length==0){var l=a("<p/>");l.append(d),d=l}c.after(d),c.remove()}).end().find(".iframe_placeholder").each(function(){var c=a(b.contentAreaContainer).width(),d=a(this);if(a(b.contentAreaContainer).hasScrollbar()||!0)c-=a(b.contentAreaContainer).scrollbarWidth();d.width()>c-40?(d.width(c-15),d.hasClass("fullWidth")||d.addClass("fullWidth")):d.hasClass("fullWidth")&&d.removeClass("fullWidth")})}var d={},e=["instructure_scribd_file"],f=["instructure_scribd_file"];setInterval(function(){d.counter=(d.counter||0)+1,d.counter>5&&(d.counter=0,d.hasChanged&&(d.hasChanged=!1,a("#instructure_link_prompt_form .prompt").triggerHandler("data_update")))},100),b.addCommand("instructureLinks",function(){var c=a("#"+b.id);if(c.data("enable_bookmarking")){var h=b.selection&&b.selection.getBookmark();c.data("last_bookmark",h)}var i=a("#instructure_link_prompt"),j="";i.removeClass("for_inline_content").find(".disable_enhancement").hide().end().find(".auto_show").hide().end().find(".insert_button").text("Insert Link").end().find(".disable_inline_content").attr("checked",!1).end().find(".auto_show_inline_content").attr("checked",!1);if(i.length==0){var i=a(document.createElement("div"));a.getUserServices("BookmarkService",function(b){var c=i.data("editor"),d=a("<div style='text-align: left; margin-left: 20px;'/>"),e,f;for(var g in b){e=b[g].user_service;if(e){f=a("<a href='#' class='bookmark_service no-hover'/>"),f.addClass(e.service),f.data("service",e),f.attr("title","Find links using "+e.service);var h=a("<img/>");h.attr("src","/images/"+e.service+"_small_icon.png"),f.append(h),f.click(function(b){b.preventDefault(),a("#instructure_link_prompt").dialog("close"),a.findLinkForService(a(this).data("service").service,function(b){a("#instructure_link_prompt").dialog("close"),c.editorBox("create_link",{title:b.title,url:b.url,classes:j})})}),d.append(f),d.append("&nbsp;&nbsp;")}}i.find("#instructure_link_prompt_form").after(d)}),i.append("<div style='font-size: 0.8em; margin-bottom: 5px;'>This will make the selected text a link, or insert a new link if nothing is selected.</div> Paste or type a url or wiki page in in the box below:<form id='instructure_link_prompt_form' style='margin-top: 5px;'><input type='text' class='prompt' style='width: 250px;' value='http://'/><button type='submit' class='insert_button button'>Insert Link</button></form>").append("<div class='actions'></div><div class='clear'></div>").append("<div class='disable_enhancement' style='display: none;'><input type='checkbox' class='disable_inline_content' id='disable_inline_content'/><label for='disable_inline_content'> Disable inline previews for this link</label></div>").append("<div class='auto_show' style='display: none;'><input type='checkbox' class='auto_show_inline_content' id='auto_show_inline_content'/><label for='auto_show_inline_content'> Auto-open the inline preview for this link</label></div>"),i.find(".disable_inline_content").change(function(){a(this).attr("checked")&&i.find(".auto_show_inline_content").attr("checked",!1),i.find(".auto_show").showIf(!a(this).attr("checked")&&i.hasClass("for_inline_content_can_auto_show"))}),i.find("#instructure_link_prompt_form").submit(function(b){var c=i.data("editor");b.preventDefault(),b.stopPropagation();var d=a(this).find(".prompt").val();!d.match(/^[a-zA-Z]+:\/\//)&&!d.match(/^[0-9a-zA-Z]+\.[0-9a-zA-Z]+/)&&d.match(/^[0-9a-zA-Z\s]+$/)&&(wiki_url=a("#wiki_sidebar_wiki_url").attr("href"),wiki_url&&(d=a.replaceTags(wiki_url,"page_url",d.replace(/\s/,"-").toLowerCase())));var e=j.replace(/(auto_open|inline_disabled)/g,"");i.find(".auto_show_inline_content").attr("checked")&&(e+=" auto_open"),i.find(".disable_inline_content").attr("checked")&&(e+=" inline_disabled"),c.editorBox("create_link",{url:d,classes:e}),i.dialog("close"),g(!0)}),i.find(".actions").delegate(".embed_image_link","click",function(b){var c=i.data("editor");b.preventDefault(),c.editorBox("insert_code","<img src='"+a(b.target).closest("img").attr("src")+"'/>"),i.dialog("close")}),i.find(".actions").delegate(".embed_youtube_link","click",function(b){var c=i.data("editor");b.preventDefault(),c.editorBox("create_link",a(b.target).closest("img").attr("alt")),i.dialog("close")}),i.find("#instructure_link_prompt_form .prompt").bind("change keypress",function(a){d.counter=0,d.hasChanged=!0}).bind("data_update",function(){a("#instructure_link_prompt .actions").empty();var b=a(this).val(),c=i.data("original_data");if(!c||b!=c.url){i.removeClass("for_inline_content").removeClass("for_inline_content_can_auto_show");var d=new RegExp("("+e.join("|")+")","g");j=j.replace(d,"")}else i.toggleClass("for_inline_content",c.for_inline_content).toggleClass("for_inline_content_can_auto_show",c.for_inline_content_can_auto_show).find(".disable_enhancement").showIf(c.for_inline_content).end().find(".auto_show").showIf(c.for_inline_content_can_auto_show),j=c.prior_classes;var f=!i.hasClass("for_inline_content"),g=!i.hasClass("for_inline_content_can_auto_show");if(b.match(/\.(gif|png|jpg|jpeg)$/)){var h=a(document.createElement("div"));h.css("textAlign","center");var k=a(document.createElement("img"));k.attr("src",b),k.addClass("embed_image_link"),k.css("cursor","pointer");var l=new Image;l.src=b;function m(){l.complete?(l.height<100||l.height>100&&l.height<200)&&k.height(l.height):setTimeout(m,500)}setTimeout(m,500),k.height(100),k.attr("title","Click to Embed the Image"),h.append(k),a("#instructure_link_prompt .actions").append(h)}else if(b.match(INST.youTubeRegEx)){var n=a.youTubeID(b),h=a(document.createElement("div"));h.css("textAlign","center"),!i.find(".disable_inline_content").attr("checked")&&i.hasClass("for_inline_content_can_auto_show")&&i.find(".auto_show").show(),f=!1,i.find(".disable_enhancement").show();var k=a(document.createElement("img"));k.attr("src","http://img.youtube.com/vi/"+n+"/2.jpg"),k.css({paddingLeft:100,background:"url(/images/youtube_logo.png) no-repeat left center",height:90,display:"inline-block"}),k.attr("alt",b),k.addClass("embed_youtube_link"),k.css("cursor","pointer"),k.attr("title","Click to Embed YouTube Video"),h.append(k),a("#instructure_link_prompt .actions").append(h)}f&&(i.find(".disable_enhancement").hide(),i.find(".disable_inline_content").attr("checked",!1)),g&&(i.find(".auto_show").hide(),i.find(".auto_show_inline_content").attr("checked",!1))}),i.attr("id","instructure_link_prompt"),a("body").append(i)}i.data("editor",c),i.data("original_data",null);var k=b.selection.getNode();while(k.nodeName!="A"&&k.nodeName!="BODY"&&k.parentNode)k=k.parentNode;var l=k.nodeName=="A"?a(k):null;if(l){i.find(".prompt").val(l.attr("href")).change(),j=(l.attr("class")||"").replace(/youtube_link_to_box/,"");var m=new RegExp("("+e.join("|")+")");(l.attr("class")||"").match(m)&&i.addClass("for_inline_content").find(".disable_enhancement").show();var m=new RegExp("("+f.join("|")+")");(l.attr("class")||"").match(m)&&i.addClass("for_inline_content_can_auto_show").find(".auto_show").show(),i.data("original_data",{url:l.attr("href"),for_inline_content:i.hasClass("for_inline_content"),for_inline_content_can_auto_show:i.hasClass("for_inline_content_can_auto_show"),prior_classes:j}),i.find(".disable_inline_content").attr("checked",l.hasClass("inline_disabled")).triggerHandler("change"),i.find(".auto_show_inline_content").attr("checked",l.hasClass("auto_open")).triggerHandler("change"),i.find(".insert_button").text("Update Link")}i.dialog("close").dialog({autoOpen:!1,width:425,height:"auto",title:"Link to Website URL",open:function(){a(this).find(".prompt").focus().select()}}).dialog("open")}),b.addButton("instructure_links",{title:"Link to URL",cmd:"instructureLinks",image:c+"/img/button.gif"}),b.onPreProcess.add(function(b,c){a(c.node).find("a.youtube_link_to_box").removeClass("youtube_link_to_box"),a(c.node).find("img.iframe_placeholder").each(function(){var b=a(this),c=a("<iframe/>");c.attr("src",b.attr("rel")),c.attr("style",b.attr("_iframe_style")),c.height(b.attr("height")||b.css("height")),b.hasClass("fullWidth")&&(b.attr("width","100%"),b.css("width","100%")),c.css("width",b.attr("width")||b.css("width")),a(this).after(c),a(this).remove()})}),b.onChange.add(function(){g()}),b.onSetContent.add(function(){g("contentJustSet")}),b.onNodeChange.add(function(a,b,c){while(c.nodeName!="A"&&c.nodeName!="BODY"&&c.parentNode)c=c.parentNode;b.setActive("instructure_links",c.nodeName=="A")})},getInfo:function(){return{longname:"InstructureLinks",author:"Brian Whitmer",authorurl:"http://www.instructure.com",infourl:"http://www.instructure.com",version:tinymce.majorVersion+"."+tinymce.minorVersion}}}),tinymce.PluginManager.add("instructure_links",tinymce.plugins.InstructureLinks)})