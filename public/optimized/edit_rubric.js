require(["i18n","jquery","find_outcome","jquery.ajaxJSON","jquery.instructure_forms","jquery.instructure_jquery_patches","jquery.instructure_misc_helpers","jquery.instructure_misc_plugins","jquery.loadingImg","jquery.templateData","vendor/jquery.ba-throttle-debounce","vendor/jquery.scrollTo"],function(a,b){a=a.scoped("edit_rubric");var c={htmlBody:null,updateCriteria:function(a){a.find(".criterion:not(.blank)").each(function(a){b(this).attr("id","criterion_"+(a+1))})},addCriterion:function(a){var b=a.find(".criterion.blank:first"),d=b.clone(!0);return d.removeClass("blank"),a.find(".summary").before(d.show()),c.updateCriteria(a),c.updateRubricPoints(a),c.sizeRatings(d),d},findOutcomeCriterion:function(a){b("#find_outcome_criterion_dialog").data("current_rubric",a),find_outcome.find(function(a){if(!b("#find_outcome_criterion_dialog").data("current_rubric"))return;var c=b("#find_outcome_criterion_dialog").data("current_rubric"),d=a.find(".learning_outcome_id").text();c.find(".criterion.learning_outcome_"+d).find(".delete_criterion_link").click(),c.find(".add_criterion_link").click();var e=c.find(".criterion:not(.blank):last");e.toggleClass("ignore_criterion_for_scoring",!a.find(".criterion_for_scoring").attr("checked")),e.find(".mastery_points").val(a.find(".mastery_points").text()),e.addClass("learning_outcome_criterion"),e.find(".learning_outcome_id").text(d),e.find(".criterion_points").val(a.find(".rating:not(.blank):first .points").text()).blur();for(var f=0;f<a.find(".rating:not(.blank)").length-2;f++)e.find(".rating:not(.blank):first").addClass("add_column").click();e.find(".rating:not(.blank)").each(function(c){var d=a.find(".rating:not(.blank)").eq(c).getTemplateData({textValues:["description","points"]});b(this).fillTemplateData({data:d})});var g=a.find(".body.description").html(),h=a.find(".mastery_points").text();e.find(".cancel_button").click(),e.find(".long_description").val(g),e.find(".long_description_holder").toggleClass("empty",!g),e.find(".criterion_description_value").text(a.find(".short_description").text()),e.find(".criterion_description").val(a.find(".short_description").text()).focus().select(),e.find(".mastery_points").text(h)},{for_rubric:!0})},hideCriterionAdd:function(a){a.find(".add_right, .add_left, .add_column").removeClass("add_left add_right add_column")},updateRubricPoints:function(a){var c=0;a.find(".criterion:not(.blank):not(.ignore_criterion_for_scoring) .criterion_points").each(function(){var a=parseFloat(b(this).val(),10);isNaN(a)||(c+=a)}),a.find(".rubric_total").text(c)},updateCriterionPoints:function(a,d){c.hideEditRating();var e=b.makeArray(a.find(".rating")).reverse(),f=-1,g=parseFloat(a.find(".criterion_points").val());isNaN(g)&&(g=5),a.find(".rating:first .points").text(g),b.each(e,function(a,c){var d=b(c),e=d.getTemplateData({textValues:["points"]});e.points<f&&(e.points=f+1,d.fillTemplateData({data:e})),f=parseFloat(e.points)}),d&&f>g&&(g=f),a.find(".criterion_points").val(g),a.find(".display_criterion_points").text(g);if(!a.data("criterion_points")||a.data("criterion_points")!=g){if(!a.data("criterion_points")){var h=parseFloat(a.find(".rating:first .points").text());a.data("criterion_points",h)}var i=parseFloat(a.data("criterion_points")),j=g,k=a.find(".rating");b(k[0]).find(".points").text(g);var l=g;for(var m=1;m<k.length-1;m++){var h=parseFloat(b(k[m]).find(".points").text()),n=Math.round(h/i*j);if(isNaN(h)||h==0&&l>0)n=l-Math.round(l/(k.length-m));n>=l&&(n=l-1),n=Math.max(0,n),l=n,b(k[m]).find(".points").text(n)}a.data("criterion_points",g)}c.updateRubricPoints(a.parents(".rubric"))},editRating:function(a){if(!a.parents(".rubric").hasClass("editing"))return;c.hideEditRating(!0),c.hideCriterionAdd(a.parents(".rubric"));var d=Math.max(40,a.find(".rating").height()),e=a.getTemplateData({textValues:["description","points"]}),f=b("#edit_rating");f.fillFormData(e),a.find(".container").hide(),a.append(f.show()),f.find(":input:first").focus().select(),a.addClass("editing"),c.sizeRatings(a.parents(".criterion"))},hideEditRating:function(a){var d=b("#edit_rating");d.filter(":visible").length>0&&a&&d.find("form").submit();var e=d.parents(".rating");e.removeClass("editing"),d.appendTo(b("body")).hide(),e.find(".container").show(),c.sizeRatings(e.parents(".criterion")),c.hideCriterionAdd(e.parents(".rubric"))},editCriterion:function(a){if(!a.parents(".rubric").hasClass("editing"))return;c.hideEditCriterion(!0);var d=a.find(".criterion_description"),e=Math.max(40,d.find(".description").height()),f=d.getTemplateData({textValues:["description"]}),g=b("#edit_criterion");g.fillFormData(f),d.find(".container").hide().after(g.show()),g.find(":input:first").focus().select(),c.sizeRatings(a)},hideEditCriterion:function(a){var d=b("#edit_criterion");d.filter(":visible").length>0&&a&&d.find("form").submit();var e=d.parents(".criterion");d.appendTo("body").hide(),e.find(".criterion_description").find(".container").show(),c.sizeRatings(e)},originalSizeRatings:function(){var a=b(".rubric:not(.rubric_summary) .criterion:visible");if(a.length){var d=b.windowScrollTop();a.each(function(){var a=b(this),c=a.find(".ratings:visible");if(c.length){var d=c.find(".rating .container").css("height",""),e=Math.max(c.height(),a.find(".criterion_description .container").height());d.css("height",e-10+"px")}}),c.htmlBody.scrollTop(d)}},rubricData:function(a){a=a.filter(":first"),a.hasClass("editing")||(a=a.next(".editing")),a.find(".criterion_points").each(function(){var a=b(this).val();b(this).parents(".criterion").find(".display_criterion_points").text(a)});var c=a.getFormData();a.find("thead .title").text(c.title);var c=a.getTemplateData({textValues:["title","description","rubric_total","rubric_association_id"]}),d={};d["rubric[title]"]=c.title,d["rubric[points_possible]"]=c.rubric_total,d["rubric_association[use_for_grading]"]=a.find(".grading_rubric_checkbox").attr("checked")?"1":"0",d["rubric_association[hide_score_total]"]="0",d["rubric_association[use_for_grading]"]=="0"&&(d["rubric_association[hide_score_total]"]=a.find(".totalling_rubric_checkbox").attr("checked")?"1":"0"),d["rubric[free_form_criterion_comments]"]=a.find(".rubric_custom_rating").attr("checked")?"1":"0",d["rubric_association[id]"]=c.rubric_association_id;var e=0;return a.find(".criterion:not(.blank)").each(function(){var a=b(this);a.hasClass("learning_outcome_criterion")||a.find("span.mastery_points").text(parseFloat(a.find("input.mastery_points").val(),10)||"0");var c=a.getTemplateData({textValues:["description","display_criterion_points","learning_outcome_id","mastery_points","long_description","criterion_id"]});c.long_description=a.find("textarea.long_description").val(),c.mastery_points=a.find("span.mastery_points").text();var f="rubric[criteria]["+e+"]";d[f+"[description]"]=c.description,d[f+"[points]"]=c.display_criterion_points,d[f+"[learning_outcome_id]"]=c.learning_outcome_id,d[f+"[long_description]"]=c.long_description,d[f+"[id]"]=c.criterion_id,c.learning_outcome_id&&(d[f+"[mastery_points]"]=c.mastery_points);var g=0;a.find(".rating").each(function(){var a=b(this),c=a.getTemplateData({textValues:["description","points","rating_id"]}),e=f+"[ratings]["+g+"]";d[e+"[description]"]=c.description,d[e+"[points]"]=c.points,d[e+"[id]"]=c.rating_id,g++}),e++}),d.title=d["rubric[title]"],d.points_possible=d["rubric[points_possible]"],d.rubric_id=a.attr("id").substring(7),d=b.extend(d,b("#rubrics #rubric_parameters").getFormData()),d},addRubric:function(){var a=b("#default_rubric").clone(!0).attr("id","rubric_new").addClass("editing");a.find("#edit_rubric").remove();var c=b("#edit_rubric").clone(!0).show().removeAttr("id").addClass("edit_rubric"),d=c.find("#edit_rubric_form");a.append(c),d.attr("method","POST").attr("action",b("#add_rubric_url").attr("href"));var e=parseFloat(b("#full_assignment .points_possible,#rubrics.rubric_dialog .assignment_points_possible").filter(":first").text());return d.find(".rubric_grading").showIf(e||b("#full_assignment").length>0),a},editRubric:function(a,d){var e=a.clone(!0).addClass("editing");e.find("#edit_rubric").remove();var f=e.getTemplateData({textValues:["use_for_grading","free_form_criterion_comments","hide_score_total"]});a.hide().after(e.show());var g=b("#edit_rubric").clone(!0).show().removeAttr("id").addClass("edit_rubric"),h=g.find("#edit_rubric_form");return e.append(g),e.find(":text:first").focus().select(),h.find(".grading_rubric_checkbox").attr("checked",f.use_for_grading=="true").triggerHandler("change"),h.find(".rubric_custom_rating").attr("checked",f.free_form_criterion_comments=="true").triggerHandler("change"),h.find(".totalling_rubric_checkbox").attr("checked",f.hide_score_total=="true").triggerHandler("change"),h.find(".save_button").text(e.attr("id")=="rubric_new"?"Create Rubric":"Update Rubric"),h.attr("method","PUT").attr("action",d),c.sizeRatings(),e},hideEditRubric:function(a,c){a=a.filter(":first"),a.hasClass("editing")||(a=a.next(".editing")),a.removeClass("editing"),b("#edit_criterion").hide().appendTo("body"),a.find(".edit_rubric").remove(),c?(a.attr("id")!="rubric_new"?a.prev(".rubric").show():b(".add_rubric_link").show(),a.remove()):a.find(".rubric_title .links").show()},updateRubric:function(a,c){a.find(".criterion:not(.blank)").remove();var d=a.find(".rating:first").clone(!0).removeAttr("id");a.fillTemplateData({data:c,id:"rubric_"+c.id,hrefValues:["id","rubric_association_id"],avoid:".criterion"}),a.fillFormData(c);var e=b.replaceTags(a.find(".edit_rubric_url").attr("href"),"rubric_id",c.id);a.find(".edit_rubric_link").attr("href",e);var e=b.replaceTags(a.find(".delete_rubric_url").attr("href"),"association_id",c.rubric_association_id);a.find(".delete_rubric_link").attr("href",e),a.find(".edit_rubric_link").showIf(c.permissions.update_association),a.find(".find_rubric_link").showIf(c.permissions.update_association&&!b("#rubrics").hasClass("raw_listing")),a.find(".delete_rubric_link").showIf(c.permissions.delete_association),a.find(".criterion:not(.blank) .ratings").empty();for(var f in c.criteria){var g=c.criteria[f];g.display_criterion_points=g.points,g.criterion_id=g.id;var h=a.find(".criterion.blank:first").clone(!0).show().removeAttr("id");h.removeClass("blank"),h.fillTemplateData({data:g}),h.find(".long_description_holder").toggleClass("empty",!g.long_description),h.find(".ratings").empty(),h.toggleClass("learning_outcome_criterion",!!g.learning_outcome_id);for(var i in g.ratings){var j=g.ratings[i];j.rating_id=j.id;var k=d.clone(!0);k.toggleClass("edge_rating",i===0||i===g.ratings.length-1),k.fillTemplateData({data:j}),h.find(".ratings").append(k)}a.find(".summary").before(h),h.find(".criterion_points").val(g.points).blur()}a.find(".criterion:not(.blank)").find(".ratings").showIf(!c.free_form_criterion_comments).end().find(".custom_ratings").showIf(c.free_form_criterion_comments)}};c.sizeRatings=b.debounce(10,c.originalSizeRatings),b(document).ready(function(){var d=!0,e=b("#rubric_dialog"),f=b("#rubric_long_description_dialog");c.htmlBody=b("html,body"),b("#rubrics").delegate(".long_description_link","click",function(c){c.preventDefault();var d=b(this).parents(".rubric").hasClass("editing"),e=b(this).parents(".criterion"),g=b(this).parents(".criterion").hasClass("learning_outcome_criterion"),h=e.getTemplateData({textValues:["long_description","description"]});h.long_description=e.find("textarea.long_description").val(),f.data("current_criterion",e).fillTemplateData({data:h,htmlValues:g?["long_description"]:[]}).fillFormData(h).find(".editing").showIf(d&&!e.hasClass("learning_outcome_criterion")).end().find(".displaying").showIf(!d||e.hasClass("learning_outcome_criterion")).end().dialog("close").dialog({autoOpen:!1,title:a.t("titles.criterion_long_description","Criterion Long Description"),width:400}).dialog("open").find("textarea:visible:first").focus().select()}).delegate(".find_rubric_link","click",function(c){c.preventDefault(),e.dialog("close").dialog({autoOpen:!0,width:800,height:380,resizable:!0,title:a.t("titles.find_existing_rubric","Find Existing Rubric")}).dialog("open");if(!e.hasClass("loaded")){e.find(".loading_message").text(a.t("messages.loading_rubric_groups","Loading rubric groups..."));var d=e.find(".grading_rubrics_url").attr("href");b.ajaxJSON(d,"GET",{},function(a){for(var b in a){var c=a[b],d=e.find(".rubrics_dialog_context_select.blank:first").clone(!0).removeClass("blank");d.fillTemplateData({data:{name:c.name,context_code:c.context_code,rubrics:c.rubrics+" rubrics"}}),e.find(".rubrics_dialog_contexts_select").append(d.show())}var f={};a.length==0?e.find(".loading_message").text("No rubrics found"):e.find(".loading_message").remove(),e.find(".rubrics_dialog_rubrics_holder").slideDown(),e.find(".rubrics_dialog_contexts_select .rubrics_dialog_context_select:visible:first").click(),e.addClass("loaded")},function(b){e.find(".loading_message").text(a.t("errors.load_rubrics_failed","Loading rubrics failed, please try again"))})}}).delegate(".edit_rubric_link","click",function(d){var e=b(this);return(!e.hasClass("copy_edit")||confirm(a.t("prompts.read_only_rubric","You can't edit this rubric, either because you don't have permission or it's being used in more than one place. Any changes you make will result in a new rubric based on the old rubric.  Continue anyway?")))&&c.editRubric(e.parents(".rubric"),e.attr("href")),!1}),b(".rubric .delete_rubric_link").bind("click",function(c,d){c.preventDefault();var e=a.t("prompts.confirm_delete","Are you sure you want to delete this rubric?");d&&d.confirmationMessage&&(e=d.confirmationMessage),b(this).parents(".rubric").confirmDelete({url:b(this).attr("href"),message:e,success:function(){b(this).fadeOut(function(){b(".add_rubric_link").show(),d&&b.isFunction(d)&&d()})}})}),f.find(".save_button").click(function(){var a=f.find("textarea.long_description").val(),b=f.data("current_criterion");b&&(b.fillTemplateData({data:{long_description:a}}),b.find("textarea.long_description").val(a),b.find(".long_description_holder").toggleClass("empty",!a)),f.dialog("close")}),f.find(".cancel_button").click(function(){f.dialog("close")}),b(".add_rubric_link").click(function(a){a.preventDefault();if(b("#rubric_new").length>0)return;if(d&&b("#rubrics .rubric:visible").length>0)return;var e=c.addRubric();b("#rubrics").append(e.show()),e.find(":text:first").focus().select(),d&&b(".add_rubric_link").hide()}),b("#rubric_dialog").delegate(".rubrics_dialog_context_select","click",function(c){c.preventDefault(),b(".rubrics_dialog_contexts_select .selected_side_tab").removeClass("selected_side_tab");var d=b(this);d.addClass("selected_side_tab");var f=d.getTemplateData({textValues:["context_code"]}).context_code;if(d.hasClass("loaded"))e.find(".rubrics_loading_message").hide(),e.find(".rubrics_dialog_rubrics,.rubrics_dialog_rubrics_select").show(),e.find(".rubrics_dialog_rubrics_select .rubrics_dialog_rubric_select").hide(),e.find(".rubrics_dialog_rubrics_select .rubrics_dialog_rubric_select."+f).show(),e.find(".rubrics_dialog_rubrics_select .rubrics_dialog_rubric_select:visible:first").click();else{e.find(".rubrics_loading_message").text(a.t("messages.loading_rubrics","Loading rubrics...")).show(),e.find(".rubrics_dialog_rubrics,.rubrics_dialog_rubrics_select").hide();var g=e.find(".grading_rubrics_url").attr("href")+"?context_code="+f;b.ajaxJSON(g,"GET",{},function(a){d.addClass("loaded"),e.find(".rubrics_loading_message").hide(),e.find(".rubrics_dialog_rubrics,.rubrics_dialog_rubrics_select").show();for(var b in a){var c=a[b].rubric_association,g=c.rubric,h=e.find(".rubrics_dialog_rubric_select.blank:first").clone(!0);h.addClass(c.context_code),g.criterion_count=g.data.length,h.fillTemplateData({data:g}).removeClass("blank"),e.find(".rubrics_dialog_rubrics_select").append(h.show());var i=e.find(".rubrics_dialog_rubric.blank:first").clone(!0);i.removeClass("blank"),i.find(".criterion.blank").hide(),g.rubric_total=g.points_possible,i.fillTemplateData({data:g,id:"rubric_dialog_"+g.id});for(var b in g.data){var j=g.data[b];j.criterion_points=j.points,j.criterion_points_possible=j.points,j.criterion_description=j.description;var k=j.ratings;delete j.ratings;var l=i.find(".criterion.blank:first").clone().removeClass("blank");l.fillTemplateData({data:j}),l.find(".rating_holder").addClass("blank");for(var m in k){var n=k[m],o=l.find(".rating_holder.blank:first").clone().removeClass("blank");n.rating=n.description,o.fillTemplateData({data:n}),l.find(".ratings").append(o.show())}l.find(".rating_holder.blank").remove(),i.find(".rubric.rubric_summary tr.summary").before(l.show())}e.find(".rubrics_dialog_rubrics").append(i)}e.find(".rubrics_dialog_rubrics_select .rubrics_dialog_rubric_select").hide(),e.find(".rubrics_dialog_rubrics_select .rubrics_dialog_rubric_select."+f).show(),e.find(".rubrics_dialog_rubrics_select .rubrics_dialog_rubric_select:visible:first").click()},function(a){e.find(".rubrics_loading_message").text("Loading rubrics failed, please try again")})}}).delegate(".rubrics_dialog_rubric_select","click",function(a){a.preventDefault();var c=b(this);c.find("a").focus();var d=c.getTemplateData({textValues:["id"]}).id;b(".rubric_dialog .rubrics_dialog_rubric_select").removeClass("selected_side_tab"),c.addClass("selected_side_tab"),b(".rubric_dialog .rubrics_dialog_rubric").hide(),b(".rubric_dialog #rubric_dialog_"+d).show()}).delegate(".select_rubric_link","click",function(a){a.preventDefault();var d={},f=e.getTemplateData({textValues:["rubric_association_type","rubric_association_id","rubric_association_purpose"]});d["rubric_association[association_type]"]=f.rubric_association_type,d["rubric_association[association_id]"]=f.rubric_association_id,d["rubric_association[rubric_id]"]=b(this).parents(".rubrics_dialog_rubric").getTemplateData({textValues:["id"]}).id,d["rubric_association[purpose]"]=f.rubric_association_purpose,e.loadingImage();var g=e.find(".select_rubric_url").attr("href");b.ajaxJSON(g,"POST",d,function(a){e.loadingImage("remove");var d=b("#rubrics .rubric:visible:first");d.length===0&&(d=c.addRubric());var f=a.rubric;f.rubric_association_id=a.rubric_association.id,f.permissions=f.permissions||{},a.rubric_association.permissions&&(f.permissions.update_association=a.rubric_association.permissions.update,f.permissions.delete_association=a.rubric_association.permissions["delete"]),c.updateRubric(d,f),c.hideEditRubric(d,!1),e.dialog("close")},function(){e.loadingImage("remove")})}),e.find(".cancel_find_rubric_link").click(function(a){a.preventDefault(),e.dialog("close")}),e.find(".rubric_brief").find(".expand_data_link,.collapse_data_link").click(function(a){a.preventDefault(),b(this).parents(".rubric_brief").find(".expand_data_link,.collapse_data_link").toggle().end().find(".details").slideToggle()});var g=!1,h=!1;b("#edit_rubric_form").formSubmit({processData:function(d){var e=b(this).parents(".rubric");if(e.find(".criterion:not(.blank)").length===0)return!1;var d=c.rubricData(e);if(d["rubric_association[use_for_grading]"]=="1"){var f=parseFloat(b("#full_assignment .points_possible").text()),i=parseFloat(d.points_possible);if(f&&i!=f&&!g){var j=b.trim(b("#full_assignment .title").text()),k=b("<p />").text(a.t("prompts.update_assignment_points","%{assignment_title} has %{assignment_points} points possible, would you like to change it to have %{rubric_points} points possible to match this rubric?",{assignment_points:f,assignment_title:j,rubric_points:i})).dialog({buttons:{Change:function(){g=!0,h=!1,k.remove(),b("#edit_rubric_form").submit()},"Leave different":function(){g=!0,h=!0,k.remove(),b("#edit_rubric_form").submit()}},width:320,resizable:!1,title:a.t("titles.update_assignment_points","Change points possible to match rubric?"),close:function(){k.remove()}});return!1}}return d.skip_updating_points_possible=h,h=!1,g=!1,d},beforeSubmit:function(a){var c=b(this).parents(".rubric");return c.find("thead .title").text(a["rubric[title]"]),c.find(".rubric_total").text(a.points_possible),c.removeClass("editing"),c.attr("id")=="rubric_new"?c.attr("id","rubric_adding"):c.prev(".rubric").remove(),b(this).parents("tr").hide(),c.loadingImage(),c},success:function(a,d){var e=a.rubric;d.loadingImage("remove"),e.rubric_association_id=a.rubric_association.id,e.permissions=e.permissions||{},a.rubric_association.permissions&&(e.permissions.update_association=a.rubric_association.permissions.update,e.permissions.delete_association=a.rubric_association.permissions["delete"]),c.updateRubric(d,e),a.rubric_association&&a.rubric_association.use_for_grading&&!a.rubric_association.skip_updating_points_possible&&(b("#full_assignment .points_possible").text(e.points_possible),b("#full_assignment input.points_possible").val(e.points_possible)),d.find(".rubric_title .links:not(.locked)").show()}}),b("#edit_rubric_form .cancel_button").click(function(){c.hideEditRubric(b(this).parents(".rubric"),!0)}),b("#rubrics").delegate(".add_criterion_link","click",function(a){var d=c.addCriterion(b(this).parents(".rubric"));return c.editCriterion(d),!1}).delegate(".find_outcome_link","click",function(a){return c.findOutcomeCriterion(b(this).parents(".rubric")),!1}).delegate(".criterion_description_value","click",function(a){return c.editCriterion(b(this).parents(".criterion")),!1}).delegate(".edit_criterion_link","click",function(a){return c.editCriterion(b(this).parents(".criterion")),!1}).delegate(".delete_criterion_link","click",function(a){var d=b(this).parents(".criterion");return d.fadeOut(function(){var a=d.parents(".rubric");d.remove(),c.updateCriteria(a),c.updateRubricPoints(a)}),!1}).delegate(".rating_description_value,.edit_rating_link","click",function(a){return c.editRating(b(this).parents(".rating")),!1}).bind("mouseover",function(a){$target=b(a.target),$target.closest(".ratings").length||c.hideCriterionAdd($target.parents(".rubric"))}).delegate(".rating","mousemove",function(a){var d=b(this),e=d.parents(".rubric");if(e.find(".rating.editing").length>0||d.parents(".criterion").hasClass("learning_outcome_criterion"))return c.hideCriterionAdd(e),!1;var f=10;if(!b.data(this,"hover_offset")){b.data(this,"hover_offset",d.offset()),b.data(this,"hover_width",d.outerWidth());var g=b.data(this,"points",parseFloat(d.find(".points").text())),h=b.data(this,"prev_points",parseFloat(d.prev(".rating").find(".points").text())),i=b.data(this,"next_points",parseFloat(d.next(".rating").find(".points").text()));b.data(this,"prev_diff",Math.abs(g-h)),b.data(this,"next_diff",Math.abs(g-i))}var j=b.data(this,"hover_offset"),k=b.data(this,"hover_width"),l=d.parents(".ratings"),m=a.pageX,n=a.pageY,o=!1;m<=j.left+k/2&&(o=!0);var p=l.data("hover_rating"),q=l.data("hover_left_side");if(!p||d[0]!=p[0]||o!=q){c.hideCriterionAdd(e);var r,s;o&&(r=d.prev(".rating"))&&r.length?(d.addClass("add_left"),r.addClass("add_right"),d[m>j.left+f?"removeClass":"addClass"]("add_column")):!o&&(s=d.next(".rating"))&&s.length&&(d.addClass("add_right"),s.addClass("add_left"),d[m<j.left+k-f?"removeClass":"addClass"]("add_column"))}else p&&(o?m<=j.left+f&&b.data(this,"prev_diff")>1?d.addClass("add_column"):d.removeClass("add_column"):m>=j.left+k-f&&b.data(this,"next_diff")>1?d.addClass("add_column"):d.removeClass("add_column"));return!1}).delegate(".rating","mouseout",function(a){b(this).data("hover_offset",null).data("hover_width",null)}).delegate(".delete_rating_link","click",function(a){a.preventDefault(),c.hideCriterionAdd(b(this).parents(".rubric")),b(this).parents(".rating").fadeOut(function(){var a=b(this).parents(".criterion");b(this).remove(),c.sizeRatings(a)})}).delegate(".add_column","click",function(a){var d=b(this),e=d.parents(".rubric");if(e.hasClass("editing")){var f=d.clone(!0).removeClass("edge_rating"),g=parseFloat(d.find(".points").text()),h=d.parents(".criterion"),i=h.find(".criterion_points"),j=parseFloat(i.val(),10)||5,k={description:"Rating Description"},l=d.hasClass("add_left");if(d.hasClass("add_left")){var m=parseFloat(d.prev(".rating").find(".points").text());k.points=Math.round((g+m)/2);if(k.points==g||k.points==m)k.points=m,h.find(".criterion_points").val(j+1)}else{var n=parseFloat(d.next(".rating").find(".points").text());k.points=Math.round((g+n)/2);if(k.points==g||k.points==n)k.points=g,i.val(j+1)}f.fillTemplateData({data:k}),l?d.before(f):d.after(f),c.hideCriterionAdd(e),c.updateCriterionPoints(h),c.sizeRatings(h)}return!1}),b(".criterion_points").keydown(function(a){a.keyCode==13&&(c.updateCriterionPoints(b(this).parents(".criterion")),b(this).blur())}).blur(function(a){c.updateCriterionPoints(b(this).parents(".criterion"))}),b("#edit_criterion").delegate(".cancel_button","click",function(a){c.hideEditCriterion()}),b("#edit_criterion_form").submit(function(a){a.preventDefault(),a.stopPropagation();var d=b(this).parents("#edit_criterion").getFormData();d.criterion_description_value=d.description,delete d.description,b(this).parents(".criterion").fillTemplateData({data:d}),c.hideEditCriterion()}),b("#edit_rating").delegate(".cancel_button","click",function(a){c.hideEditRating()}),b("#edit_rating_form").submit(function(a){a.preventDefault(),a.stopPropagation();var d=b(this).parents("#edit_rating").getFormData();d.points=parseFloat(d.points),isNaN(d.points)&&(d.points=parseFloat(b(this).parents(".criterion").find(".criterion_points").val()),isNaN(d.points)&&(d.points=5));var e=b(this).parents(".rating");e.fillTemplateData({data:d}),e.prev(".rating").length===0&&b(this).parents(".criterion").find(".criterion_points").val(d.points),c.updateCriterionPoints(b(this).parents(".criterion"),!0)}),b("#edit_rubric_form .rubric_custom_rating").change(function(){b(this).parents(".rubric").find("tr.criterion").find(".ratings").showIf(!b(this).attr("checked")).end().find(".custom_ratings").showIf(b(this).attr("checked"))}).triggerHandler("change"),b("#edit_rubric_form #totalling_rubric").change(function(){b(this).parents(".rubric").find(".total_points_holder").showIf(!b(this).attr("checked"))}),b("#edit_rubric_form .grading_rubric_checkbox").change(function(){b(this).parents(".rubric").find(".totalling_rubric").css("visibility",b(this).attr("checked")?"hidden":"visible"),b(this).parents(".rubric").find(".totalling_rubric_checkbox").attr("checked",!1)}).triggerHandler("change"),b("#criterion_blank").find(".criterion_points").val("5"),b("#default_rubric").find(".criterion").length<=1&&c.addCriterion(b("#default_rubric")),setInterval(c.sizeRatings,1e4)})})