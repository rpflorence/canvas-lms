define(["require","INST","jquery","instructure-jquery.ui.draggable-patch","jquery.instructure_jquery_patches","jquery.instructure_misc_helpers","jquery.instructure_misc_plugins","vendor/jquery.scrollTo","vendor/scribd.view"],function(a,b,c){function e(){this._textareas={},this._editors={},this._editor_boxes={}}function g(a,b){var d=c("#"+a+"_ifr");if(d.length){var e=c(window).height()-(d.offset().top+b.height()+1);d.height(e)}c("#"+a+"_tbl").css("height","")}function h(a,e,h,i,j){j=c.extend({},j),j.fullHeight&&c(window).resize(function(){g(a,j.elementToLeaveInViewport)}).triggerHandler("resize");var k=c("#"+a);k.data("enable_bookmarking",d);var l=c("#"+a).width();l==0&&(l=c("#"+a).closest(":visible").width());var m=",instructure_embed,instructure_equation";for(var n in b.editorButtons)b.editorButtons.length<=b.maxVisibleEditorButtons||n<b.maxVisibleEditorButtons-1?m=m+",instructure_external_button_"+b.editorButtons[n].id:m.match(/instructure_external_button_clump/)||(m+=",instructure_external_button_clump");b&&b.allowMediaComments&&(m+=",instructure_record");var o=b&&b.equellaEnabled?",instructure_equella":"";m+=o;var p="bold,italic,underline,forecolor,backcolor,removeformat,sepleft,separator,justifyleft,justifycenter,justifyright,sepleft,separator,bullist,outdent,indent,numlist,sepleft,separator,table,instructure_links,unlink"+m+",|,fontsizeselect,formatselect",q="",r="";l<460&&l>0?(p="bold,italic,underline,forecolor,backcolor,removeformat,sepleft,separator,justifyleft,justifycenter,justifyright",q="outdent,indent,bullist,numlist,sepleft,separator,table,instructure_links,unlink"+m,r="fontsizeselect,formatselect"):l<860&&(p="bold,italic,underline,forecolor,backcolor,removeformat,sepleft,separator,justifyleft,justifycenter,justifyright,sepleft,separator,outdent,indent,bullist,numlist",q="table,instructure_links,unlink"+m+",|,fontsizeselect,formatselect");var s=!0,t="/javascripts/tinymce/jscripts/tiny_mce/themes/advanced/skins/default/ui.css";s&&(t+=",/stylesheets/compiled/tiny_like_ck.css"),tinyMCE.init({mode:"exact",elements:a,theme:"advanced",plugins:"instructure_external_tools,instructure_contextmenu,instructure_links,instructure_embed,instructure_equation,instructure_record,instructure_equella,media,paste,table,inlinepopups",dialog_type:"modal",relative_urls:!1,remove_script_host:!0,theme_advanced_buttons1:p,theme_advanced_toolbar_location:"top",theme_advanced_buttons2:q,theme_advanced_buttons3:r,theme_advanced_resize_horizontal:!1,theme_advanced_resizing:!0,theme_advanced_fonts:'Andale Mono=andale mono,times;Arial=arial,helvetica,sans-serif;Arial Black=arial black,avant garde;Book Antiqua=book antiqua,palatino;Comic Sans MS=comic sans ms,sans-serif;Courier New=courier new,courier;Georgia=georgia,palatino;Helvetica=helvetica;Impact=impact,chicago;Myriad="Myriad Pro",Myriad,Arial,sans-serif;Symbol=symbol;Tahoma=tahoma,arial,helvetica,sans-serif;Terminal=terminal,monaco;Times New Roman=times new roman,times;Trebuchet MS=trebuchet ms,geneva;Verdana=verdana,geneva;Webdings=webdings;Wingdings=wingdings,zapf dingbats;',theme_advanced_blockformats:"p,h2,h3,h4,pre",theme_advanced_more_colors:!1,extended_valid_elements:"iframe[src|width|height|name|align|style|class]",content_css:"/stylesheets/compiled/instructure_style.css,/stylesheets/compiled/tinymce.editor_box.css",editor_css:t,handle_event_callback:function(b){if(b.type.indexOf("keydown")===0||b.type.indexOf("keypress")===0)if(b.keyCode===9){if(b.shiftKey){b.preventDefault();var d=c("#"+a),e=d.closest("form,#main").find(":tabbable,#"+a);n=e.index(d),d.filter(":visible").length>0?c(e.eq(n-1)).focus():c(e.eq(n+1)).focus()}}else c("#"+a).triggerHandler(b.type,c.event.fix(b))},onchange_callback:function(b){c("#"+a).trigger("change")},setup:function(b){var e=function(){c(document).triggerHandler("editor_box_focus",c("#"+b.editorId))};b.onClick.add(e),b.onKeyPress.add(e),b.onActivate.add(e),b.onEvent.add(function(){d&&b.selection&&k.data("last_bookmark",b.selection.getBookmark(1))}),b.onInit.add(function(){c(window).triggerHandler("resize"),c(b.contentDocument).bind("DOMNodeInserted",function(a){var b=a.target,d;b.nodeType===1&&b.nodeName==="IMG"&&(d=c(b).data("url"))&&c(b).attr("src",tinyMCE.activeEditor.documentBaseURI.toAbsolute(d))}),s&&c("#"+b.editorId+"_tbl").find("td.mceToolbar span.mceSeparator").parent().each(function(){c(this).after("<td class='mceSeparatorLeft'><span/></td>").after("<td class='mceSeparatorMiddle'><span/></td>").after("<td class='mceSeparatorRight'><span/></td>").remove()});if(!j.unresizable)var d=c("#"+a+"_ifr"),e=d.closest(".mceEditor"),f,g,h,i=j.minHeight||200,k=c('<div class="editor_box_resizer" unselectable="on"><div class="ui-icon ui-icon-grip-diagonal-se" unselectable="on"></div></div>').appendTo(d.parent()).draggable({axis:"y",instructureHackToNotAutoSizeTop:!0,containment:[0,d.offset().top+i,9999999,9999999],start:function(){h=e.css("overflow"),e.css("overflow","hidden"),f=d.offset().top,k.draggable("option","containment",[0,f+i,9999999,9999999]),g=c('<div style="position: absolute; width: 100%; height: 100%; top: 0; left: 0;"></div>').appendTo(k.parent())},drag:function(a,b){k.removeAttr("style"),d.height(b.offset.top-f)},stop:function(a,b){g.remove(),e.css("overflow",h),k.removeAttr("style"),d.height(b.offset.top-f)}})})}}),this._textarea=c("#"+a),this._editor=null,this._id=a,this._searchURL=e,this._submitURL=h,this._contentURL=i,f._addEditorBox(a,this),c("#"+a).bind("blur change",function(){f._getEditor(a)&&f._getEditor(a).isHidden()&&c(this).editorBox("set_code",f._getTextArea(a).val())})}function l(){c(window).blur(function(a){document.activeElement&&window==a.target&&!k&&(k=!0,c(document.activeElement).filter(":input").blur().change(),k=!1)}).focus(function(a){document.activeElement&&window==a.target&&!j&&(j=!0,c(document.activeElement).filter(":input").focus(),j=!1)})}var d=c("body").hasClass("ie");c(document).ready(function(){d=c("body").hasClass("ie")}),c.extend(e.prototype,{_addEditorBox:function(a,b){this._editor_boxes[a]=b,this._editors[a]=tinyMCE.get(a),this._textareas[a]=c("textarea#"+a)},_removeEditorBox:function(a){delete this._editor_boxes[a],delete this._editors[a],delete this._textareas[a]},_getTextArea:function(a){return this._textareas[a]||(this._textareas[a]=c("textarea#"+a)),this._textareas[a]},_getEditor:function(a){return this._editors[a]||(this._editors[a]=tinyMCE.get(a)),this._editors[a]},_getEditorBox:function(a){return this._editor_boxes[a]}});var f=new e,i={getSelection:function(){var a=this.jquery?this[0]:this;return("selectionStart"in a&&function(){var b=a.selectionEnd-a.selectionStart;return{start:a.selectionStart,end:a.selectionEnd,length:b,text:a.value.substr(a.selectionStart,b)}}||document.selection&&function(){a.focus();var b=document.selection.createRange();if(b==null)return{start:0,end:a.value.length,length:0};var c=a.createTextRange(),d=c.duplicate();return c.moveToBookmark(b.getBookmark()),d.setEndPoint("EndToStart",c),{start:d.text.length,end:d.text.length+b.text.length,length:b.text.length,text:b.text}}||function(){return{start:0,end:a.value.length,length:0}})()},replaceSelection:function(){var a=this.jquery?this[0]:this,b=arguments[0]||"";return("selectionStart"in a&&function(){return a.value=a.value.substr(0,a.selectionStart)+b+a.value.substr(a.selectionEnd,a.value.length),this}||document.selection&&function(){return a.focus(),document.selection.createRange().text=b,this}||function(){return a.value+=b,this})()}};jQuery.each(i,function(a){jQuery.fn[a]=this});var j=!1,k=!1,m=1;c.fn.editorBox=function(a,b){var d=arguments;if(this.length>1)return this.each(function(){var a=c(this);a.editorBox.apply(a,d)});m===1&&l();var e=this.attr("id");if(typeof a=="string"&&a!="create"){if(a=="get_code")return this._getContentCode(b);if(a=="set_code")this._setContentCode(b);else if(a=="insert_code")this._insertHTML(b);else{if(a=="selection_offset")return this._getSelectionOffset();if(a=="selection_link")return this._getSelectionLink();if(a=="create_link")this._linkSelection(b);else{if(a=="focus")return this._editorFocus(b);if(a=="toggle")this._toggleView();else{if(a=="execute"){var g=[];for(var i=1;i<arguments.length;i++)g.push(arguments[i]);return c.fn._execCommand.apply(this,g)}a=="destroy"&&this._removeEditor(b)}}}return this}this.data("rich_text",!0),e||(e="editor_box_unique_id_"+m++,this.attr("id",e));if(f._getEditor(e))return this._setContentCode(this.val()),this;var j="";a&&a.search_url&&(j=a.search_url);var k=new h(e,j,"","",a);return this},c.fn._execCommand=function(){var a=c(this).attr("id"),b=f._getEditor(a);b&&b.execCommand&&b.execCommand.apply(b,arguments)},c.fn._justGetCode=function(){var a=this.attr("id")||"",b="";try{f._getEditor(a).isHidden()?b=f._getTextArea(a).val():b=f._getEditor(a).getContent()}catch(c){tinyMCE&&tinyMCE.getInstanceById(a)?b=tinyMCE.getInstanceById(a).getContent():b=this.val()||""}return b},c.fn._getContentCode=function(a){if(a==1){var b=this._justGetCode();this._setContentCode(b)}return this._justGetCode()},c.fn._getSearchURL=function(){return f._getEditorBox(this.attr("id"))._searchURL},c.fn._getSubmitURL=function(){return f._getEditorBox(this.attr("id"))._submitURL},c.fn._getContentURL=function(){return f._getEditorBox(this.attr("id"))._contentURL},c.fn._getSelectionOffset=function(){var a=this.attr("id"),b=f._getEditor(a).getContainer(),d=c(b).find("iframe").offset(),e=f._getEditor(a).selection.getNode(),g=c(e).offset(),h=c(b).scrollTop(),i={left:d.left+g.left+10,top:d.top+g.top+10-h};return i},c.fn._getSelectionNode=function(){var a=this.attr("id"),b=f._getEditor(a).getContainer(),c=f._getEditor(a).selection.getNode();return c},c.fn._getSelectionLink=function(){var a=this.attr("id"),b=tinyMCE.get(a).selection.getNode();while(b.nodeName!="A"&&b.nodeName!="BODY"&&b.parentNode)b=b.parentNode;if(b.nodeName=="A"){var d=c(b).attr("href"),e=c(b).attr("title");if(!e||e=="")e=d;var f={url:d,title:e};return f}return null},c.fn._toggleView=function(){var a=this.attr("id");this._setContentCode(this._getContentCode()),tinyMCE.execCommand("mceToggleEditor",!1,a)},c.fn._removeEditor=function(){var a=this.attr("id");this.data("rich_text",!1),tinyMCE&&tinyMCE.execCommand&&(tinyMCE.execCommand("mceRemoveControl",!1,a),f._removeEditorBox(a))},c.fn._setContentCode=function(a){var b=this.attr("id");f._getTextArea(b).val(a),tinyMCE.get(b)&&c.isFunction(tinyMCE.get(b).execCommand)&&tinyMCE.get(b).execCommand("mceSetContent",!1,a)},c.fn._insertHTML=function(a){var b=this.attr("id");f._getEditor(b).isHidden()?this.replaceSelection(a):tinyMCE.get(b).execCommand("mceInsertContent",!1,a)},c.fn._editorFocus=function(a){var b=this,c=b.attr("id"),d=f._getEditor(c);return a&&(!d||!d.dom.doc.hasFocus())&&setTimeout(function(){b.editorBox("focus",!0)},50),d?(f._getEditor(c).isHidden()?f._getTextArea(c).focus().select():tinyMCE.execCommand("mceFocus",!1,c),!0):!1},c.fn._linkSelection=function(a){typeof a=="string"&&(a={url:a});var b=a.title,e=a.url||"";e.match(/@/)&&!e.match(/\//)&&!e.match(/^mailto:/)?e="mailto:"+e:!e.match(/^\w+:\/\//)&&!e.match(/^mailto:/)&&!e.match(/^\//)&&(e="http://"+e);var g=a.classes||"",h=a.text||a.title||"Link",i=a.target||null,j=c(this).attr("id");e.indexOf("@")!=-1?(a.file=!1,a.image=!1,e.indexOf("mailto:")!=0&&(e="mailto:"+e)):e.indexOf("/")==-1&&(b=e,e=e.replace(/\s/g,""),e=location.href+e),a.file&&(g+="instructure_file_link "),a.scribdable&&(g+="instructure_scribd_file ");var k="";a.kaltura_entry_id&&a.kaltura_media_type&&(k="media_comment_"+a.kaltura_entry_id,a.kaltura_media_type=="video"?g+="instructure_video_link ":g+="instructure_audio_link "),a.image&&(g+="instructure_image_thumbnail "),g=c.uniq(g.split(/\s+/)).join(" ");var l="";d&&this.data("last_bookmark")&&tinyMCE.get(j).selection.moveToBookmark(this.data("last_bookmark"));var m=tinyMCE.get(j).selection,n=m.getNode();while(n.nodeName!="A"&&n.nodeName!="BODY"&&n.parentNode)n=n.parentNode;n.nodeName!="A"&&(n=null);var o=m.getContent();if(f._getEditor(j).isHidden()){l=h;var p=c("<div><a/></div>");p.find("a")[k?"attr":"removeAttr"]("id",k).attr({title:b,href:e,target:i})[g?"attr":"removeAttr"]("class",g).text(l);var q=p.html();c(this).replaceSelection(q)}else if(!o||o=="")if(n)c(n).attr({href:e,_mce_href:e,title:b||"",id:k,"class":g,target:i});else{l=h;var p=c("<div/>");p.append(c("<a/>",{id:k,target:i,title:b,href:e,"class":g}).text(l)),tinyMCE.get(j).execCommand("mceInsertContent",!1,p.html())}else tinyMCE.get(j).execCommand("mceInsertLink",!1,{target:i||"",title:b||"",href:e,"class":g,id:k});var r=tinyMCE.get(j),s=r.selection.getNode();s.nodeName!="A"&&(s=c(s).children("a:last")[0]);if(s){var t={top:s.offsetTop,left:s.offsetLeft},u=s;while((u=u.offsetParent)&&u.tagName!="BODY")t.top=t.top+u.offsetTop||0,t.left=t.left+u.offsetLeft||0;var v=r.getContainer(),w=c(v).find("iframe").offset(),x=c(r.dom.doc).find("html").scrollTop()||c(r.dom.doc).find("body").scrollTop(),y={left:w.left+t.left,top:w.top+t.top-x};c(s).indicate({offset:y,singleFlash:!0,scroll:!0,container:c(v).find("iframe")})}}})