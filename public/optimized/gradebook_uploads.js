require(["i18n","jquery","str/htmlEscape","vendor/slickgrid-googlecode/slick.editors","vendor/slickgrid-googlecode/slick.grid","jquery.instructure_forms","jquery.instructure_misc_helpers","jquery.templateData","vendor/underscore"],function(a,b,c){return a=a.scoped("gradebook"),{init:function(){var d,e=b.extend(!0,{},originalGradebook),f=b("#gradebook_grid"),g={columns:[{id:"student",name:a.t("student","Student"),field:"student",width:250,cssClass:"cell-title",editor:StudentNameEditor,validator:requiredFieldValidator,formatter:StudentNameFormatter}],options:{enableAddRow:!1,enableColumnReorder:!1,asyncEditorLoading:!0},data:[]};b.each(e.assignments,function(){g.columns.push({id:this.id,name:c(this.title),field:this.id,width:200,editor:NullGradeEditor,formatter:simpleGradeCellFormatter,_original:this})}),b.each(e.students,function(){var a={student:this,id:this.id,_original:this};b.each(this.submissions,function(){a[this.assignment_id]=this,a[this.assignment_id]._original=b.extend({},this)}),g.data.push(a)}),b.each(uploadedGradebook.assignments,function(){var a,b=this;this.original_id?(a=_.detect(g.columns,function(a){return a._original&&a._original.id==b.original_id}),a.cssClass="active changed"):(a={id:b.id,name:c(b.title),field:b.id,formatter:simpleGradeCellFormatter,cssClass:"active new"},g.columns.push(a)),a.editor=GradeCellEditor,a.active=!0,a._uploaded=b,a.setValueHandler=function(a,b,c){if(c[b.id])c[b.id].grade=c[b.id]._uploaded.grade=a;else{var d={grade:a,assignment_id:b.id};d._uploaded=d;var e=c._uploaded.submissions.push(d);c[b.id]=c._uploaded.submissions[e-1]}}}),b.each(uploadedGradebook.students,function(){var a,c=this;c.original_id?a=_.detect(g.data,function(a){return a._original&&a._original.id==c.original_id}):(a={id:c.id,student:c},g.data.push(a)),b.each(c.submissions,function(){a[this.assignment_id]=a[this.assignment_id]?b.extend(a[this.assignment_id],this):this,!a[this.assignment_id]._original&&this.grade&&(a[this.assignment_id]._original={score:null}),a[this.assignment_id]._uploaded=this}),a.active=!0,a._uploaded=c});var h=g.columns.length;g.columns=_.select(g.columns,function(a){return a.id==="student"||_.detect(g.data,function(b){return b[a.id]&&b[a.id]._original&&b[a.id]._uploaded&&b[a.id]._original.score!=b[a.id]._uploaded.grade})}),g.columns.length>1?(g.columns.length<h&&b("#assignments_without_changes_alert").show(),b("#gradebook_grid_form").submit(function(a){var c=function(a,c){b.each(["_original","_uploaded"],function(a,d){if(c[d]){var e=b.extend({},c[d]);delete c[d],delete e[d],c[d]=e}})};b.each(uploadedGradebook.students,function(){b.each(this.submissions,c)}),b(this).find("input[name='json_data_to_submit']").val(JSON.stringify(uploadedGradebook))}).show(),b(window).resize(function(){f.height(b(window).height()-f.offset().top-50)}).triggerHandler("resize"),d=new SlickGrid(f,g.data,g.columns,g.options),d.onColumnHeaderClick=function(a){}):b("#no_changes_detected").show()},handleThingsNeedingToBeResolved:function(){var d={},e={};originalGradebook.assignments=originalGradebook.active_assignments,b.each(["student","assignment"],function(a,f){var g=b("#"+f+"_resolution_template").remove(),h=g.find("select");d[f]=[],b.each(uploadedGradebook[f+"s"],function(){this.original_id||d[f].push(this)}),d[f].length&&(h.change(function(){b(this).next(".points_possible_section").css({opacity:0}),b(this).val()>0?(b("#"+f+"_resolution_template select option").removeAttr("disabled"),b("#"+f+"_resolution_template select").each(function(){b("#"+f+"_resolution_template select").not(this).find("option[value='"+b(this).val()+"']").attr("disabled",!0)})):b(this).val()==="new"&&b(this).next(".points_possible_section").css({opacity:1})}),e[f]=_.reject(originalGradebook[f+"s"],function(a){return _.detect(uploadedGradebook[f+"s"],function(b){return b.original_id==a.id})}),b.each(e[f],function(){b('<option value="'+this.id+'" >'+c(this.name||this.title)+"</option>").appendTo(h)}),b.each(d[f],function(a,c){g.clone(!0).fillTemplateData({iterator:c.id,data:{name:c.name,title:c.title,points_possible:c.points_possible}}).appendTo("#gradebook_importer_resolution_section ."+f+"_section table tbody").show().find("input.points_possible").change(function(){c.points_possible=b(this).val()})}),b("#gradebook_importer_resolution_section, #gradebook_importer_resolution_section ."+f+"_section").show())}),d.student.length||d.assignment.length?b("#gradebook_importer_resolution_section").submit(function(c){var d=!1;c.preventDefault(),b(this).find("select").each(function(){if(!b(this).val())return d=!0,b(this).errorBox(a.t("errors.select_an_option","Please select an option")),!1});if(d)return!1;b(this).find("select").each(function(){var a=b(this),c=a.attr("name").split("_"),d=c[0],e=c[1],f=a.val();switch(f){case"new":break;case"ignore":for(var g in uploadedGradebook[d+"s"])if(e==uploadedGradebook[d+"s"][g].id){uploadedGradebook[d+"s"].splice(g,1);break}break;default:_.detect(uploadedGradebook[d+"s"],function(a){return e==a.id}).original_id=f}}),b(this).hide(),GradebookUploader.init()}):GradebookUploader.init()}}})