(function(){var a=function(a,b){return function(){return a.apply(b,arguments)}};define("compiled/calendar/Scheduler",["i18n","jst/calendar/appointmentGroupList","jst/calendar/schedulerRightSideAdminSection","compiled/calendar/EditAppointmentGroupDialog","jst/calendar/deleteItem"],function(b,c,d,e,f){var g;return b=b.scoped("calendar"),g=function(){function g(b,c){this.calendar=c,this.deleteLinkClick=a(this.deleteLinkClick,this),this.editLinkClick=a(this.editLinkClick,this),this.showList=a(this.showList,this),this.doneClick=a(this.doneClick,this),this.viewCalendarForGroup=a(this.viewCalendarForGroup,this),this.viewCalendarForGroupId=a(this.viewCalendarForGroupId,this),this.viewCalendarForElement=a(this.viewCalendarForElement,this),this.showEventLinkClick=a(this.showEventLinkClick,this),this.viewCalendarLinkClick=a(this.viewCalendarLinkClick,this),this.redraw=a(this.redraw,this),this.loadData=a(this.loadData,this),this.canManageAGroup=a(this.canManageAGroup,this),this.hide=a(this.hide,this),this.show=a(this.show,this),this.eventDeleted=a(this.eventDeleted,this),this.eventSaved=a(this.eventSaved,this),this.dialogCloseCB=a(this.dialogCloseCB,this),this.createClick=a(this.createClick,this),this.div=$(b),this.contexts=this.calendar.contexts,this.listDiv=this.div.find(".appointment-list"),this.div.delegate(".single_item_done_button","click",this.doneClick),this.div.delegate(".view_calendar_link","click",this.viewCalendarLinkClick),this.listDiv.delegate(".edit_link","click",this.editLinkClick),this.listDiv.delegate(".delete_link","click",this.deleteLinkClick),this.listDiv.delegate(".show_event_link","click",this.showEventLinkClick),this.canManageAGroup()&&(this.div.addClass("can-manage"),this.rightSideAdminSection=$(d()),this.rightSideAdminSection.find(".create_link").click(this.createClick)),$.subscribe("CommonEvent/eventSaved",this.eventSaved),$.subscribe("CommonEvent/eventDeleted",this.eventDeleted)}return g.prototype.createClick=function(a){var b;return a.preventDefault(),b={contexts:this.calendar.contexts},this.createDialog=new e(b,this.dialogCloseCB),this.createDialog.show()},g.prototype.dialogCloseCB=function(a){if(a)return this.calendar.dataSource.clearCache(),this.loadData()},g.prototype.eventSaved=function(a){if(this.active)return this.calendar.dataSource.clearCache(),this.loadData()},g.prototype.eventDeleted=function(a){if(this.active)return this.calendar.dataSource.clearCache(),this.loadData()},g.prototype.toggleListMode=function(a){var b;return a?(delete this.viewingGroup,this.calendar.updateFragment({appointment_group_id:null}),this.showList(),this.canManageAGroup()?($("#right-side .rs-section").hide(),this.rightSideAdminSection.appendTo("#right-side")):$("#right-side-wrapper").hide()):($("#right-side-wrapper").show(),$("#right-side .rs-section").not("#undated-events, #calendar-feed").show(),(b=this.rightSideAdminSection)!=null?b.detach():void 0)},g.prototype.show=function(){return $("#undated-events, #calendar-feed").hide(),this.active=!0,this.div.show(),this.loadData(),this.toggleListMode(!0),$.publish("Calendar/saveVisibleContextListAndClear")},g.prototype.hide=function(){return $("#undated-events, #calendar-feed").show(),this.active=!1,this.div.hide(),this.toggleListMode(!1),this.calendar.displayAppointmentEvents=null,$.publish("Calendar/restoreVisibleContextList")},g.prototype.canManageAGroup=function(){var a,b,c,d;d=this.contexts;for(b=0,c=d.length;b<c;b++){a=d[b];if(a.can_create_appointment_groups)return!0}return!1},g.prototype.loadData=function(){var b;if(!this.loadingDeferred||this.loadingDeferred&&!this.loadingDeferred.isResolved())this.loadingDeferred=new $.Deferred;return this.groups={},(b=this.loadingDiv)==null&&(this.loadingDiv=$('<div id="scheduler-loading" />').appendTo(this.div).spin()),this.calendar.dataSource.getAppointmentGroups(this.canManageAGroup(),a(function(a){var b,c,d;for(c=0,d=a.length;c<d;c++)b=a[c],this.groups[b.id]=b;return this.redraw(),this.loadingDeferred.resolve()},this))},g.prototype.redraw=function(){var a,b,d,e,f,g,h,i,j,k,l,m,n,o,p,q,r,s,t,u,v;this.loadingDiv.hide();if(this.groups){f=[],q=this.groups;for(h in q){e=q[h],e.signed_up_times=null;if(e.appointmentEvents){r=e.appointmentEvents;for(i=0,m=r.length;i<m;i++){a=r[i];if(a.object.reserved){s=a.childEvents;for(j=0,n=s.length;j<n;j++)b=s[j],b.object.own_reservation&&((t=e.signed_up_times)==null&&(e.signed_up_times=[]),e.signed_up_times.push({id:b.id,formatted_time:b.displayTimeString()}))}}}e.signed_up=0;if(e.appointmentEvents){u=e.appointmentEvents;for(k=0,o=u.length;k<o;k++)a=u[k],a.childEvents&&(e.signed_up+=a.childEvents.length)}v=this.contexts;for(l=0,p=v.length;l<p;l++)d=v[l],d.asset_string===e.context_code&&(e.context=d);f.push(e)}g=c({appointment_groups:f,canManageAGroup:this.canManageAGroup()}),this.listDiv.find(".list-wrapper").html(g),this.viewingGroup&&(this.viewingGroup=this.groups[this.viewingGroup.id],this.viewingGroup?(this.listDiv.find(".appointment-group-item[data-appointment-group-id='"+this.viewingGroup.id+"']").addClass("active"),this.calendar.displayAppointmentEvents=this.viewingGroup):this.toggleListMode(!0))}return $.publish("Calendar/refetchEvents")},g.prototype.viewCalendarLinkClick=function(a){return a.preventDefault(),this.viewCalendarForElement($(a.target))},g.prototype.showEventLinkClick=function(a){var b,c,d,e,f,g,h,i,j,k;a.preventDefault(),e=this.viewCalendarForElement($(a.target)),d=$(a.target).data("event-id");if(d){j=e.object.appointmentEvents;for(f=0,h=j.length;f<h;f++){b=j[f],k=b.object.childEvents;for(g=0,i=k.length;g<i;g++){c=k[g];if(c.id===d){this.calendar.gotoDate(c.start);return}}}}},g.prototype.viewCalendarForElement=function(a){var b,c,d,e,f;return d=a.closest(".appointment-group-item"),c=d.data("appointment-group-id"),d.addClass("active"),b=(e=this.groups)!=null?e[c]:void 0,this.viewCalendarForGroup((f=this.groups)!=null?f[c]:void 0),b},g.prototype.viewCalendarForGroupId=function(b){return this.loadData(),this.loadingDeferred.done(a(function(){var a;return this.viewCalendarForGroup((a=this.groups)!=null?a[b]:void 0)},this))},g.prototype.viewCalendarForGroup=function(b){return this.calendar.updateFragment({appointment_group_id:b.id}),this.toggleListMode(!1),this.viewingGroup=b,this.loadingDeferred.done(a(function(){return this.div.addClass("showing-single"),this.calendar.calendar.show(),this.calendar.calendar.fullCalendar("changeView","agendaWeek"),this.viewingGroup.start_at?this.calendar.gotoDate($.parseFromISO(this.viewingGroup.start_at).time):this.calendar.gotoDate(new Date),this.calendar.displayAppointmentEvents=this.viewingGroup,$.publish("Calendar/refetchEvents")},this))},g.prototype.doneClick=function(a){return a.preventDefault(),this.toggleListMode(!0)},g.prototype.showList=function(){return this.div.removeClass("showing-single"),this.listDiv.find(".appointment-group-item").removeClass("active"),this.calendar.calendar.hide(),this.calendar.displayAppointmentEvents=null},g.prototype.editLinkClick=function(a){var b,c;a.preventDefault(),b=(c=this.groups)!=null?c[$(a.target).closest(".appointment-group-item").data("appointment-group-id")]:void 0;if(!b)return;return b.contexts=this.calendar.contexts,this.createDialog=new e(b,this.dialogCloseCB),this.createDialog.show()},g.prototype.deleteLinkClick=function(c){var d,e;c.preventDefault(),d=(e=this.groups)!=null?e[$(c.target).closest(".appointment-group-item").data("appointment-group-id")]:void 0;if(!d)return;return $("<div />").confirmDelete({url:d.url,message:$(f({message:b.t("confirm_appointment_group_deletion","Are you sure you want to delete this appointment group?"),details:b.t("appointment_group_deletion_details","Deleting it will also delete any appointments that have been signed up for by students.")})),dialog:{title:b.t("confirm_deletion","Confirm Deletion")},prepareData:a(function(a){return{cancel_reason:a.find("#cancel_reason").val()}},this),confirmed:a(function(){return $(c.target).closest(".appointment-group-item").addClass("event_pending")},this),success:a(function(){return this.calendar.dataSource.clearCache(),this.loadData()},this)})},g}()})}).call(this)