(function(){var a=function(a,b){return function(){return a.apply(b,arguments)}};define("compiled/calendar/EventDataSource",["compiled/calendar/commonEventFactory"],function(b){return function(){function c(b){this.fetchNextBatch=a(this.fetchNextBatch,this),this.startFetch=a(this.startFetch,this),this.getEvents=a(this.getEvents,this),this.getEventsForAppointmentGroup=a(this.getEventsForAppointmentGroup,this),this.processAppointmentData=a(this.processAppointmentData,this),this.getAppointmentGroups=a(this.getAppointmentGroups,this),this.getAppointmentGroupsFromCache=a(this.getAppointmentGroupsFromCache,this),this.getEventsFromCache=a(this.getEventsFromCache,this),this.processNextRequest=a(this.processNextRequest,this),this.getEventsFromCacheForContext=a(this.getEventsFromCacheForContext,this),this.addEventToCache=a(this.addEventToCache,this),this.needUndatedEventsForContexts=a(this.needUndatedEventsForContexts,this),this.requiredDateRangeForContexts=a(this.requiredDateRangeForContexts,this),this.requiredDateRangeForContext=a(this.requiredDateRangeForContext,this),this.clearCache=a(this.clearCache,this),this.eventWithId=a(this.eventWithId,this),this.eventDeleted=a(this.eventDeleted,this),this.eventSaved=a(this.eventSaved,this),this.contexts=b,this.clearCache(),this.inFlightRequest=!1,this.pendingRequests=[],$.subscribe("CommonEvent/eventDeleted",this.eventDeleted),$.subscribe("CommonEvent/eventSaved",this.eventSaved)}return c.prototype.eventSaved=function(a){return this.addEventToCache(a)},c.prototype.eventDeleted=function(a){var b,c;b=(c=this.cache.contexts[a.contextCode()])!=null?c.events:void 0;if(b)return delete b[a.id]},c.prototype.eventWithId=function(a){var b,c,d;d=this.cache.contexts;for(b in d){c=d[b];if(c.events[a])return c.events[a]}return null},c.prototype.clearCache=function(){var a,b,c,d,e;this.cache={contexts:{},appointmentGroups:{},fetchedAppointmentGroups:null},d=this.contexts,e=[];for(b=0,c=d.length;b<c;b++)a=d[b],e.push(this.cache.contexts[a.asset_string]={events:{},fetchedRanges:[],fetchedUndated:!1});return e},c.prototype.requiredDateRangeForContext=function(a,b,c){var d,e,f,g,h;if(!(d=this.cache.contexts[c]))return[a,b];if(!(f=d.fetchedRanges))return[a,b];for(g=0,h=f.length;g<h;g++)e=f[g],e[0]<=a&&a<=e[1]&&(a=e[1]),e[0]<=b&&b<=e[1]&&(b=e[0]);return[a,b]},c.prototype.requiredDateRangeForContexts=function(a,b,c){var d,e,f,g,h,i,j,k;f=b,g=a;for(i=0,j=c.length;i<j;i++)d=c[i],k=this.requiredDateRangeForContext(a,b,d),h=k[0],e=k[1],h<f&&(f=h),e>g&&(g=e);return[f,g]},c.prototype.needUndatedEventsForContexts=function(a){var b,c,d;for(c=0,d=a.length;c<d;c++){b=a[c];if(!this.cache.contexts[b].fetchedUndated)return!0}return!1},c.prototype.addEventToCache=function(a){var b,c;return b=a.contextCode(),c=this.cache.contexts[b],c.events[a.id]=a},c.prototype.getEventsFromCacheForContext=function(a,b,c){var d,e,f,g,h;d=this.cache.contexts[c],f=[],h=d.events;for(g in h)e=h[g],(!e.start&&!a||e.start>=a&&e.start<=b)&&f.push(e);return f},c.prototype.processNextRequest=function(){var a,b,c;c=this.pendingRequests.shift();if(c)return b=c[0],a=c[1],b.apply(null,a)},c.prototype.getEventsFromCache=function(a,b,c){var d,e,f,g;e=[];for(f=0,g=c.length;f<g;f++)d=c[f],e=e.concat(this.getEventsFromCacheForContext(a,b,d));return e},c.prototype.getAppointmentGroupsFromCache=function(){var a,b,c,d;c=this.cache.appointmentGroups,d=[];for(b in c)a=c[b],d.push(a);return d},c.prototype.getAppointmentGroups=function(b,c){var d,e,f;if(this.inFlightRequest){this.pendingRequests.push([this.getAppointmentGroups,arguments]);return}if(this.cache.fetchedAppointmentGroups&&this.cache.fetchedAppointmentGroups.manageable===b){c(this.getAppointmentGroupsFromCache()),this.processNextRequest();return}return this.cache.fetchedAppointmentGroups={manageable:b},this.cache.appointmentGroups={},d=a(function(a,b,c){var d,e,f,g;if(a){g=[];for(e=0,f=a.length;e<f;e++)d=a[e],c.scope==="manageable"?d.is_manageable=!0:d.is_scheduleable=!0,g.push(this.processAppointmentData(d));return g}},this),e=a(function(){return c(this.getAppointmentGroupsFromCache())},this),f=[["/api/v1/appointment_groups",{include:["appointments","child_events"]}]],b&&f.push(["/api/v1/appointment_groups",{scope:"manageable",include:["appointments","child_events"]}]),this.startFetch(f,d,e)},c.prototype.processAppointmentData=function(a){var c,d,e,f,g,h,i,j,k;g=a.id,this.cache.appointmentGroups[g]=a;if(a.appointments){a.appointmentEvents=[],j=a.appointments,k=[];for(h=0,i=j.length;h<i;h++)f=j[h],e=b(f,this.contexts),k.push(function(){var g,h,i,j;if(e&&e.object.workflow_state!=="deleted"){a.appointmentEvents.push(e),this.addEventToCache(e);if(f.child_events){e.childEvents=[],i=f.child_events,j=[];for(g=0,h=i.length;g<h;g++)d=i[g],c=b(d,this.contexts),this.addEventToCache(e),j.push(e.childEvents.push(c));return j}}}.call(this));return k}},c.prototype.getEventsForAppointmentGroup=function(b,c){var d,e;if(this.inFlightRequest){this.pendingRequests.push([this.getEventsForAppointmentGroup,arguments]);return}if(b.appointmentEvents){c(b.appointmentEvents),this.processNextRequest();return}return d=a(function(a){if(a)return this.processAppointmentData(a)},this),e={include:["appointments","child_events"]},this.startFetch([[b.url,e]],d,a(function(){return c(b.appointmentEvents)},this))},c.prototype.getEvents=function(c,d,e,f){var g,h,i,j,k,l,m,n,o;if(this.inFlightRequest){this.pendingRequests.push([this.getEvents,arguments]);return}l=a(function(a,b,c){var d,e,f;return f=this.requiredDateRangeForContexts(a,b,c),e=f[0],d=f[1],e<d?{context_codes:c,start_date:$.dateToISO8601UTC(e),end_date:$.dateToISO8601UTC(d)}:null},this),m=a(function(a){return this.needUndatedEventsForContexts(a)?{context_codes:a,undated:"1"}:null},this),k=c?l(c,d,e):m(e);if(!k){f(this.getEventsFromCache(c,d,e)),this.processNextRequest();return}for(n=0,o=e.length;n<o;n++)g=e[n],h=this.cache.contexts[g],h&&(c?h.fetchedRanges.push([c,d]):h.fetchedUndated=!0);return j=a(function(){return f(this.getEventsFromCache(c,d,e))},this),i=a(function(a){var c,d,e,f,g;if(a){g=[];for(e=0,f=a.length;e<f;e++)c=a[e],d=b(c,this.contexts),g.push(d&&d.object.workflow_state!=="deleted"?this.addEventToCache(d):void 0);return g}},this),this.startFetch([["/api/v1/calendar_events",k],["/api/v1/calendar_events",$.extend({type:"assignment"},k)]],i,j)},c.prototype.startFetch=function(b,c,d){var e,f,g,h,i,j;e=0,this.inFlightRequest=!0,g=a(function(a,f,g,h){c(a,g,h);if(f){e+=1;if(e>=b.length)return d(),this.inFlightRequest=!1,this.processNextRequest()}},this),j=[];for(h=0,i=b.length;h<i;h++)f=b[h],j.push(a(function(a){return this.fetchNextBatch(a[0],a[1],function(b,c){return g(b,c,a[0],a[1])})},this)(f));return j},c.prototype.fetchNextBatch=function(b,c,d){var e;return e=function(a){var b,c,d,e,f,g,h,i;if(!a)return null;e={},h=a.split(",");for(f=0,g=h.length;f<g;f++)b=h[f],i=b.split(";"),c=i[0],d=i[1],c=c.replace(/^</,"").replace(/>$/,""),d=d.split('"')[1],e[d]=c;return e},$.publish("EventDataSource/ajaxStarted"),c.per_page=50,$.ajaxJSON(b,"GET",c,a(function(a,b){var f,g;$.publish("EventDataSource/ajaxEnded"),f=typeof b.getResponseHeader=="function"?b.getResponseHeader("Link"):void 0,g=e(f);if(g!=null?g.next:void 0){d(a,!1),this.fetchNextBatch(g.next,c,d);return}return d(a,!0)},this))},c}()})}).call(this)