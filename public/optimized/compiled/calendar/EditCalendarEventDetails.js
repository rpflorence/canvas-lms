(function(){var a=function(a,b){return function(){return a.apply(b,arguments)}};define("compiled/calendar/EditCalendarEventDetails",["i18n","compiled/calendar/commonEventFactory","compiled/calendar/TimeBlockList","jst/calendar/editCalendarEvent","jst/calendar/genericSelect"],function(b,c,d,e,f){var g;return g=function(){function b(b,c,d,f){this.event=c,this.contextChangeCB=d,this.closeCB=f,this.formSubmit=a(this.formSubmit,this),this.setupTimeAndDatePickers=a(this.setupTimeAndDatePickers,this),this.contextChange=a(this.contextChange,this),this.setContext=a(this.setContext,this),this.moreOptionsClick=a(this.moreOptionsClick,this),this.activate=a(this.activate,this),this.currentContextInfo=null,this.form=$(e({title:this.event.title,contexts:this.event.possibleContexts()})),$(b).append(this.form),this.setupTimeAndDatePickers(),this.form.submit(this.formSubmit),this.form.find(".more_options_link").click(this.moreOptionsClick),this.form.find("select.context_id").change(this.contextChange),this.form.find("select.context_id").triggerHandler("change",!1),this.event.isNewEvent()||(this.form.find(".context_select").hide(),this.form.attr("method","PUT"),this.form.attr("action",$.replaceTags(this.event.contextInfo.calendar_event_url,"id",this.event.object.id)))}return b.prototype.contextInfoForCode=function(a){var b,c,d,e;e=this.event.possibleContexts();for(c=0,d=e.length;c<d;c++){b=e[c];if(b.asset_string===a)return b}return null},b.prototype.activate=function(){return this.form.find("select.context_id").change()},b.prototype.moreOptionsClick=function(a){var b,c,d;return a.preventDefault(),d=$(event.target).attr("href").split("#"),b=$("#edit_calendar_event_form").getFormData({object_name:"calendar_event"}),c={},b.title&&(c.title=b.title),b.date&&(c.start_at=""+b.date+" "+(b.start_time||""),c.end_at=""+b.date+" "+(b.end_time||"")),c.return_to=window.location.href,d[0]+="?"+$.param(c),window.location.href=d.join("#")},b.prototype.setContext=function(a){return this.form.find("select.context_id").val(a).triggerHandler("change",!1)},b.prototype.contextChange=function(a,b){var c;c=$(a.target).val(),this.currentContextInfo=this.contextInfoForCode(c),this.event.contextInfo=this.currentContextInfo;if(this.currentContextInfo===null)return;return b!==!1&&this.contextChangeCB(c),this.form.attr("action",this.currentContextInfo.create_calendar_event_url),this.form.find(".more_options_link").attr("href",this.currentContextInfo.new_calendar_event_url)},b.prototype.setupTimeAndDatePickers=function(){var b,c;this.form.find(".date_field").date_field(),this.form.find(".time_field").time_field().blur(a(function(a){var b,c,d,e;e=this.form.find(".time_field.start_time").next(".datetime_suggest").text(),this.form.find(".time_field.start_time").next(".datetime_suggest").hasClass("invalid_datetime")&&(e=null),e==null&&(e=this.form.find(".time_field.start_time").val()),c=this.form.find(".time_field.end_time").next(".datetime_suggest").text(),this.form.find(".time_field.end_time").next(".datetime_suggest").hasClass("invalid_datetime")&&(c=null),c==null&&(c=this.form.find(".time_field.end_time").val()),d=Date.parse(e),b=Date.parse(c),d=d||b,b=b||d,$(a.target).hasClass("end_time")?d>b&&(d=b):b<d&&(b=d),d&&this.form.find(".time_field.start_time").val(d.toString("h:mmtt").toLowerCase());if(b)return this.form.find(".time_field.end_time").val(b.toString("h:mmtt").toLowerCase())},this)),c=this.event.startDate(),b=this.event.endDate(),this.event.allDay||(c&&this.form.find(".time_field.start_time").val(c.toString("h:mmtt")).change().blur(),b&&this.form.find(".time_field.end_time").val(b.toString("h:mmtt")).change().blur());if(c)return this.form.find(".date_field").val(c.toString("MMM d, yyyy")).change()},b.prototype.formSubmit=function(a){var b,d,e,f,g,h,i;return a.preventDefault(),b=this.form.getFormData({object_name:"calendar_event"}),b.date?(h=Date.parse(""+b.date+" "+b.start_time),(i=b.end_time)==null&&(b.end_time=b.start_time),d=Date.parse(""+b.date+" "+b.end_time)):(h=null,d=null),g={"calendar_event[title]":b.title,"calendar_event[start_at]":h?$.dateToISO8601UTC($.unfudgeDateForProfileTimezone(h)):"","calendar_event[end_at]":d?$.dateToISO8601UTC($.unfudgeDateForProfileTimezone(d)):""},this.event.isNewEvent()?(f={calendar_event:{title:g["calendar_event[title]"],start_at:h?$.dateToISO8601UTC(h):null,end_at:d?$.dateToISO8601UTC(d):null,context_code:this.form.find(".context_id").val()}},e=c(f,this.event.possibleContexts()),e.save(g)):(this.event.title=g["calendar_event[title]"],this.event.start=h,this.event.end=d,this.event.save(g)),this.closeCB()},b}()})}).call(this)