(function(){var a=function(a,b){return function(){return a.apply(b,arguments)}};define("compiled/calendar/Calendar",["i18n","compiled/util/hsvToRgb","jst/calendar/calendarApp","compiled/calendar/EventDataSource","compiled/calendar/commonEventFactory","compiled/calendar/ShowEventDetailsDialog","compiled/calendar/EditEventDetailsDialog","compiled/calendar/Scheduler"],function(b,c,d,e,f,g,h,i){var j;return b=b.scoped("calendar"),j=function(){function l(c,e,f,g){var h,j,k,l,m,n;this.contexts=e,this.manageContexts=f,this.dataSource=g,this.dataFromDocumentHash=a(this.dataFromDocumentHash,this),this.loadView=a(this.loadView,this),this.refetchEvents=a(this.refetchEvents,this),this.ajaxEnded=a(this.ajaxEnded,this),this.ajaxStarted=a(this.ajaxStarted,this),this.visibleContextListChanged=a(this.visibleContextListChanged,this),this.eventSaveFailed=a(this.eventSaveFailed,this),this.eventSaved=a(this.eventSaved,this),this.eventSaving=a(this.eventSaving,this),this.eventDeleted=a(this.eventDeleted,this),this.eventDeleting=a(this.eventDeleting,this),this.reloadClick=a(this.reloadClick,this),this.fragmentChange=a(this.fragmentChange,this),this.drop=a(this.drop,this),this.viewDisplay=a(this.viewDisplay,this),this.eventResize=a(this.eventResize,this),this.dayClick=a(this.dayClick,this),this.eventClick=a(this.eventClick,this),this.eventDrop=a(this.eventDrop,this),this.eventAfterRender=a(this.eventAfterRender,this),this.eventRender=a(this.eventRender,this),this.getEvents=a(this.getEvents,this),this.contextCodes=function(){var a,b,c;c=[];for(a=0,b=e.length;a<b;a++)h=e[a],c.push(h.asset_string);return c}(),this.visibleContextList=[],this.displayAppointmentEvents=null,this.activeAjax=0,$.subscribe({"CommonEvent/eventDeleting":this.eventDeleting,"CommonEvent/eventDeleted":this.eventDeleted,"CommonEvent/eventSaving":this.eventSaving,"CommonEvent/eventSaved":this.eventSaved,"CommonEvent/eventSaveError":this.eventSaveFailed,"Calendar/visibleContextListChanged":this.visibleContextListChanged,"EventDataSource/ajaxStarted":this.ajaxStarted,"EventDataSource/ajaxEnded":this.ajaxEnded,"Calendar/refetchEvents":this.refetchEvents}),n='\'<span class="agenda-col-wrapper">\n  <span class="day-num">\'d\'</span>\n  <span class="day-and-month">\n    <span class="day-name">\'dddd\'</span><br />\n    <span class="month-name">\'MMM\'</span>\n  </span>\n</span>\'',l={header:{left:"prev,today,next",center:"title",right:""},editable:!0,columnFormat:{month:"dddd",week:n},allDayDefault:!1,buttonText:{today:b.t("today","Today")},defaultEventMinutes:60,weekMode:"variable",slotMinutes:30,firstHour:7,droppable:!0,dropAccept:".undated_event",ignoreTimezone:!0,lazyFetching:!1,events:this.getEvents,eventRender:this.eventRender,eventAfterRender:this.eventAfterRender,eventDrop:this.eventDrop,eventClick:this.eventClick,eventResize:this.eventResize,dayClick:this.dayClick,titleFormat:{week:"MMM d[ yyyy]{ '&ndash;'[ MMM] d, yyyy}"},viewDisplay:this.viewDisplay,drop:this.drop},j=this.dataFromDocumentHash(),j.view_start&&(k=$.fullCalendar.parseISO8601(j.view_start),k&&(l.year=k.getFullYear(),l.month=k.getMonth(),l.date=k.getDate())),this.el=$(c).html(d());if(j.view_name==="month"||j.view_name==="agendaWeek")m=j.view_name==="agendaWeek"?"week":"month",$("#"+m).click(),l.defaultView=j.view_name;j.show&&j.show!==""&&(this.visibleContextList=j.show.split(",")),this.calendar=this.el.find("div.calendar").fullCalendar(l),$(document).fragmentChange(this.fragmentChange),this.el.find("#calendar_views").buttonset().find("input").change(a(function(a){return this.loadView($(a.target).attr("id"))},this)),this.$refresh_calendar_link=this.el.find("#refresh_calendar_link").click(this.reloadClick),this.colorizeContexts(),this.scheduler=new i(".scheduler-wrapper",this),$("html").addClass("calendar-loaded"),this.dataSource.getAppointmentGroups(!1,a(function(a){var b,c,d,e;c=0;for(d=0,e=a.length;d<e;d++)b=a[d],b.requiring_action&&(c+=1);return this.el.find("#calendar-header .counter-badge").toggle(c>0).text(c)},this)),window.setTimeout(a(function(){if(j.view_name==="scheduler"){$("#scheduler").click();if(j.appointment_group_id)return this.scheduler.viewCalendarForGroupId(j.appointment_group_id)}},this))}var e,j,k;return l.prototype.getEvents=function(b,c,d){var e;return e=a(function(a){var b,c,d,e,f,g,h;c={};if(a.length>0){for(d=f=a.length-1;f>0?d>=0:d<=0;f>0?d--:d++)b=a[d],e=!0,c[b.id]?e=!1:b.isAppointmentGroupEvent()&&(this.displayAppointmentEvents?this.displayAppointmentEvents.id===((h=b.calendarEvent)!=null?h.appointment_group_id:void 0)?e=!!b.calendarEvent.reserve_url:e=!b.calendarEvent.reserve_url:b.calendarEvent.reserve_url?((g=b.calendarEvent.child_events)!=null?g.length:void 0)>0&&!b.calendarEvent.reserved?e=!0:e=!1:e=!0),e||a.splice(d,1),c[b.id]=!0;return a}return a},this),this.dataSource.getEvents($.unfudgeDateForProfileTimezone(b),$.unfudgeDateForProfileTimezone(c),this.visibleContextList,a(function(b){return this.displayAppointmentEvents?this.dataSource.getEventsForAppointmentGroup(this.displayAppointmentEvents,a(function(a){var c,f,g,h,i;for(f=0,h=b.length;f<h;f++)c=b[f],c.removeClass("current-appointment-group");for(g=0,i=a.length;g<i;g++)c=a[g],c.addClass("current-appointment-group");return d(e(b.concat(a)))},this)):d(e(b))},this))},l.prototype.eventRender=function(a,b,c){var d;return a.isAppointmentGroupEvent()&&this.displayAppointmentEvents&&this.displayAppointmentEvents.id===a.calendarEvent.appointment_group_id&&(d="Available",a.calendarEvent.available_slots>0&&(d=""+a.calendarEvent.available_slots+" Available"),a.calendarEvent.available_slots===0&&(d="Filled"),a.calendarEvent.reserved===!0&&(d="Reserved"),$(b).find(".fc-event-title").text(d)),!0},l.prototype.eventAfterRender=function(a,b,c){a.eventType==="assignment"&&a.isDueAtMidnight()&&b.find(".fc-event-time").text("12a");if(a.eventType==="assignment"&&c.name==="agendaWeek")return b.height("").find(".ui-resizable-handle").remove()},l.prototype.eventDrop=function(a,b,c,d,e,f,g,h){return a.eventType==="assignment"&&a.isDueAtMidnight()&&c===0&&a.start.setMinutes(59),a.saveDates(null,e)},l.prototype.eventClick=function(a,b,c){return(new g(a)).show(b)},l.prototype.dayClick=function(a,b,c,d){var e;if(this.displayAppointmentEvents)return;return e=f(null,this.contexts),e.allDay=b,e.date=a,(new h(e)).show()},l.prototype.eventResize=function(a,b,c,d,e,f,g){return a.saveDates(null,d)},l.prototype.updateFragment=function(a){var b,c,d;b=this.dataFromDocumentHash();for(c in a)d=a[c],b[c]=d;return location.replace("#"+$.encodeToHex(JSON.stringify(b)))},l.prototype.viewDisplay=function(a){return this.updateFragment({view_start:$.dateToISO8601UTC(a.start)})},l.prototype.drop=function(a,b,c,d){var e,f;e=$(c.target),f=e.data("calendarEvent");if(f)return f.start=a,f.addClass("event_pending"),this.calendar.fullCalendar("renderEvent",f),f.saveDates(null,function(){return console.log("could not save date on undated event")})},l.prototype.fragmentChange=function(a,b){var c,d,e,f;c=this.dataFromDocumentHash(),e=(f=this.calendar)!=null?f.fullCalendar("getView"):void 0;if(!e||!!$.isEmptyObject(c))return;(c.view_name==="month"||c.view_name==="agendaWeek")&&c.view_name!==e.name&&this.calendar.fullCalendar("changeView",c.view_name);if(c.view_start&&c.view_start!==$.dateToISO8601UTC(e.start)){d=$.fullCalendar.parseISO8601(c.view_start);if(d)return this.calendar.fullCalendar("gotoDate",d)}},l.prototype.reloadClick=function(a){a.preventDefault();if(this.activeAjax===0)return this.dataSource.clearCache(),this.currentView==="scheduler"&&this.scheduler.loadData(),this.calendar.fullCalendar("refetchEvents")},l.prototype.eventDeleting=function(a){return a.addClass("event_pending"),this.calendar.fullCalendar("updateEvent",a)},l.prototype.eventDeleted=function(a){return this.calendar.fullCalendar("removeEvents",a.id)},l.prototype.eventSaving=function(a){if(!a.start)return;return a.addClass("event_pending"),a.isNewEvent()?this.calendar.fullCalendar("renderEvent",a):this.calendar.fullCalendar("updateEvent",a)},l.prototype.eventSaved=function(a){return a.removeClass("event_pending"),this.calendar.fullCalendar("refetchEvents")},l.prototype.eventSaveFailed=function(a){return a.removeClass("event_pending"),a.isNewEvent()?this.calendar.fullCalendar("removeEvents",a.id):this.calendar.fullCalendar("updateEvent",a)},l.prototype.visibleContextListChanged=function(a){return this.visibleContextList=a,this.calendar.fullCalendar("refetchEvents")},l.prototype.ajaxStarted=function(){return this.activeAjax+=1,this.$refresh_calendar_link.addClass("loading")},l.prototype.ajaxEnded=function(){this.activeAjax-=1;if(!this.activeAjax)return this.$refresh_calendar_link.removeClass("loading")},l.prototype.refetchEvents=function(){return this.calendar.fullCalendar("refetchEvents")},l.prototype.gotoDate=function(a){return this.calendar.fullCalendar("gotoDate",a)},l.prototype.loadView=function(a){return this.updateFragment({view_name:a}),a!=="scheduler"?(this.currentView=a,this.calendar.removeClass("scheduler-mode"),this.displayAppointmentEvents=null,this.scheduler.hide(),this.calendar.show(),this.calendar.fullCalendar("refetchEvents"),this.calendar.fullCalendar("changeView",a==="week"?"agendaWeek":"month")):(this.currentView="scheduler",this.calendar.addClass("scheduler-mode"),this.calendar.hide(),this.scheduler.show())},e=$("<div />").appendTo("body"),k=[43,5,205,85,289,63,230,186,115,330],j=function(a,b,d){var e;return e=c(a,b,d),"rgb("+e.join(" ,")+")"},l.prototype.colorizeContexts=function(){var a,b,c,d,f,g,h,i,l,m,n,o,p;return n=[30,96],b=n[0],a=n[1],o=[60,40],m=o[0],l=o[1],p=[70,70],i=p[0],h=p[1],d=function(){var d,e,n;e=this.contextCodes,n=[];for(g=0,d=e.length;g<d;g++)c=e[g],f=k[g%k.length],n.push(".group_"+c+"{           color: "+j(f,m,l)+";           border-color: "+j(f,i,h)+";           background-color: "+j(f,b,a)+";        }");return n}.call(this),e.html("<style>"+d.join("")+"</style>")},l.prototype.dataFromDocumentHash=function(){var a;a={};try{a=$.parseJSON($.decodeFromHex(location.hash.substring(1)))||{}}catch(b){a={}}return a},l}()})}).call(this)