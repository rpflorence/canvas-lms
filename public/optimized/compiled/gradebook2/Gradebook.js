(function(){var a=function(a,b){return function(){return a.apply(b,arguments)}},b=Array.prototype.indexOf||function(a){for(var b=0,c=this.length;b<c;b++)if(this[b]===a)return b;return-1};define(["i18n","jquery","compiled/grade_calculator","vendor/spin","compiled/multi_grid","compiled/SubmissionDetailsDialog","compiled/gradebook2/AssignmentGroupWeightsDialog","compiled/gradebook2/SubmissionCell","compiled/gradebook2/GradebookHeaderMenu","str/htmlEscape","jst/gradebook_uploads_form","jst/gradebook2/section_to_show_menu","jquery.ajaxJSON","jquery.instructure_date_and_time","jquery.instructure_jquery_patches","jquery.instructure_misc_helpers","jquery.instructure_misc_plugins","vendor/jquery.ba-tinypubsub","vendor/jquery.store","jqueryui/mouse","jqueryui/position","jqueryui/sortable","compiled/jquery.kylemenu"],function(c,d,e,f,g,h,i,j,k,l,m,n){var o;return c=c.scoped("gradebook2"),o=function(){function o(b){var c;this.options=b,this.initGrid=a(this.initGrid,this),this.initHeader=a(this.initHeader,this),this.hoverMinimizedCell=a(this.hoverMinimizedCell,this),this.unminimizeColumn=a(this.unminimizeColumn,this),this.minimizeColumn=a(this.minimizeColumn,this),this.fixColumnReordering=a(this.fixColumnReordering,this),this.unhighlightColumns=a(this.unhighlightColumns,this),this.highlightColumn=a(this.highlightColumn,this),this.calculateStudentGrade=a(this.calculateStudentGrade,this),this.groupTotalFormatter=a(this.groupTotalFormatter,this),this.staticCellFormatter=a(this.staticCellFormatter,this),this.cellFormatter=a(this.cellFormatter,this),this.updateSubmissionsFromExternal=a(this.updateSubmissionsFromExternal,this),this.updateSubmission=a(this.updateSubmission,this),this.gotSubmissionsChunk=a(this.gotSubmissionsChunk,this),this.getSubmissionsChunks=a(this.getSubmissionsChunks,this),this.buildRows=a(this.buildRows,this),this.rowFilter=a(this.rowFilter,this),this.columnSortFn=a(this.columnSortFn,this),this.arrangeColumnsBy=a(this.arrangeColumnsBy,this),this.gotStudents=a(this.gotStudents,this),this.gotAssignmentGroups=a(this.gotAssignmentGroups,this),this.chunk_start=0,this.students={},this.rows=[],this.sortFn=function(a){return a.display_name},this.assignmentsToHide=(d.store.userGet("hidden_columns_"+this.options.context_code)||"").split(","),this.sectionToShow=Number(d.store.userGet("grading_show_only_section"+this.options.context_id))||void 0,this.show_attendance=d.store.userGet("show_attendance_"+this.options.context_code)==="true",this.include_ungraded_assignments=d.store.userGet("include_ungraded_assignments_"+this.options.context_code)==="true",d.subscribe("assignment_group_weights_changed",this.buildRows),d.subscribe("assignment_muting_toggled",this.buildRows),d.subscribe("submissions_updated",this.updateSubmissionsFromExternal),c=d.when(d.ajaxJSON(this.options.assignment_groups_url,"GET",{},this.gotAssignmentGroups),d.ajaxJSON(this.options.sections_and_students_url,"GET",this.sectionToShow&&{sections:[this.sectionToShow]})).then(a(function(a,b){return this.gotStudents.apply(this,b)},this)),this.spinner=new f,d(this.spinner.spin().el).css({opacity:.5,top:"50%",left:"50%"}).addClass("use-css-transitions-for-show-hide").appendTo("#main")}var e;return e=10,o.prototype.gotAssignmentGroups=function(a){var b,c,e,f,g;this.assignmentGroups={},this.assignments={},new i({context:this.options,assignmentGroups:a}),g=[];for(e=0,f=a.length;e<f;e++)c=a[e],l(c),this.assignmentGroups[c.id]=c,g.push(function(){var a,e,f,g;f=c.assignments,g=[];for(a=0,e=f.length;a<e;a++)b=f[a],l(b),b.assignment_group=c,b.due_at&&(b.due_at=d.parseFromISO(b.due_at)),g.push(this.assignments[b.id]=b);return g}.call(this));return g},o.prototype.gotStudents=function(a){var b,c,d,e,f,g,h,i,j,k,m,n;this.sections={},this.rows=[];for(f=0,h=a.length;f<h;f++){d=a[f],l(d),this.sections[d.id]=d,k=d.students;for(g=0,i=k.length;g<i;g++){e=k[g],l(e),e.computed_current_score||(e.computed_current_score=0),e.computed_final_score||(e.computed_final_score=0),e.secondary_identifier=e.sis_login_id||e.login_id,this.students[e.id]=e,e.section=d,m=this.assignments;for(c in m)b=m[c],e[j="assignment_"+c]||(e[j]={assignment_id:c,user_id:e.id});this.rows.push(e)}}this.sections_enabled=a.length>1,n=this.students;for(c in n)e=n[c],e.display_name="<div class='student-name'>"+e.name+"</div>",this.sections_enabled&&(e.display_name+="<div class='student-section'>"+e.section.name+"</div>");return this.initGrid(),this.buildRows(),this.getSubmissionsChunks(),this.initHeader()},o.prototype.arrangeColumnsBy=function(a){var b;return a&&a!==this._sortColumnsBy&&(this.$columnArrangementTogglers.each(function(){return d(this).closest("li").showIf(d(this).data("arrangeColumnsBy")!==a)}),this._sortColumnsBy=a,d.store[a==="due_date"?"userSet":"userRemove"]("sort_grade_colums_by_"+this.options.context_id,a),b=this.gradeGrid.getColumns(),b.sort(this.columnSortFn),this.gradeGrid.setColumns(b),this.fixColumnReordering(),this.buildRows()),this._sortColumnsBy||(this._sortColumnsBy=d.store.userGet("sort_grade_colums_by_"+this.options.context_id)||"assignment_group")},o.prototype.columnSortFn=function(a,b){var c,d,e,f,g,h;if(b.type==="total_grade")return-1;if(a.type==="total_grade")return 1;if(b.type==="assignment_group"&&a.type!=="assignment_group")return-1;if(a.type==="assignment_group"&&b.type!=="assignment_group")return 1;if(a.type==="assignment_group"&&b.type==="assignment_group")return a.object.position-b.object.position;if(a.type==="assignment"&&b.type==="assignment")return this.arrangeColumnsBy()==="assignment_group"?(e=a.object.assignment_group.position-b.object.assignment_group.position,f=a.object.position-b.object.position,e*1e6+f):(c=((g=a.object.due_at)!=null?g.timestamp:void 0)||Number.MAX_VALUE,d=((h=b.object.due_at)!=null?h.timestamp:void 0)||Number.MAX_VALUE,c===d?a.object.name===b.object.name?0:a.object.name>b.object.name?1:-1:c-d);throw"unhandled column sort condition"},o.prototype.rowFilter=function(a){return!this.sectionToShow||a.section.id===this.sectionToShow},o.prototype.buildRows=function(){var a,b,c,d,e,f,g,h,i,j;this.rows.length=0,d={},g=this.gradeGrid.getColumns();for(c in g)a=g[c],""+((h=a.object)!=null?h.submission_types:void 0)=="attendance"&&(a.unselectable=!this.show_attendance,a.cssClass=this.show_attendance?"":"completely-hidden",this.$grid.find("[id*='"+a.id+"']").showIf(this.show_attendance));i=this.students;for(c in i)e=i[c],e.row=-1,this.rowFilter(e)&&(this.rows.push(e),this.calculateStudentGrade(e),d[e.id]=this.sortFn(e));this.rows.sort(function(a,b){return d[a.id]<d[b.id]?-1:d[a.id]>d[b.id]?1:0}),j=this.rows;for(b=0,f=j.length;b<f;b++)e=j[b],e.row=b;return this.multiGrid.invalidate()},o.prototype.getSubmissionsChunks=function(){var a,b,c,e,f,g;g=[];for(;;){f=this.rows.slice(this.chunk_start,this.chunk_start+this.options.chunk_size);if(!f.length){this.allSubmissionsLoaded=!0;break}c={student_ids:function(){var a,b,c;c=[];for(a=0,b=f.length;a<b;a++)e=f[a],c.push(e.id);return c}(),assignment_ids:function(){var c,d;c=this.assignments,d=[];for(b in c)a=c[b],d.push(b);return d}.call(this),response_fields:["user_id","url","score","grade","submission_type","submitted_at","assignment_id","grade_matches_current_submission"]},d.ajaxJSON(this.options.submissions_url,"GET",c,this.gotSubmissionsChunk),g.push(this.chunk_start+=this.options.chunk_size)}return g},o.prototype.gotSubmissionsChunk=function(a){var b,c,d,e,f,g,h,i;for(e=0,g=a.length;e<g;e++){b=a[e],c=this.students[b.user_id],i=b.submissions;for(f=0,h=i.length;f<h;f++)d=i[f],this.updateSubmission(d);c.loaded=!0,this.multiGrid.invalidateRow(c.row),this.calculateStudentGrade(c)}return this.multiGrid.render()},o.prototype.updateSubmission=function(a){var b;return b=this.students[a.user_id],a.submitted_at&&(a.submitted_at=d.parseFromISO(a.submitted_at)),b["assignment_"+a.assignment_id]=a},o.prototype.updateSubmissionsFromExternal=function(a){var b,c,d,e;for(d=0,e=a.length;d<e;d++)c=a[d],b=this.students[c.user_id],this.updateSubmission(c),this.multiGrid.invalidateRow(b.row),this.calculateStudentGrade(b);return this.multiGrid.render()},o.prototype.cellFormatter=function(a,b,c){var d;return this.rows[a].loaded?c==null?this.staticCellFormatter(a,b,"-"):(d=this.assignments[c.assignment_id],d==null?this.staticCellFormatter(a,b,""):d.grading_type==="points"&&d.points_possible?j.out_of.formatter(a,b,c,d):(j[d.grading_type]||j).formatter(a,b,c,d)):this.staticCellFormatter(a,b,"")},o.prototype.staticCellFormatter=function(a,b,c){return"<div class='cell-content gradebook-cell'>"+c+"</div>"},o.prototype.groupTotalFormatter=function(a,b,c,d,e){var f,g;return c==null?"":(f=c,g=Math.round(f.score/f.possible*100),isNaN(g)&&(g=0),f.possible?g+="%":g="-",'<div class="gradebook-cell">\n  <div class="gradebook-tooltip">'+f.score+" / "+f.possible+"</div>\n  "+g+"\n</div>")},o.prototype.calculateStudentGrade=function(a){var b,c,d,e,f,g,h,i,j;if(a.loaded){b=this.include_ungraded_assignments?"final":"current",f=function(){var b;b=[];for(d in a)g=a[d],d.match(/^assignment_(?!group)/)&&b.push(g);return b}(),e=INST.GradeCalculator.calculate(f,this.assignmentGroups,this.options.group_weighting_scheme),j=e.group_sums;for(h=0,i=j.length;h<i;h++)c=j[h],a["assignment_group_"+c.group.id]=c[b];return a.total_grade=e[b]}},o.prototype.highlightColumn=function(a){var b;return isNaN(a)&&(b=a.currentTarget.className.match(/c\d+/),b&&(a=b.toString().replace("c",""))),this.$grid.find(".slick-header-column:eq("+a+")").addClass("hovered-column")},o.prototype.unhighlightColumns=function(){return this.$grid.find(".hovered-column").removeClass("hovered-column")},o.prototype.fixColumnReordering=function(){var b,c,e,f,g,h,i;return b=d("#gradebook_grid").find(".slick-header-columns"),h=b.sortable("option","items"),g='> *:not([id*="assignment_group"]):not([id*="total_grade"])',(f=function(){var a;return b.sortable("option","items",g),a=d(h,b).not(d(g,b)),a.data("sortable-item",null)})(),(e=a(function(){return b.find(".gradebook-header-drop").click(a(function(a){var b;return b=d(a.target),b.data("gradebookHeaderMenu")||b.data("gradebookHeaderMenu",new k(this.assignments[b.data("assignmentId")],b,this)),!1},this))},this))(),i=b.sortable("option","stop"),(c=function(){return b.sortable("option","stop",function(a,d){var g;return b.sortable("option","items",h),g=i.apply(this,arguments),f(),e(),c(),g})})()},o.prototype.minimizeColumn=function(a){var b,c;return b=a.index(),c=this.gradeGrid.getColumns()[b],c.cssClass=(c.cssClass||"").replace(" minimized","")+" minimized",c.unselectable=!0,c.unminimizedName=c.name,c.name="",this.$grid.find(".c"+b).add(a).addClass("minimized"),a.data("minimized",!0),this.assignmentsToHide.push(c.id),d.store.userSet("hidden_columns_"+this.options.context_code,d.uniq(this.assignmentsToHide).join(","))},o.prototype.unminimizeColumn=function(a){var b,c;return b=a.index(),c=this.gradeGrid.getColumns()[b],c.cssClass=(c.cssClass||"").replace(" minimized",""),c.unselectable=!1,c.name=c.unminimizedName,this.$grid.find(".c"+b).add(a).removeClass("minimized"),a.removeData("minimized"),this.assignmentsToHide=d.grep(this.assignmentsToHide,function(a){return a!==c.id}),d.store.userSet("hidden_columns_"+this.options.context_code,d.uniq(this.assignmentsToHide).join(","))},o.prototype.hoverMinimizedCell=function(b){var e,f,g,h,i,k,l;return e=d(b.currentTarget).removeClass("hover"),g=this.gradeGrid.getColumns()[e.index()],f=g.object,i=e.offset(),h=[f.name],e.hasClass("slick-cell")?(k=this.rows[this.gradeGrid.getCellFromEvent(b).row][g.id],f.points_possible!=null?h.push(""+((l=k.score)!=null?l:"--")+" / "+f.points_possible):k.score!=null&&h.push(k.score),Array.prototype.push.apply(h,d.map(j.classesBasedOnSubmission(k,f),a(function(a){return GRADEBOOK_TRANSLATIONS["#submission_tooltip_"+a]},this)))):f.points_possible!=null&&h.push(c.t("points_out_of","out of %{points_possible}",{points_possible:f.points_possible})),e.data("tooltip",d("<span />",{"class":"gradebook-tooltip",css:{left:i.left-15,top:i.top,zIndex:1e4,display:"block"},html:h.join("<br />")}).appendTo("body").css("top",function(a,b){return parseInt(b)-d(this).outerHeight()}))},o.prototype.unhoverMinimizedCell=function(a){var b;if(b=d(this).data("tooltip"))return a.toElement===b[0]?b.mouseleave(function(){return b.remove()}):b.remove()},o.prototype.onGridInit=function(){var b,c;return this.fixColumnReordering(),c={},d(this.spinner.el).remove(),d("#gradebook_wrapper").show(),this.$grid=b=d("#gradebook_grid").fillWindowWithMe({alsoResize:"#gradebook_students_grid",onResize:a(function(){return this.multiGrid.resizeCanvas()},this)}).delegate(".slick-cell",{"mouseenter.gradebook focusin.gradebook":this.highlightColumn,"mouseleave.gradebook focusout.gradebook":this.unhighlightColumns,"mouseenter focusin":function(a){return b.find(".hover, .focus").removeClass("hover focus"),d(this).addClass(a.type==="mouseenter"?"hover":"focus")},"mouseleave focusout":function(){return d(this).removeClass("hover focus")}}).delegate(".gradebook-cell-comment","click.gradebook",a(function(a){var b;return a.preventDefault(),b=d(a.currentTarget).data(),h.open(this.assignments[b.assignmentId],this.students[b.userId],this.options)},this)).delegate(".minimized",{mouseenter:this.hoverMinimizedCell,mouseleave:this.unhoverMinimizedCell}),d("#gradebook_grid .slick-resizable-handle").live("drag",a(function(b,c){return this.$grid.find(".slick-header-column").each(a(function(a,b){var c,f;c=d(b),f=c.data("minimized");if(c.outerWidth()>e){if(f)return this.unminimizeColumn(c)}else if(!f)return this.minimizeColumn(c)},this))},this)),d(document).trigger("gridready")},o.prototype.initHeader=function(){var b,e,f,g,h,i,j,k,l,o;if(this.sections_enabled){e=d("#section_being_shown"),h=c.t("all_sections","All Sections"),k=[{name:h,checked:!this.sectionToShow}],o=this.sections;for(i in o)j=o[i],k.push({name:j.name,id:i,checked:this.sectionToShow===i});b=d(n({sections:k,scrolling:k.length>15})),(l=a(function(){return e.text(this.sectionToShow?this.sections[this.sectionToShow].name:h)},this))(),d("#section_to_show").after(b).show().kyleMenu({buttonOpts:{icons:{primary:"ui-icon-sections",secondary:"ui-icon-droparrow"}}}),b.bind("menuselect",a(function(a,c){return this.sectionToShow=Number(b.find('[aria-checked="true"] input[name="section_to_show_radio"]').val())||void 0,d.store[this.sectionToShow?"userSet":"userRemove"]("grading_show_only_section"+this.options.context_id,this.sectionToShow),l(),this.buildRows()},this))}return f=d("#gradebook_settings").next(),d.each(["show_attendance","include_ungraded_assignments"],a(function(b,c){return f.find("#"+c).prop("checked",this[c]).change(a(function(a){return this[c]=d(a.target).is(":checked"),d.store.userSet(""+c+"_"+this.options.context_code,""+this[c]),this.gradeGrid.setColumns(this.getVisibleGradeGridColumns()),this.gradeGrid.invalidate()},this))},this)),d.detect(this.gradeGrid.getColumns(),function(){var a;return((a=this.object)!=null?a.submission_types:void 0)==="attendance"})||f.find("#show_attendance").hide(),this.$columnArrangementTogglers=d("#gradebook-toolbar [data-arrange-columns-by]").bind("click",a(function(a){var b;return a.preventDefault(),b=d(a.currentTarget).data("arrangeColumnsBy"),this.arrangeColumnsBy(b)},this)),this.arrangeColumnsBy("assignment_group"),d("#gradebook_settings").show().kyleMenu({buttonOpts:{icons:{primary:"ui-icon-cog",secondary:"ui-icon-droparrow"}}}),g=null,f.find(".gradebook_upload_link").click(a(function(a){var b;return a.preventDefault(),g||(b={download_gradebook_csv_url:""+this.options.context_url+"/gradebook.csv",action:""+this.options.context_url+"/gradebook_uploads",authenticityToken:d("#ajax_authenticity_token").text()},g=d(m(b)).dialog({bgiframe:!0,autoOpen:!1,modal:!0,width:720,resizable:!1}).fixDialogButtons().delegate("#gradebook-upload-help-trigger","click",function(){return d(this).hide(),d("#gradebook-upload-help").show()})),g.dialog("open")},this))},o.prototype.getVisibleGradeGridColumns=function(){var a,b,c,d,e,f;b=[],f=this.allAssignmentColumns;for(d=0,e=f.length;d<e;d++)a=f[d],c=""+a.object.submission_types,c==="not_graded"&&!this.include_ungraded_assignments||c==="attendance"&&!this.show_attendance||b.push(a);return b.concat(this.aggregateColumns)},o.prototype.initGrid=function(){var f,h,i,k,l,m,n,o,p,q,r,s,t,u,v;return f=d('<span style="padding:10px" />').appendTo("#content"),v=function(a,b){return Math.max(f.text(a).outerWidth(),b)},this.parentColumns=[{id:"student",name:c.t("student_name","Student Name"),field:"display_name",width:150,cssClass:"meta-cell",resizable:!1,sortable:!0},{id:"secondary_identifier",name:c.t("secondary_id","Secondary ID"),field:"secondary_identifier",width:100,cssClass:"meta-cell secondary_identifier_cell",resizable:!1,sortable:!0}],this.allAssignmentColumns=function(){var f,g;f=this.assignments,g=[];for(p in f)h=f[p],n=""+this.options.context_url+"/assignments/"+h.id,o="<a class='assignment-name' href='"+n+"'>"+h.name+"</a>                <a class='gradebook-header-drop' data-assignment-id='"+h.id+"' href='#' role='button'>"+c.t("assignment_options","Assignment Options")+"</a>",h.points_possible!=null&&(o+="<div class='assignment-points-possible'>"+c.t("points_out_of","out of %{points_possible}",{points_possible:h.points_possible})+"</div>"),s=h&&h.grading_type==="points"&&h.points_possible!=null&&j.out_of,q=s?70:90,k="assignment_"+p,i={id:k,field:k,name:o,object:h,formatter:this.cellFormatter,editor:s||j[h.grading_type]||j,minWidth:e,maxWidth:200,width:v(h.name,q),sortable:!0,toolTip:!0,type:"assignment"},""+h.submission_types=="not_graded"&&(i.cssClass=(i.cssClass||"")+" ungraded"),b.call(this.assignmentsToHide,k)>=0&&(i.width=10,a(function(b){return d(document).bind("gridready",a(function(){return this.minimizeColumn(this.$grid.find("[id*='"+b+"']"))},this)).unbind("gridready.render").bind("gridready.render",this.gradeGrid.invalidate)},this)(k)),g.push(i);return g}.call(this),this.aggregateColumns=function(){var a,b;a=this.assignmentGroups,b=[];for(p in a)m=a[p],o=""+m.name,m.group_weight!=null&&(t=c.toPercentage(m.group_weight,{precision:0}),o+="<div class='assignment-points-possible'>\n  "+c.t("percent_of_grade","%{percentage} of grade",{percentage:t})+"\n</div>"),b.push({id:"assignment_group_"+p,field:"assignment_group_"+p,formatter:this.groupTotalFormatter,name:o,object:m,minWidth:35,maxWidth:200,width:v(m.name,35),cssClass:"meta-cell assignment-group-cell",sortable:!0,type:"assignment_group"});return b}.call(this),this.aggregateColumns.push({id:"total_grade",field:"total_grade",formatter:this.groupTotalFormatter,name:"Total",minWidth:50,maxWidth:100,width:v("Total",50),cssClass:"total-cell",sortable:!0,type:"total_grade"}),f.remove(),r=d.extend({enableCellNavigation:!1,enableColumnReorder:!1,enableAsyncPostRender:!0,asyncPostRenderDelay:1,autoEdit:!0,rowHeight:35,headerHeight:38},this.options),l=[{selector:"#gradebook_students_grid",columns:this.parentColumns},{selector:"#gradebook_grid",columns:this.getVisibleGradeGridColumns(),options:{enableCellNavigation:!0,editable:!0,syncColumnCellResize:!0,enableColumnReorder:!0}}],this.multiGrid=new g(this.rows,r,l,1),this.gradeGrid=this.multiGrid.grids[1],this.gradeGrid.onCellChange.subscribe(a(function(a,b){return this.calculateStudentGrade(b.item),this.gradeGrid.invalidate},this)),this.gradeGrid.onBeforeCellEditorDestroy.subscribe(function(a,b){debugger}),u=a(function(a){var b,c,d,e;this.rows.sort(a),e=this.rows;for(b=0,d=e.length;b<d;b++)c=e[b],c.row=b;return this.multiGrid.invalidate()},this),this.gradeGrid.onSort.subscribe(a(function(a,b){return u(function(a,c){var d,e,f,g;return d=(f=a[b.sortCol.field])!=null?f.score:void 0,e=(g=c[b.sortCol.field])!=null?g.score:void 0,!d&&d!==0&&(d=-99999999999),!e&&e!==0&&(e=-99999999999),b.sortAsc?e-d:d-e})},this)),this.multiGrid.grids[0].onSort.subscribe(a(function(a,b){var c;return c={display_name:"sortable_name",secondary_identifier:"secondary_identifier"}[b.sortCol.field],u(function(a,d){var e;return e=a[c]<d[c]?-1:a[c]>d[c]?1:0,b.sortAsc?e:0-e})},this)),this.multiGrid.parent_grid.onKeyDown.subscribe(function(){return!1}),this.onGridInit()},o}()})}).call(this)