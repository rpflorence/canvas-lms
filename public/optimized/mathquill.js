define(["i18n","jquery"],function(a,b){function f(){}function g(a,c,d,f){if(!arguments.length)return;var g=this;g.cmd=a,c&&(g.html_template=c),d&&(g.text_template=d),g.jQ=b(g.html_template[0]).data(e,{cmd:g}),g.initBlocks(f)}function h(a,b,c){g.call(this,a,[b],[c||(a&&a.length>1?a.slice(1):a)])}function i(){}function j(a,c,d){if(!arguments.length)return;var e=this;e.parent=a,e.prev=c||0,e.next=d||0,e.jQinit(e.fold(b(),function(a,b){return b.jQ.add(a)}))}function k(a,c,f,g,h){function m(){var a=k.val();if(!a)return;k.val(""),j.parent.textInput(a)}function o(a){return j.seek(b(a.target),a.pageX,a.pageY),j.prev===r.prev&&j.parent===r.parent?j.clearSelection():j.selectFrom(r),!1}function p(a){return delete a.target,o(a)}function q(c){r=d,j.blink=s,j.selection||j.show(),a.unbind("mousemove",o),b(document).unbind("mousemove",p).unbind("mouseup",q)}var i=a.contents().detach();f||a.addClass("mathquill-rendered-math"),c.jQ=a.data(e,{block:c,revert:function(){a.empty().unbind(".mathquill").removeClass("mathquill-rendered-math mathquill-editable mathquill-textbox mathquill-editor").append(i)}});var j=c.cursor=new Q(c);c.renderLatex(i.text());if(!g)return;c.textarea=b('<span class="textarea"><textarea></textarea></span>').prependTo(a.addClass("mathquill-editable"));var k=c.textarea.children();f&&a.addClass("mathquill-textbox"),h&&l(c,a),k.focus(function(a){j.parent||j.appendTo(c),j.parent.jQ.addClass("hasCursor"),j.selection?j.selection.jQ.removeClass("blur"):j.show(),a.stopPropagation()}).blur(function(a){j.hide().parent.blur(),j.selection&&j.selection.jQ.addClass("blur"),a.stopPropagation()}).bind("selectstart",function(a){a.stopPropagation()});var n={};a.bind("focus.mathquill blur.mathquill",function(a){k.trigger(a)}).bind("keydown.mathquill",function(a){return n.evt=a,n.happened=!0,n.returnValue=j.parent.keydown(a),n.returnValue?!0:(a.stopImmediatePropagation(),!1)}).bind("keypress.mathquill",function(a){n.happened?n.happened=!1:n.returnValue=j.parent.keydown(n.evt);if(!n.returnValue)return!1;setTimeout(m)}).bind("mousedown.mathquill",function(d){j.seek(b(d.target),d.pageX,d.pageY).blink=b.noop,r=new Q(c),r.jQ=r._jQ=b(),j.next?r.insertBefore(j.next):r.appendTo(j.parent),a.mousemove(o),b(document).mousemove(p).mouseup(q),setTimeout(function(){k.focus()})}).bind("selectstart.mathquill",!1).blur();var r,s=j.blink}function l(c,e){var f=[{name:a.t("tabs.basic","Basic"),example:"+",button_groups:[["subscript","supscript","frac","sqrt","nthroot","langle","binomial","vector","f","prime"],["+","-","pm","mp","cdot","=","times","div","ast"],["therefore","because"],["sum","prod","coprod","int"],["N","P","Z","Q","R","C","H"]]},{name:a.t("tabs.greek","Greek"),example:"&pi;",button_groups:[["alpha","beta","gamma","delta","epsilon","zeta","eta","theta","iota","kappa","lambda","mu","nu","xi","pi","rho","sigma","tau","upsilon","phi","chi","psi","omega"],["digamma","varepsilon","vartheta","varkappa","varpi","varrho","varsigma","varphi"],["Gamma","Delta","Theta","Lambda","Xi","Pi","Sigma","Upsilon","Phi","Psi","Omega"]]},{name:a.t("tabs.operators","Operators"),example:"&oplus;",button_groups:[["wedge","vee","cup","cap","diamond","bigtriangleup","ominus","uplus","otimes","oplus","bigtriangledown","sqcap","triangleleft","sqcup","triangleright","odot","bigcirc","dagger","ddagger","wr","amalg"]]},{name:a.t("tabs.relationships","Relationships"),example:"&le;",button_groups:[["<",">","equiv","cong","sim","notin","ne","propto","approx","le","ge","in","ni","notni","subset","supset","notsubset","notsupset","subseteq","supseteq","notsubseteq","notsupseteq","models","prec","succ","preceq","succeq","simeq","mid","ll","gg","parallel","bowtie","sqsubset","sqsupset","smile","sqsubseteq","sqsupseteq","doteq","frown","vdash","dashv","exists","varnothing"]]},{name:a.t("tabs.arrows","Arrows"),example:"&hArr;",button_groups:[["longleftarrow","longrightarrow","Longleftarrow","Longrightarrow","longleftrightarrow","updownarrow","Longleftrightarrow","Updownarrow","mapsto","nearrow","hookleftarrow","hookrightarrow","searrow","leftharpoonup","rightharpoonup","swarrow","leftharpoondown","rightharpoondown","nwarrow","downarrow","Downarrow","uparrow","Uparrow","rightarrow","Rightarrow","leftarrow","lArr","leftrightarrow","Leftrightarrow"]]},{name:a.t("tabs.delimiters","Delimiters"),example:"{",button_groups:[["lfloor","rfloor","lceil","rceil","slash","opencurlybrace","closecurlybrace"]]},{name:a.t("tabs.miscellaneous","Misc"),example:"&infin;",button_groups:[["forall","ldots","cdots","vdots","ddots","surd","triangle","ell","top","flat","natural","sharp","wp","bot","clubsuit","diamondsuit","heartsuit","spadesuit","caret","underscore","backslash","vert","perp","nabla","hbar","AA","circ","bullet","setminus","neg","dots","Re","Im","partial","infty","aleph","deg","angle"]]}],g={binomial:'<span style="font-size: 0.5em"><span class="paren" style="font-size: 2.087912087912088em; ">(</span><span class="array"><span><var>n</var></span><span><var>m</var></span></span><span class="paren" style="font-size: 2.087912087912088em; ">)</span></span>',frac:'<span style="font-size: 0.55em" class="fraction"><span class="numerator"><var>n</var></span><span class="denominator"><var>m</var></span><span style="width:0"></span></span>',sqrt:'<span style="font-size: 0.8em; padding-top: 3px"><span class="sqrt-prefix">&radic;</span><span class="sqrt-stem" style="border-top-width: 1.7142857142857144px;">&nbsp;</span></span>',nthroot:'<span style="font-size: 0.7em"><sup class="nthroot"><var>n</var></sup><span><span class="sqrt-prefix">&radic;</span><span class="sqrt-stem" style="border-top-width: 1.7142857142857144px; ">&nbsp;</span></span></span>',supscript:'<sup style="font-size: 0.6em">sup</sup>',subscript:'<sub style="font-size: 0.6em; line-height: 3.5;">sub</sub>',vector:'<span class="array" style="font-size: 0.6em"><span class=""><var>a</var><span> </span><var>b</var></span><span class=""><var>c</var><span> </span><var>d</var></span></span>'},h=[],i=[];b.each(f,function(a,c){h.push('<li><a href="#'+c.name+'_tab"><span class="mathquill-rendered-math">'+c.example+"</span>"+c.name+"</a></li>");var e=[];b.each(c.button_groups,function(a,c){b.each(c,function(a,b){var c=new q[b](d,b);e.push('<li><a class="mathquill-rendered-math" title="'+(b.match(/^[a-z]+$/)?"\\"+b:b)+'">'+(g[b]?g[b]:'<span style="line-height: 1.5em">'+c.html_template.join("")+"</span>")+"</a></li>")}),e.push('<li class="mathquill-button-spacer"></li>')}),i.push('<div class="mathquill-tab-pane" id="'+c.name+'_tab"><ul>'+e.join("")+"</ul></div>")}),c.toolbar=b('<div class="mathquill-toolbar"><ul class="mathquill-tab-bar">'+h.join("")+'</ul><div class="mathquill-toolbar-panes">'+i.join("")+"</div></div>").prependTo(e),e.find(".mathquill-tab-bar li a").mouseenter(function(){e.find(".mathquill-tab-bar li").removeClass("mathquill-tab-selected"),e.find(".mathquill-tab-pane").removeClass("mathquill-tab-pane-selected"),b(this).parent().addClass("mathquill-tab-selected"),b(this.href.replace(/.*#/,"#")).addClass("mathquill-tab-pane-selected")}),e.find(".mathquill-tab-bar li:first-child a").mouseenter(),e.find("a.mathquill-rendered-math").mousedown(function(a){a.stopPropagation()}).click(function(){c.cursor.writeLatex(this.title,!0),e.focus()})}function m(){}function n(a){g.call(this,"$"),this.firstChild.cursor=a,this.firstChild.textInput=function(b){if(this.skipTextInput)return;b!=="$"||a.parent!==this?a.write(b):this.isEmpty()?a.insertAfter(this.parent).backspace().insertNew(new K("\\$","$")).show():a.next?a.prev?a.write(b):a.insertBefore(this.parent):a.insertAfter(this.parent)}}function o(){}function r(a,b){return b.prototype=a.prototype,b}function s(a,b,c,d){g.call(this,a,[b],[c],d)}function t(a){g.call(this,"\\frac",d,d,a),this.jQ.append('<span style="width:0">&nbsp;</span>')}function u(){t.apply(this,arguments)}function v(a){g.call(this,"\\sqrt",d,d,a)}function w(a){v.call(this,a),this.jQ=this.firstChild.jQ.detach().add(this.jQ)}function x(a,b,c,d,e){g.call(this,c,['<span><span class="paren">'+a+'</span><span></span><span class="paren">'+b+"</span></span>"],[a,b],e),this.end=d}function y(a,b,c,d,e){x.apply(this,arguments)}function z(a,b,c){x.call(this,a,b,a,b,c)}function A(a,b,c){y.call(this,a,b,a,b,c)}function B(a){z.call(this,"|","|",a)}function C(a){a instanceof j?this.replacedText=a.remove().jQ.text():typeof a=="string"&&(this.replacedText=a),g.call(this,"\\text")}function D(){}function E(a){g.call(this,"\\"),a&&(this.replacedFragment=a.detach(),this.isEmpty=function(){return!1})}function F(a){g.call(this,"\\binom",d,d,a),this.jQ.wrapInner('<span class="array"></span>').prepend('<span class="paren">(</span>').append('<span class="paren">)</span>')}function G(){F.apply(this,arguments)}function H(a){g.call(this,"\\vector",d,d,a)}function I(a){var b=Array.prototype.slice.call(arguments,1);return r(a,function(){a.apply(this,b)})}function J(a,b){h.call(this,a,"<var>"+(b||a)+"</var>")}function K(a,b){h.call(this,a,"<span>"+(b||a)+"</span>")}function L(a,b){h.call(this,a,'<span class="nonSymbola">'+(b||a)+"</span>")}function M(a,b,c){h.call(this,a,'<span class="binary-operator">'+b+"</span>",c)}function N(a,b){K.apply(this,arguments)}function O(a,b){h.call(this,a,"<big>"+b+"</big>")}function P(a,b){h.call(this,"\\"+b+" ","<span>"+b+"</span>")}function Q(a){this.parent=this.root=a;var c=this.jQ=this._jQ=b('<span class="cursor"></span>');this.blink=function(){c.toggleClass("blink")}}function R(a,b,c){j.apply(this,arguments)}a=a.scoped("mathquill");var c,d,e="[[mathquill internal data]]";c=f.prototype,c.prev=0,c.next=0,c.parent=0,c.firstChild=0,c.lastChild=0,c.eachChild=function(a){for(var b=this.firstChild;b;b=b.next)if(a.call(this,b)===!1)break;return this},c.foldChildren=function(a,b){return this.eachChild(function(c){a=b.call(this,a,c)}),a},c.keydown=function(a){return this.parent.keydown(a)},c.textInput=function(a){return this.parent.textInput(a)},c=g.prototype=new f,c.initBlocks=function(a){var c=this;if(c.html_template.length===1){c.firstChild=c.lastChild=c.jQ.data(e).block=a&&a.blockify()||new i,c.firstChild.parent=c,c.firstChild.jQ=c.jQ.append(c.firstChild.jQ);return}var d,f,g=c.html_template.length;this.firstChild=d=f=a&&a.blockify()||new i,d.parent=c,d.jQ=b(c.html_template[1]).data(e,{block:d}).append(d.jQ).appendTo(c.jQ),d.blur();for(var h=2;h<g;h+=1)d=new i,d.parent=c,d.prev=f,f.next=d,f=d,d.jQ=b(c.html_template[h]).data(e,{block:d}).appendTo(c.jQ),d.blur();c.lastChild=d},c.latex=function(){return this.foldChildren(this.cmd,function(a,b){return a+"{"+(b.latex()||" ")+"}"})},c.text=function(){var a=0;return this.foldChildren(this.text_template[a],function(b,c){a+=1;var d=c.text();return b&&this.text_template[a]==="("&&d[0]==="("&&d.slice(-1)===")"?b+d.slice(1,-1)+this.text_template[a]:b+c.text()+(this.text_template[a]||"")})},c.remove=function(){var a=this,b=a.prev,c=a.next,d=a.parent;return b?b.next=c:d.firstChild=c,c?c.prev=b:d.lastChild=b,a.jQ.remove(),a},c.respace=b.noop,c.placeCursor=function(a){a.appendTo(this.foldChildren(this.firstChild,function(a,b){return a.isEmpty()?a:b}))},c.isEmpty=function(){return this.foldChildren(!0,function(a,b){return a&&b.isEmpty()})},c=h.prototype=new g,c.initBlocks=b.noop,c.latex=function(){return this.cmd},c.text=function(){return this.text_template},c.placeCursor=b.noop,c.isEmpty=function(){return!0},c=i.prototype=new f,c.latex=function(){return this.foldChildren("",function(a,b){return a+b.latex()})},c.text=function(){return this.firstChild===this.lastChild?this.firstChild.text():this.foldChildren("(",function(a,b){return a+b.text()})+")"},c.isEmpty=function(){return this.firstChild===0&&this.lastChild===0},c.focus=function(){return this.jQ.addClass("hasCursor"),this.isEmpty()&&this.jQ.removeClass("empty"),this},c.blur=function(){return this.jQ.removeClass("hasCursor"),this.isEmpty()&&this.jQ.addClass("empty"),this},c=j.prototype,c.remove=g.prototype.remove,c.jQinit=function(a){this.jQ=a},c.each=function(a){for(var b=this.prev.next||this.parent.firstChild;b!==this.next;b=b.next)if(a.call(this,b)===!1)break;return this},c.fold=function(a,b){return this.each(function(c){a=b.call(this,a,c)}),a},c.latex=function(){return this.fold("",function(a,b){return a+b.latex()})},c.blockify=function(){var a=this,b=a.prev,c=a.next,d=a.parent,e=new i,f=e.firstChild=b.next||d.firstChild,g=e.lastChild=c.prev||d.lastChild;return b?b.next=c:d.firstChild=c,c?c.prev=b:d.lastChild=b,f.prev=a.prev=0,g.next=a.next=0,a.parent=e,a.each(function(a){a.parent=e}),e.jQ=a.jQ,e},c=m.prototype=new i,c.latex=function(){return i.prototype.latex.call(this).replace(/(\\[a-z]+) (?![a-z])/ig,"$1")},c.text=function(){return this.foldChildren("",function(a,b){return a+b.text()})},c.renderLatex=function(a){this.jQ.children().slice(1).remove(),this.firstChild=this.lastChild=0,this.cursor.appendTo(this).writeLatex(a),this.blur()},c.keydown=function(a){this.skipTextInput=!0,a.ctrlKey=a.ctrlKey||a.metaKey;switch(a.originalEvent&&a.originalEvent.keyIdentifier||a.which){case 8:case"Backspace":case"U+0008":if(a.ctrlKey)while(this.cursor.prev||this.cursor.selection)this.cursor.backspace();else this.cursor.backspace();break;case 27:case"Esc":case"U+001B":case 9:case"Tab":case"U+0009":if(a.ctrlKey)break;var b=this.cursor.parent;if(a.shiftKey){if(b===this)break;b.prev?this.cursor.appendTo(b.prev):this.cursor.insertBefore(b.parent)}else{if(b===this)return this.skipTextInput=!0;b.next?this.cursor.prependTo(b.next):this.cursor.insertAfter(b.parent)}return this.cursor.clearSelection(),!1;case 13:case"Enter":a.preventDefault();break;case 35:case"End":if(a.shiftKey)while(this.cursor.next||a.ctrlKey&&this.cursor.parent!==this)this.cursor.selectRight();else this.cursor.clearSelection().appendTo(a.ctrlKey?this:this.cursor.parent);return a.preventDefault(),!1;case 36:case"Home":if(a.shiftKey)while(this.cursor.prev||a.ctrlKey&&this.cursor.parent!==this)this.cursor.selectLeft();else this.cursor.clearSelection().prependTo(a.ctrlKey?this:this.cursor.parent);return a.preventDefault(),!1;case 37:case"Left":if(a.ctrlKey)break;return a.shiftKey?this.cursor.selectLeft():this.cursor.moveLeft(),a.preventDefault(),!1;case 38:case"Up":if(a.ctrlKey)break;if(a.shiftKey)if(this.cursor.prev)while(this.cursor.prev)this.cursor.selectLeft();else this.cursor.selectLeft();else this.cursor.parent.prev?this.cursor.clearSelection().appendTo(this.cursor.parent.prev):this.cursor.prev?this.cursor.clearSelection().prependTo(this.cursor.parent):this.cursor.parent!==this&&this.cursor.clearSelection().insertBefore(this.cursor.parent.parent);return a.preventDefault(),!1;case 39:case"Right":if(a.ctrlKey)break;return a.shiftKey?this.cursor.selectRight():this.cursor.moveRight(),a.preventDefault(),!1;case 40:case"Down":if(a.ctrlKey)break;if(a.shiftKey)if(this.cursor.next)while(this.cursor.next)this.cursor.selectRight();else this.cursor.selectRight();else this.cursor.parent.next?this.cursor.clearSelection().prependTo(this.cursor.parent.next):this.cursor.next?this.cursor.clearSelection().appendTo(this.cursor.parent):this.cursor.parent!==this&&this.cursor.clearSelection().insertAfter(this.cursor.parent.parent);return a.preventDefault(),!1;case 46:case"Del":case"U+007F":if(a.ctrlKey)while(this.cursor.next||this.cursor.selection)this.cursor.deleteForward();else this.cursor.deleteForward();break;case 65:case"A":case"U+0041":if(a.ctrlKey&&!a.shiftKey&&!a.altKey){if(this!==this.cursor.root)return this.parent.keydown(a);this.cursor.clearSelection().appendTo(this);while(this.cursor.prev)this.cursor.selectLeft();return a.preventDefault(),!1}this.skipTextInput=!1;break;case 67:case"C":case"U+0043":if(a.ctrlKey&&!a.shiftKey&&!a.altKey){if(this!==this.cursor.root)return this.parent.keydown(a);if(!this.cursor.selection)return!0}else this.skipTextInput=!1;break;case 86:case"V":case"U+0056":if(a.ctrlKey&&!a.shiftKey&&!a.altKey){if(this!==this.cursor.root)return this.parent.keydown(a);var c=this;setTimeout(function(){c.cursor.writeLatex(c.cursor.root.textarea.children().val()),c.cursor.clearSelection()})}else this.skipTextInput=!1;break;case 88:case"X":case"U+0058":if(a.ctrlKey&&!a.shiftKey&&!a.altKey){if(this!==this.cursor.root)return this.parent.keydown(a);if(!this.cursor.selection)return!0;this.cursor.deleteSelection()}else this.skipTextInput=!1;break;default:this.skipTextInput=!1}return!0},c.textInput=function(a){this.skipTextInput||this.cursor.write(a)},c=n.prototype=new g,c.html_template=['<span class="mathquill-rendered-math"></span>'],c.initBlocks=function(){this.firstChild=this.lastChild=this.jQ.data(e).block=new m,this.firstChild.parent=this,this.firstChild.jQ=this.jQ},c=o.prototype=new i,c.renderLatex=function(a){var b=this,c=b.cursor;b.jQ.children().slice(1).remove(),b.firstChild=b.lastChild=0,c.show().appendTo(b),a=a.match(/(?:\\\$|[^$])+|\$(?:\\\$|[^$])*\$|\$(?:\\\$|[^$])*$/g)||"";for(var d=0;d<a.length;d+=1){var e=a[d];if(e[0]==="$"){e[-1+e.length]==="$"&&e[-2+e.length]!=="\\"?e=e.slice(1,-1):e=e.slice(1);var f=new n(c);c.insertNew(f),f.firstChild.renderLatex(e),c.show().insertAfter(f)}else for(var g=0;g<e.length;g+=1)this.cursor.insertNew(new K(e[g]))}},c.keydown=m.prototype.keydown,c.textInput=function(a){if(this.skipTextInput)return;this.cursor.deleteSelection(),a==="$"?this.cursor.insertNew(new n(this.cursor)):this.cursor.insertNew(new K(a))};var p={},q={};c=s.prototype=new g,c.latex=function(){var a=this.firstChild.latex();return a.length===1?this.cmd+a:this.cmd+"{"+(a||" ")+"}"},c.redraw=function(){this.respace(),this.next&&this.next.respace(),this.prev&&this.prev.respace()},c.respace=function(){return this.prev.cmd==="\\int "||this.prev instanceof s&&this.prev.cmd!=this.cmd&&this.prev.prev&&this.prev.prev.cmd==="\\int "?this.limit||(this.limit=!0,this.jQ.addClass("limit")):this.limit&&(this.limit=!1,this.jQ.removeClass("limit")),(this.respaced=this.prev instanceof s&&this.prev.cmd!=this.cmd&&!this.prev.respaced)?this.limit&&this.cmd==="_"?this.jQ.css({left:-0.25-this.prev.jQ.outerWidth()/+this.jQ.css("fontSize").slice(0,-2)+"em",marginRight:.1-Math.min(this.jQ.outerWidth(),this.prev.jQ.outerWidth())/+this.jQ.css("fontSize").slice(0,-2)+"em"}):this.jQ.css({left:-this.prev.jQ.outerWidth()/+this.jQ.css("fontSize").slice(0,-2)+"em",marginRight:.1-Math.min(this.jQ.outerWidth(),this.prev.jQ.outerWidth())/+this.jQ.css("fontSize").slice(0,-2)+"em"}):this.limit&&this.cmd==="_"?this.jQ.css({left:"-.25em",marginRight:""}):this.jQ.css({left:"",marginRight:""}),this},q.subscript=q._=r(s,function(a){s.call(this,"_","<sub></sub>","_",a)}),q.superscript=q.supscript=q["^"]=r(s,function(a){s.call(this,"^","<sup></sup>","**",a)}),c=t.prototype=new g,c.html_template=['<span class="fraction"></span>','<span class="numerator"></span>','<span class="denominator"></span>'],c.text_template=["(","/",")"],q.frac=q.fraction=t,c=u.prototype=new t,c.placeCursor=function(a){if(this.firstChild.isEmpty()){var b=this.prev;while(b&&!(b instanceof M||b instanceof C||b instanceof O))b=b.prev;b instanceof O&&b.next instanceof s&&(b=b.next,b.next instanceof s&&b.next.cmd!=b.cmd&&(b=b.next));if(b!==this.prev){var c=(new j(this.parent,b,this)).blockify();c.jQ=this.firstChild.jQ.empty().removeClass("empty").append(c.jQ).data(e,{block:c}),c.next=this.lastChild,c.parent=this,this.firstChild=this.lastChild.prev=c}}a.appendTo(this.lastChild)},p["/"]=u,c=v.prototype=new g,c.html_template=['<span><span class="sqrt-prefix">&radic;</span></span>','<span class="sqrt-stem"></span>'],c.text_template=["sqrt(",")"],c.redraw=function(){var a=this.lastChild.jQ,b=a.outerHeight(!0);a.css({borderTopWidth:b/28+1}).prev().css({fontSize:.9*b/+a.css("fontSize").slice(0,-2)+"em"})},c.optional_arg_command="nthroot",q.sqrt=q["√"]=v,c=w.prototype=new v,c.html_template=['<span><span class="sqrt-prefix">&radic;</span></span>','<sup class="nthroot"></sup>','<span class="sqrt-stem"></span>'],c.text_template=["sqrt[","](",")"],c.latex=function(){return"\\sqrt["+this.firstChild.latex()+"]{"+this.lastChild.latex()+"}"},q.nthroot=w,c=x.prototype=new g,c.initBlocks=function(a){this.firstChild=this.lastChild=a&&a.blockify()||new i,this.firstChild.parent=this,this.firstChild.jQ=this.jQ.children(":eq(1)").data(e,{block:this.firstChild}).append(this.firstChild.jQ)},c.latex=function(){return this.cmd+this.firstChild.latex()+this.end},c.redraw=function(){var a=this.firstChild.jQ;a.prev().add(a.next()).css("fontSize",a.outerHeight()/(+a.css("fontSize").slice(0,-2)*1.02)+"em")},q.lbrace=p["{"]=r(x,function(a){x.call(this,"{","}","\\{","\\}",a)}),q.langle=q.lang=r(x,function(a){x.call(this,"&lang;","&rang;","\\langle ","\\rangle ",a)}),q.lbrack=q.lbracket=p["["]=r(x,function(a){x.call(this,"[","]","\\[","\\]",a)}),c=y.prototype=new x,c.placeCursor=function(a){!this.next&&this.parent.parent&&this.parent.parent.end===this.end&&this.firstChild.isEmpty()?a.backspace().insertAfter(this.parent.parent):this.firstChild.blur()},q.rbrace=p["}"]=r(y,function(a){y.call(this,"{","}","\\{","\\}",a)}),q.rangle=q.rang=r(y,function(a){y.call(this,"&lang;","&rang;","\\langle ","\\rangle ",a)}),q.rbrack=q.rbracket=p["]"]=r(y,function(a){y.call(this,"[","]","\\[","\\]",a)}),z.prototype=x.prototype,q.lparen=p["("]=r(z,function(a){z.call(this,"(",")",a)}),A.prototype=y.prototype,q.rparen=p[")"]=r(A,function(a){A.call(this,"(",")",a)}),c=B.prototype=new z,c.placeCursor=function(a){!this.next&&this.parent.parent&&this.parent.parent.end===this.end&&this.firstChild.isEmpty()?a.backspace().insertAfter(this.parent.parent):a.appendTo(this.firstChild)},q.lpipe=q.rpipe=p["|"]=B,c=C.prototype=new g,c.html_template=['<span class="text"></span>'],c.text_template=['"','"'],c.initBlocks=function(){this.firstChild=this.lastChild=this.jQ.data(e).block=new D,this.firstChild.parent=this,this.firstChild.jQ=this.jQ.append(this.firstChild.jQ)},c.placeCursor=function(a){(this.cursor=a).appendTo(this.firstChild);if(this.replacedText)for(var b=0;b<this.replacedText.length;b+=1)this.write(this.replacedText.charAt(b))},c.write=function(a){this.cursor.insertNew(new K(a))},c.keydown=function(a){return!this.cursor.selection&&(a.which===8&&!this.cursor.prev||a.which===46&&!this.cursor.next)?(this.isEmpty()&&this.cursor.insertAfter(this),!1):this.parent.keydown(a)},c.textInput=function(a){this.cursor.deleteSelection();if(a!=="$")this.write(a);else if(this.isEmpty())this.cursor.insertAfter(this).backspace().insertNew(new K("\\$","$"));else if(!this.cursor.next)this.cursor.insertAfter(this);else if(!this.cursor.prev)this.cursor.insertBefore(this);else{var b=new C(new j(this.firstChild,this.cursor.prev));b.placeCursor=function(a){this.prev=0,delete this.placeCursor,this.placeCursor(a)},b.firstChild.focus=function(){return this},this.cursor.insertAfter(this).insertNew(b),b.prev=this,this.cursor.insertBefore(b),delete b.firstChild.focus}},c=D.prototype=new i,c.blur=function(){this.jQ.removeClass("hasCursor");if(this.isEmpty()){var a=this.parent,b=a.cursor;b.parent===this?this.jQ.addClass("empty"):(b.hide(),a.remove(),b.next===a?b.next=a.next:b.prev===a&&(b.prev=a.prev),b.show().redraw())}return this},c.focus=function(){i.prototype.focus.call(this);var a=this.parent;if(a.next instanceof C){var b=this,c=a.cursor,d=a.next.firstChild;d.eachChild(function(a){a.parent=b,a.jQ.appendTo(b.jQ)}),this.lastChild?this.lastChild.next=d.firstChild:this.firstChild=d.firstChild,d.firstChild.prev=this.lastChild,this.lastChild=d.lastChild,d.parent.remove(),c.prev?c.insertAfter(c.prev):c.prependTo(this),c.redraw()}else if(a.prev instanceof C){var c=a.cursor;c.prev?a.prev.firstChild.focus():c.appendTo(a.prev.firstChild)}return this},q.text=p.$=C,c=E.prototype=new g,c.html_template=['<span class="latex-command-input"></span>'],c.text_template=["\\"],c.placeCursor=function(a){this.cursor=a.appendTo(this.firstChild),this.replacedFragment&&(this.jQ=this.jQ.add(this.replacedFragment.jQ.addClass("blur").bind("mousedown mousemove",function(a){return b(a.target=this.nextSibling).trigger(a),!1}).insertBefore(this.jQ)))},c.latex=function(){return"\\"+this.firstChild.latex()+" "},c.keydown=function(a){return a.which===9||a.which===13?(this.renderCommand(),!1):this.parent.keydown(a)},c.textInput=function(a){if(a.match(/[a-z]/i)){this.cursor.deleteSelection(),this.cursor.insertNew(new K(a));return}this.renderCommand();if(a===" "||a==="\\"&&this.firstChild.isEmpty())return;this.cursor.parent.textInput(a)},c.renderCommand=function(){this.jQ=this.jQ.last(),this.remove(),this.next?this.cursor.insertBefore(this.next):this.cursor.appendTo(this.parent);var a=this.firstChild.latex(),b;if(a)if(b=q[a])b=new b(this.replacedFragment,a);else{b=new C(a),b.firstChild.focus=function(){return delete this.focus,this},this.cursor.insertNew(b).insertAfter(b),this.replacedFragment&&this.replacedFragment.remove();return}else b=new K("\\backslash ","\\");this.cursor.insertNew(b),b instanceof h&&this.replacedFragment&&this.replacedFragment.remove()},p["\\"]=E,c=F.prototype=new g,c.html_template=["<span></span>","<span></span>","<span></span>"],c.text_template=["choose(",",",")"],c.redraw=function(){this.jQ.children(":first").add(this.jQ.children(":last")).css("fontSize",this.jQ.outerHeight()/(+this.jQ.css("fontSize").slice(0,-2)*.9+2)+"em")},q.binom=q.binomial=F,c=G.prototype=new F,c.placeCursor=u.prototype.placeCursor,q.choose=G,c=H.prototype=new g,c.html_template=['<span class="array"></span>',"<span></span>"],c.latex=function(){return"\\begin{matrix}"+this.foldChildren([],function(a,b){return a.push(b.latex()),a}).join("\\\\")+"\\end{matrix}"},c.text=function(){return"["+this.foldChildren([],function(a,b){return text.push(b.text()),text}).join()+"]"},c.placeCursor=function(a){this.cursor=a.appendTo(this.firstChild)},c.keydown=function(a){var c=this.cursor.parent;if(c.parent===this){if(a.which===13){var d=new i;return d.parent=this,d.jQ=b("<span></span>").data(e,{block:d}).insertAfter(c.jQ),c.next?c.next.prev=d:this.lastChild=d,d.next=c.next,c.next=d,d.prev=c,this.cursor.appendTo(d).redraw(),!1}if(a.which===9&&!a.shiftKey&&!c.next){if(c.isEmpty())return c.prev?(this.cursor.insertAfter(this),delete c.prev.next,this.lastChild=c.prev,c.jQ.remove(),this.cursor.redraw(),!1):this.parent.keydown(a);var d=new i;return d.parent=this,d.jQ=b("<span></span>").data(e,{block:d}).appendTo(this.jQ),this.lastChild=d,c.next=d,d.prev=c,this.cursor.appendTo(d).redraw(),!1}if(a.which===8){if(c.isEmpty())return c.prev?(this.cursor.appendTo(c.prev),c.prev.next=c.next):(this.cursor.insertBefore(this),this.firstChild=c.next),c.next?c.next.prev=c.prev:this.lastChild=c.prev,c.jQ.remove(),this.isEmpty()?this.cursor.deleteForward():this.cursor.redraw(),!1;if(!this.cursor.prev)return!1}}return this.parent.keydown(a)},q.vector=H,q.editable=r(n,function(){g.call(this,"\\editable"),k(this.jQ,this.firstChild,!1,!0);var a;this.placeCursor=function(b){a=b.appendTo(this.firstChild)},this.firstChild.blur=function(){if(a.prev!==this.parent)return;delete this.blur,this.cursor.appendTo(this),i.prototype.blur.call(this)},this.text=function(){return this.firstChild.text()}}),q.f=I(h,"f",'<var class="florin">&fnof;</var>'),c=J.prototype=new h,c.text=function(){var a=this.cmd;return this.prev&&!(this.prev instanceof J)&&!(this.prev instanceof M)&&(a="*"+a),this.next&&!(this.next instanceof M)&&this.next.cmd!=="^"&&(a+="*"),a},K.prototype=h.prototype,q[":"]=p[" "]=I(K,"\\:"," "),q.prime=p["'"]=I(K,"'","&prime;"),L.prototype=h.prototype,q["@"]=L,q["&"]=I(L,"\\&","&"),q["%"]=I(L,"\\%","%"),q.alpha=q.beta=q.gamma=q.delta=q.zeta=q.eta=q.theta=q.iota=q.kappa=q.mu=q.nu=q.xi=q.rho=q.sigma=q.tau=q.chi=q.psi=q.omega=r(h,function(a,b){J.call(this,"\\"+b+" ","&"+b+";")}),q.phi=I(J,"\\phi ","&#981;"),q.phiv=q.varphi=I(J,"\\varphi ","&phi;"),q.epsilon=I(J,"\\epsilon ","&#1013;"),q.epsiv=q.varepsilon=I(J,"\\varepsilon ","&epsilon;"),q.sigmaf=q.sigmav=q.varsigma=I(J,"\\varsigma ","&sigmaf;"),q.upsilon=q.upsi=I(J,"\\upsilon ","&upsilon;"),q.gammad=q.Gammad=q.digamma=I(J,"\\digamma ","&#989;"),q.kappav=q.varkappa=I(J,"\\varkappa ","&#1008;"),q.piv=q.varpi=I(J,"\\varpi ","&#982;"),q.rhov=q.varrho=I(J,"\\varrho ","&#1009;"),q.thetav=q.vartheta=I(J,"\\vartheta ","&#977;"),q.pi=q["π"]=I(L,"\\pi ","&pi;"),q.lambda=I(L,"\\lambda ","&lambda;"),q.Upsilon=q.Upsi=I(J,"\\Upsilon ","&Upsilon;"),q.Gamma=q.Delta=q.Theta=q.Lambda=q.Xi=q.Pi=q.Sigma=q.Phi=q.Psi=q.Omega=q.forall=r(h,function(a,b){K.call(this,"\\"+b+" ","&"+b+";")}),M.prototype=new h,c=N.prototype=new M,c.respace=function(){return this.prev?this.prev instanceof M&&this.next&&!(this.next instanceof M)?this.jQ[0].className="unary-operator":this.jQ[0].className="binary-operator":this.jQ[0].className="",this},q["+"]=I(N,"+"),q["-"]=I(N,"-","&minus;"),q.pm=q.plusmn=q.plusminus=I(N,"\\pm ","&plusmn;"),q.mp=q.mnplus=q.minusplus=I(N,"\\mp ","&#8723;"),p["*"]=q.sdot=q.cdot=I(M,"\\cdot ","&middot;"),q["="]=I(M,"=","="),q["<"]=I(M,"<","&lt;"),q[">"]=I(M,">","&gt;"),q.notin=q.sim=q.cong=q.equiv=q.oplus=q.otimes=r(M,function(a,b){M.call(this,"\\"+b+" ","&"+b+";")}),q.times=r(M,function(a,b){M.call(this,"\\times ","&times;","[x]")}),q.div=q.divide=q.divides=I(M,"\\div ","&divide;","[/]"),q.ne=q.neq=I(M,"\\ne ","&ne;"),q.ast=q.star=q.loast=q.lowast=I(M,"\\ast ","&lowast;"),q.therefor=q.therefore=I(M,"\\therefore ","&there4;"),q.cuz=q.because=I(M,"\\because ","&#8757;"),q.prop=q.propto=I(M,"\\propto ","&prop;"),q.asymp=q.approx=I(M,"\\approx ","&asymp;"),q.lt=I(M,"<","&lt;"),q.gt=I(M,">","&gt;"),q.le=q.leq=I(M,"\\le ","&le;"),q.ge=q.geq=I(M,"\\ge ","&ge;"),q.isin=q["in"]=I(M,"\\in ","&isin;"),q.ni=q.contains=I(M,"\\ni ","&ni;"),q.notni=q.niton=q.notcontains=q.doesnotcontain=I(M,"\\not\\ni ","&#8716;"),q.sub=q.subset=I(M,"\\subset ","&sub;"),q.sup=q.supset=q.superset=I(M,"\\supset ","&sup;"),q.nsub=q.notsub=q.nsubset=q.notsubset=I(M,"\\not\\subset ","&#8836;"),q.nsup=q.notsup=q.nsupset=q.notsupset=q.nsuperset=q.notsuperset=I(M,"\\not\\supset ","&#8837;"),q.sube=q.subeq=q.subsete=q.subseteq=I(M,"\\subseteq ","&sube;"),q.supe=q.supeq=q.supsete=q.supseteq=q.supersete=q.superseteq=I(M,"\\supseteq ","&supe;"),q.nsube=q.nsubeq=q.notsube=q.notsubeq=q.nsubsete=q.nsubseteq=q.notsubsete=q.notsubseteq=I(M,"\\not\\subseteq ","&#8840;"),q.nsupe=q.nsupeq=q.notsupe=q.notsupeq=q.nsupsete=q.nsupseteq=q.notsupsete=q.notsupseteq=q.nsupersete=q.nsuperseteq=q.notsupersete=q.notsuperseteq=I(M,"\\not\\supseteq ","&#8841;"),O.prototype=new h,q.sum=q.summation=I(O,"\\sum ","&sum;"),q.prod=q.product=I(O,"\\prod ","&prod;"),q.coprod=q.coproduct=I(O,"\\coprod ","&#8720;"),q.int=q.integral=q["∫"]=I(O,"\\int ","&int;"),q.N=q.naturals=q.Naturals=I(K,"\\mathbb{N}","&#8469;"),q.P=q.primes=q.Primes=q.projective=q.Projective=q.probability=q.Probability=I(K,"\\mathbb{P}","&#8473;"),q.Z=q.integers=q.Integers=I(K,"\\mathbb{Z}","&#8484;"),q.Q=q.rationals=q.Rationals=I(K,"\\mathbb{Q}","&#8474;"),q.R=q.reals=q.Reals=I(K,"\\mathbb{R}","&#8477;"),q.C=q.complex=q.Complex=q.complexes=q.Complexes=q.complexplane=q.Complexplane=q.ComplexPlane=I(K,"\\mathbb{C}","&#8450;"),q.H=q.Hamiltonian=q.quaternions=q.Quaternions=I(K,"\\mathbb{H}","&#8461;"),q.quad=q.emsp=I(K,"\\quad ","    "),q.qquad=I(K,"\\qquad ","        "),q.diamond=I(K,"\\diamond","&#9671;"),q.bigtriangleup=I(K,"\\bigtriangleup","&#9651;"),q.ominus=I(K,"\\ominus","&#8854;"),q.uplus=I(K,"\\uplus","&#8846;"),q.bigtriangledown=I(K,"\\bigtriangledown","&#9661;"),q.sqcap=I(K,"\\sqcap","&#8851;"),q.triangleleft=I(K,"\\triangleleft","&#8882;"),q.sqcup=I(K,"\\sqcup","&#8852;"),q.triangleright=I(K,"\\triangleright","&#8883;"),q.odot=I(K,"\\odot","&#8857;"),q.bigcirc=I(K,"\\bigcirc","&#9711;"),q.dagger=I(K,"\\dagger","&#0134;"),q.ddagger=I(K,"\\ddagger","&#135;"),q.wr=I(K,"\\wr","&#8768;"),q.amalg=I(K,"\\amalg","&#8720;"),q.models=I(K,"\\models","&#8872;"),q.prec=I(K,"\\prec","&#8826;"),q.succ=I(K,"\\succ","&#8827;"),q.preceq=I(K,"\\preceq","&#8828;"),q.succeq=I(K,"\\succeq","&#8829;"),q.simeq=I(K,"\\simeq","&#8771;"),q.mid=I(K,"\\mid","&#8739;"),q.ll=I(K,"\\ll","&#8810;"),q.gg=I(K,"\\gg","&#8811;"),q.parallel=I(K,"\\parallel","&#8741;"),q.bowtie=I(K,"\\bowtie","&#8904;"),q.sqsubset=I(K,"\\sqsubset","&#8847;"),q.sqsupset=I(K,"\\sqsupset","&#8848;"),q.smile=I(K,"\\smile","&#8995;"),q.sqsubseteq=I(K,"\\sqsubseteq","&#8849;"),q.sqsupseteq=I(K,"\\sqsupseteq","&#8850;"),q.doteq=I(K,"\\doteq","&#8784;"),q.frown=I(K,"\\frown","&#8994;"),q.vdash=I(K,"\\vdash","&#8870;"),q.dashv=I(K,"\\dashv","&#8867;"),q.longleftarrow=I(K,"\\longleftarrow","&#8592;"),q.longrightarrow=I(K,"\\longrightarrow","&#8594;"),q.Longleftarrow=I(K,"\\Longleftarrow","&#8656;"),q.Longrightarrow=I(K,"\\Longrightarrow","&#8658;"),q.longleftrightarrow=I(K,"\\longleftrightarrow","&#8596;"),q.updownarrow=I(K,"\\updownarrow","&#8597;"),q.Longleftrightarrow=I(K,"\\Longleftrightarrow","&#8660;"),q.Updownarrow=I(K,"\\Updownarrow","&#8661;"),q.mapsto=I(K,"\\mapsto","&#8614;"),q.nearrow=I(K,"\\nearrow","&#8599;"),q.hookleftarrow=I(K,"\\hookleftarrow","&#8617;"),q.hookrightarrow=I(K,"\\hookrightarrow","&#8618;"),q.searrow=I(K,"\\searrow","&#8600;"),q.leftharpoonup=I(K,"\\leftharpoonup","&#8636;"),q.rightharpoonup=I(K,"\\rightharpoonup","&#8640;"),q.swarrow=I(K,"\\swarrow","&#8601;"),q.leftharpoondown=I(K,"\\leftharpoondown","&#8637;"),q.rightharpoondown=I(K,"\\rightharpoondown","&#8641;"),q.nwarrow=I(K,"\\nwarrow","&#8598;"),q.ldots=I(K,"\\ldots","&#8230;"),q.cdots=I(K,"\\cdots","&#8943;"),q.vdots=I(K,"\\vdots","&#8942;"),q.ddots=I(K,"\\ddots","&#8944;"),q.surd=I(K,"\\surd","&#8730;"),q.triangle=I(K,"\\triangle","&#9653;"),q.ell=I(K,"\\ell","&#8467;"),q.top=I(K,"\\top","&#8868;"),q.flat=I(K,"\\flat","&#9837;"),q.natural=I(K,"\\natural","&#9838;"),q.sharp=I(K,"\\sharp","&#9839;"),q.wp=I(K,"\\wp","&#8472;"),q.bot=I(K,"\\bot","&#8869;"),q.clubsuit=I(K,"\\clubsuit","&#9827;"),q.diamondsuit=I(K,"\\diamondsuit","&#9826;"),q.heartsuit=I(K,"\\heartsuit","&#9825;"),q.spadesuit=I(K,"\\spadesuit","&#9824;"),q.oint=I(K,"\\oint","&#8750;"),q.bigcap=I(K,"\\bigcap","&#8745;"),q.bigcup=I(K,"\\bigcup","&#8746;"),q.bigsqcup=I(K,"\\bigsqcup","&#8852;"),q.bigvee=I(K,"\\bigvee","&#8744;"),q.bigwedge=I(K,"\\bigwedge","&#8743;"),q.bigodot=I(K,"\\bigodot","&#8857;"),q.bigotimes=I(K,"\\bigotimes","&#8855;"),q.bigoplus=I(K,"\\bigoplus","&#8853;"),q.biguplus=I(K,"\\biguplus","&#8846;"),q.lfloor=I(K,"\\lfloor","&#8970;"),q.rfloor=I(K,"\\rfloor","&#8971;"),q.lceil=I(K,"\\lceil","&#8968;"),q.rceil=I(K,"\\rceil","&#8969;"),q.slash=I(K,"\\slash","&#47;"),q.opencurlybrace=I(K,"\\opencurlybrace","&#123;"),q.closecurlybrace=I(K,"\\closecurlybrace","&#125;"),q.caret=I(K,"\\caret ","^"),q.underscore=I(K,"\\underscore ","_"),q.backslash=I(K,"\\backslash ","\\"),q.vert=I(K,"|"),q.perp=q.perpendicular=I(K,"\\perp ","&perp;"),q.nabla=q.del=I(K,"\\nabla ","&nabla;"),q.hbar=I(K,"\\hbar ","&#8463;"),q.AA=q.Angstrom=q.angstrom=I(K,"\\text\\AA ","&#8491;"),q.ring=q.circ=q.circle=I(K,"\\circ ","&#8728;"),q.bull=q.bullet=I(K,"\\bullet ","&bull;"),q.setminus=q.smallsetminus=I(K,"\\setminus ","&#8726;"),q.not=q.neg=I(K,"\\neg ","&not;"),q.dots=q.ellip=q.hellip=q.ellipsis=q.hellipsis=I(K,"\\dots ","&hellip;"),q.converges=q.darr=q.dnarr=q.dnarrow=q.downarrow=I(K,"\\downarrow ","&darr;"),q.dArr=q.dnArr=q.dnArrow=q.Downarrow=I(K,"\\Downarrow ","&dArr;"),q.diverges=q.uarr=q.uparrow=I(K,"\\uparrow ","&uarr;"),q.uArr=q.Uparrow=I(K,"\\Uparrow ","&uArr;"),q.to=I(M,"\\to ","&rarr;"),q.rarr=q.rightarrow=I(K,"\\rightarrow ","&rarr;"),q.implies=I(M,"\\Rightarrow ","&rArr;"),q.rArr=q.Rightarrow=I(K,"\\Rightarrow ","&rArr;"),q.gets=I(M,"\\gets ","&larr;"),q.larr=q.leftarrow=I(K,"\\leftarrow ","&larr;"),q.impliedby=I(M,"\\Leftarrow ","&lArr;"),q.lArr=q.Leftarrow=I(K,"\\Leftarrow ","&lArr;"),q.harr=q.lrarr=q.leftrightarrow=I(K,"\\leftrightarrow ","&harr;"),q.iff=I(M,"\\Leftrightarrow ","&hArr;"),q.hArr=q.lrArr=q.Leftrightarrow=I(K,"\\Leftrightarrow ","&hArr;"),q.Re=q.Real=q.real=I(K,"\\Re ","&real;"),q.Im=q.imag=q.image=q.imagin=q.imaginary=q.Imaginary=I(K,"\\Im ","&image;"),q.part=q.partial=I(K,"\\partial ","&part;"),q.inf=q.infin=q.infty=q.infinity=I(K,"\\infty ","&infin;"),q.alef=q.alefsym=q.aleph=q.alephsym=I(K,"\\aleph ","&alefsym;"),q.xist=q.xists=q.exist=q.exists=I(K,"\\exists ","&exist;"),q.and=q.land=q.wedge=I(K,"\\wedge ","&and;"),q.or=q.lor=q.vee=I(K,"\\vee ","&or;"),q.o=q.O=q.empty=q.emptyset=q.oslash=q.Oslash=q.nothing=q.varnothing=I(M,"\\varnothing ","&empty;"),q.cup=q.union=I(K,"\\cup ","&cup;"),q.cap=q.intersect=q.intersection=I(K,"\\cap ","&cap;"),q.deg=q.degree=I(K,"^\\circ ","&deg;"),q.ang=q.angle=I(K,"\\angle ","&ang;"),c=P.prototype=new h,c.respace=function(){this.jQ[0].className=this.next instanceof s||this.next instanceof x?"":"non-italicized-function"},q.ln=q.lg=q.log=q.span=q.proj=q.det=q.dim=q.min=q.max=q.mod=q.lcm=q.gcd=q.gcf=q.hcf=q.lim=P,function(){var a=["sin","cos","tan","sec","cosec","csc","cotan","cot"];for(var b in a)q[a[b]]=q[a[b]+"h"]=q["a"+a[b]]=q["arc"+a[b]]=q["a"+a[b]+"h"]=q["arc"+a[b]+"h"]=P}(),c=Q.prototype,c.prev=0,c.next=0,c.parent=0,c.show=function(){return this.jQ=this._jQ.removeClass("blink"),"intervalId"in this?clearInterval(this.intervalId):(this.next?this.selection&&this.selection.prev===this.prev?this.jQ.insertBefore(this.selection.jQ):this.jQ.insertBefore(this.next.jQ.first()):this.jQ.appendTo(this.parent.jQ),this.parent.focus()),this.intervalId=setInterval(this.blink,500),this},c.hide=function(){return"intervalId"in this&&clearInterval(this.intervalId),delete this.intervalId,this.jQ.detach(),this.jQ=b(),this},c.redraw=function(){for(var a=this.parent;a;a=a.parent)a.redraw&&a.redraw()},c.insertAt=function(a,b,c){var d=this.parent;this.parent=a,this.next=b,this.prev=c,d.blur()},c.insertBefore=function(a){return this.insertAt(a.parent,a,a.prev),this.parent.jQ.addClass("hasCursor"),this.jQ.insertBefore(a.jQ.first()),this},c.insertAfter=function(a){return this.insertAt(a.parent,a.next,a),this.parent.jQ.addClass("hasCursor"),this.jQ.insertAfter(a.jQ.last()),this},c.prependTo=function(a){return this.insertAt(a,a.firstChild,0),a.textarea?this.jQ.insertAfter(a.textarea):this.jQ.prependTo(a.jQ),a.focus(),this},c.appendTo=function(a){return this.insertAt(a,0,a.lastChild),this.jQ.appendTo(a.jQ),a.focus(),this},c.hopLeft=function(){return this.jQ.insertBefore(this.prev.jQ.first()),this.next=this.prev,this.prev=this.prev.prev,this},c.hopRight=function(){return this.jQ.insertAfter(this.next.jQ.last()),this.prev=this.next,this.next=this.next.next,this},c.moveLeft=function(){return this.selection?this.insertBefore(this.selection.prev.next||this.parent.firstChild).clearSelection():this.prev?this.prev.lastChild?this.appendTo(this.prev.lastChild):this.hopLeft():this.parent.prev?this.appendTo(this.parent.prev):this.parent!==this.root&&this.insertBefore(this.parent.parent),this.show()},c.moveRight=function(){return this.selection?this.insertAfter(this.selection.next.prev||this.parent.lastChild).clearSelection():this.next?this.next.firstChild?this.prependTo(this.next.firstChild):this.hopRight():this.parent.next?this.prependTo(this.parent.next):this.parent!==this.root&&this.insertAfter(this.parent.parent),this.show()},c.seek=function(a,b,c){var d=this;if(a.hasClass("empty"))return d.clearSelection().prependTo(a.data(e).block),d;var f=a.data(e);if(f){if(f.cmd&&!f.block)return d.clearSelection(),a.outerWidth()>2*(b-a.offset().left)?d.insertBefore(f.cmd):d.insertAfter(f.cmd),d}else a=a.parent(),f=a.data(e),f||(f={block:d.root});d.clearSelection(),f.cmd?d.insertAfter(f.cmd):d.appendTo(f.block);var g=d.jQ.offset().left-b,h;do d.moveLeft(),h=g,g=d.jQ.offset().left-b;while(g>0&&(d.prev||d.parent!==d.root));return-g>h&&d.moveRight(),d},c.resolveNonItalicizedFunctions=function(){var a=this.prev,b=a?a.latex().replace(/ $/,""):null,c=0,d={ln:1,lg:1,log:1,span:1,proj:1,det:1,dim:1,min:1,max:1,mod:1,lcm:1,gcd:1,gcf:1,hcf:1,lim:1,sin:1,sinh:1,asin:1,arcsin:1,asinh:1,arcsinh:1,cos:1,cosh:1,acos:1,arccos:1,acosh:1,arccosh:1,tan:1,tanh:1,atan:1,arctan:1,atanh:1,arctanh:1,sec:1,sech:1,asec:1,arcsec:1,asech:1,arcsech:1,cosec:1,cosech:1,acosec:1,arccosec:1,acosech:1,arccosech:1,csc:1,csch:1,acsc:1,arccsc:1,acsch:1,arccsch:1,cotan:1,cotanh:1,acotan:1,arccotan:1,acotanh:1,arccotanh:1,cot:1,coth:1,acot:1,arccot:1,acoth:1,arccoth:1},e="";while(a&&b){var f=b.match(/^[a-z]$/);if(!(f||e&&b[0]=="\\"&&d[b.substring(1)]&&d[(b+e).substring(1)]))return;c++,e=b.replace(/\\/,"")+e,a=a.prev,b=a?a.latex().replace(/ $/,""):null;if(!f||(!a||!b.match(/^[a-z]$/))&&d[e]){for(var g=0;g<c;g++)this.selectLeft();this.writeLatex("\\"+e);return}}},c.writeLatex=function(a,c){return this.deleteSelection(),a=a&&a.match(/\\text\{([^{}]|\\\[{}])*\}|\\[\{\}\[\]]|[\(\)]|\\:|\\[a-z]*|[^\s]/ig)||0,function e(f){while(a.length){var g=a.shift();if(!g||g==="}"||g==="]")return;var h;if(g.slice(0,6)==="\\text{"){h=new C(g.slice(6,-1)),f.insertNew(h).insertAfter(h);continue}if(g==="|"){var i=f.prev&&f.prev.prev;while(i&&(i.cmd!="|"||!i.isEmpty()))i=i.prev;if(i){i.remove(),f.selectFrom(i.next),f.show().insertCh(g).insertAfter(f.parent.parent);continue}h=new K(g),f.insertNew(h)}else if(b.inArray(g,["\\lbrace","\\{","\\rbrace","\\}","\\langle","\\lang","\\rangle","\\rang","\\lparen","(","\\rparen",")","\\lbrack","\\lbracket","\\[","\\rbrack","\\rbracket","\\]","\\lpipe","\\rpipe"])<0)if(/^\\[a-z:]+$/i.test(g)){g=g.slice(1);var h=q[g];if(h)h=new h(d,g),a[0]==="["&&h.optional_arg_command&&(g=h.optional_arg_command,h=new q[g](d,g)),f.insertNew(h);else{h=new C(g),f.insertNew(h).insertAfter(h);continue}}else g.match(/[a-eg-zA-Z]/)?h=new J(g):(h=q[g])?h=new h:h=new K(g),f.insertNew(h);else{g=g.replace(/^\\/,""),f.insertCh(g),h=f.prev||f.parent.parent;if(f.prev)return;a.unshift("{")}h.eachChild(function(b){f.appendTo(b);var c=a.shift();if(!c)return!1;c==="{"||c==="["?e(f):f.insertCh(c)}),c||f.insertAfter(h)}}(this),this.hide()},c.write=function(a){var b=this.show().insertCh(a);return this.root.toolbar&&this.resolveNonItalicizedFunctions(),b},c.insertCh=function(a){this.selection&&(this.prev=this.selection.prev,this.next=this.selection.next);var b;return a.match(/^[a-eg-zA-Z]$/)?b=new J(a):(b=p[a]||q[a])?b=new b(this.selection,a):b=new K(a),this.selection&&(b instanceof h&&this.selection.remove(),delete this.selection),this.insertNew(b)},c.insertNew=function(a){return a.parent=this.parent,a.next=this.next,a.prev=this.prev,this.prev?this.prev.next=a:this.parent.firstChild=a,this.next?this.next.prev=a:this.parent.lastChild=a,a.jQ.insertBefore(this.jQ),a.respace(),this.next&&this.next.respace(),this.prev&&this.prev.respace(),this.prev=a,a.placeCursor(this),this.redraw(),this},c.unwrapGramp=function(){var a=this.parent.parent,b=a.parent,c=a.prev,d=this;a.eachChild(function(d){if(d.isEmpty())return;d.eachChild(function(c){c.parent=b,c.jQ.insertBefore(a.jQ)}),d.firstChild.prev=c,c?c.next=d.firstChild:b.firstChild=d.firstChild,c=d.lastChild}),c.next=a.next,a.next?a.next.prev=c:b.lastChild=c;if(!this.next)if(this.prev)this.next=this.prev.next;else while(!this.next){this.parent=this.parent.next;if(this.parent)this.next=this.parent.firstChild;else{this.next=a.next,this.parent=b;break}}this.next?this.insertBefore(this.next):this.appendTo(b),a.jQ.remove(),a.prev&&a.prev.respace(),a.next&&a.next.respace()},c.backspace=function(){if(!this.deleteSelection())if(this.prev)this.prev.isEmpty()?this.prev=this.prev.remove().prev:this.selectLeft();else if(this.parent!==this.root){if(this.parent.parent.isEmpty())return this.insertAfter(this.parent.parent).backspace();this.unwrapGramp()}return this.prev&&this.prev.respace(),this.next&&this.next.respace(),this.redraw(),this},c.deleteForward=function(){if(!this.deleteSelection())if(this.next)this.next.isEmpty()?this.next=this.next.remove().next:this.selectRight();else if(this.parent!==this.root){if(this.parent.parent.isEmpty())return this.insertBefore(this.parent.parent).deleteForward();this.unwrapGramp()}return this.prev&&this.prev.respace(),this.next&&this.next.respace(),this.redraw(),this},c.selectFrom=function(a){var b=this,c=a;d:for(;;){for(var e=this;e!==b.parent.parent;e=e.parent.parent)if(e.parent===c.parent){g=e,h=c;break d}for(var f=a;f!==c.parent.parent;f=f.parent.parent)if(b.parent===f.parent){g=b,h=f;break d}b.parent.parent&&(b=b.parent.parent),c.parent.parent&&(c=c.parent.parent)}var g,h,i;if(g.next!==h){for(var j=g;j;j=j.next)if(j===h.prev){i=!0;break}i||(i=h,h=g,g=i)}this.hide().selection=new R(g.parent,g.prev,h.next),this.insertAfter(h.next.prev||h.parent.lastChild),this.selectLatex()},c.selectLeft=function(){this.selection?this.selection.prev===this.prev?this.prev?(this.hopLeft().next.jQ.prependTo(this.selection.jQ),this.selection.prev=this.prev):this.parent!==this.root&&this.insertBefore(this.parent.parent).selection.levelUp():(this.prev.jQ.insertAfter(this.selection.jQ),this.hopLeft().selection.next=this.next,this.selection.prev===this.prev&&this.deleteSelection()):(this.prev?this.hopLeft():this.parent!==this.root&&this.insertBefore(this.parent.parent),this.hide().selection=new R(this.parent,this.prev,this.next.next)),this.selectLatex()},c.selectRight=function(){this.selection?this.selection.next===this.next?this.next?(this.hopRight().prev.jQ.appendTo(this.selection.jQ),this.selection.next=this.next):this.parent!==this.root&&this.insertAfter(this.parent.parent).selection.levelUp():(this.next.jQ.insertBefore(this.selection.jQ),this.hopRight().selection.prev=this.prev,this.selection.next===this.next&&this.deleteSelection()):(this.next?this.hopRight():this.parent!==this.root&&this.insertAfter(this.parent.parent),this.hide().selection=new R(this.parent,this.prev.prev,this.next)),this.selectLatex()},c.selectLatex=function(){var a=this.root.textarea.children(),b=this.selection?this.selection.latex():"";a.val(b);if(typeof a[0].selectionStart=="number")a[0].selectionStart=0,a[0].selectionEnd=b.length;else if(document.selection){var c=a[0].createTextRange();c.collapse(!0),c.moveStart("character",0),c.moveEnd("character",b.length),c.select()}},c.clearSelection=function(){return this.root.textarea.children().val(""),this.show().selection&&(this.selection.clear(),delete this.selection),this},c.deleteSelection=function(){return this.show().selection?(this.prev=this.selection.prev,this.next=this.selection.next,this.selection.remove(),delete this.selection,!0):!1},c=R.prototype=new j,c.jQinit=function(a){this.jQ=a.wrapAll('<span class="selection"></span>').parent()},c.levelUp=function(){return this.clear().jQinit(this.parent.parent.jQ),this.prev=this.parent.parent.prev,this.next=this.parent.parent.next,this.parent=this.parent.parent.parent,this},c.clear=function(){return this.jQ.replaceWith(this.jQ.children()),this},c.blockify=function(){return this.jQ.replaceWith(this.jQ=this.jQ.children()),j.prototype.blockify.call(this)},c.detach=function(){var a=j.prototype.blockify.call(this);return this.blockify=function(){return this.jQ.replaceWith(a.jQ=this.jQ=this.jQ.children()),a},this},b.fn.mathquill=function(a,c){switch(a){case"redraw":return this.find(":not(:has(:first))").data(e).cmd.redraw(),this;case"revert":return this.each(function(){var a=b(this).data(e);a&&a.revert&&a.revert()});case"latex":if(arguments.length>1)return this.each(function(){var a=b(this).data(e);a&&a.block&&a.block.renderLatex&&a.block.renderLatex(c)});var d=this.data(e);return d&&d.block&&d.block.latex();case"text":var d=this.data(e);return d&&d.block&&d.block.text();case"html":return this.html().replace(/<span class="?cursor( blink)?"?><\/span>/i,"").replace(/<span class="?textarea"?><textarea><\/textarea><\/span>/i,"");case"write":if(arguments.length>1)return this.each(function(){var a=b(this).data(e),d=a&&a.block,f=d&&d.cursor;f&&(f.writeLatex(c),d.blur())});default:var f=a==="textbox",g=a==="editor",h=g||f||a==="editable",i=f?o:m;return this.each(function(){k(b(this),new i,f,h,g)})}},b(function(){b(".mathquill-editable").mathquill("editable"),b(".mathquill-editor").mathquill("editor"),b(".mathquill-textbox").mathquill("textbox"),b(".mathquill-embedded-latex").mathquill()})})